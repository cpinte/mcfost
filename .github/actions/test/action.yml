name: "test"
description: "Test mcfost"

runs:
  using: "composite"
  steps:
    - name: cache reference data
      id: cache-deps
      uses: actions/cache@v3
      with:
        path: test_suite/test_data
        key: test-reference

    - name: run mcfost set up (downloads additional files)
      shell: bash
      working-directory: src
      env:
        MCFOST_UTILS: ${{ github.workspace }}/utils
      run: ./mcfost -setup

    - if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
      shell: bash
      name: download reference data for test suite
      working-directory: test_suite
      run: |
        wget http://136.186.108.129/test_data_dc5250a157a48a63fbea11f7822888130db64198.tar.gz
        rm -rf test_data
        tar xzf test_data_dc5250a157a48a63fbea11f7822888130db64198.tar.gz

    # Only do this if not in manylinux docker container
    - uses: actions/setup-python@v4
      if: env.AUDITWHEEL_PLAT == ''
      with:
        python-version: "3.11"

    - name: test current commit against reference data
      shell: bash
      run: |
        export MCFOST_UTILS=$PWD/utils
        export PATH=/opt/python/cp311-cp311/bin/:$PATH
        cd test_suite
        pip install -r requirements.txt
        python -m pytest -v
