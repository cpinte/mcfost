name: "linux"
description: "Build linux"

# Note: needs GCC > 12, and sudo, wherever you're building
# Using gcc-11 will return a bug when compiling gas/wavelengths_gas.f90

runs:
  using: "composite"
  steps:
    # Cache dependencies for mcfost to avoid downloading/installing them each time this workflow runs
    - name: cache dependencies
      id: cache-deps
      uses: john-shaffer/cache@main # Need this version to unpack the cache tar with sudo
      env:
        cache-name: cache-mcfost-dependencies
      with:
        path: |
          /home/runner/work/include
          /home/runner/work/lib
        key: ${{ runner.os }}-build-${{ env.cache-name }}

    # Only do this (lengthy) setup if dependency cache not found
    - name: prepare mcfost environment
      if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
      shell: bash
      run: |
        export MCFOST_INSTALL=$PWD
        cd lib/
        ./install.sh

    - name: compile mcfost
      shell: bash
      run: |
        export MCFOST_INSTALL=$PWD
        cd src/
        make all
