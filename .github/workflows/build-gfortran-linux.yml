# This is a basic workflow to help you get started with Actions

name: gfortran-linux

# Controls when the action will run.
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build-test:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    env:
      MCFOST_INSTALL: "/home/runner/work"
      MCFOST_NO_XGBOOST: "yes"
      SYSTEM: "gfortran"
      MCFOST_GIT: "1"
      MCFOST_UTILS: ${{ github.workspace }}/utils

    steps:
    - uses: actions/checkout@v2

    # Cache dependencies for mcfost to avoid downloading/installing them each time this workflow runs
    - name: cache dependencies
      id: cache-deps
      uses: john-shaffer/cache@main     # Need this version to unpack the cache tar with sudo
      env:
        cache-name: cache-mcfost-dependencies
      with:
        path: |
          /home/runner/work/include
          /home/runner/work/lib
          test_suite/test_data
        key: ${{ runner.os }}-build-${{ env.cache-name }}

    - name: update gcc to v12 # Using gcc-11 will return a bug when compiling gas/wavelengths_gas.f90
      run: |
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 12
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 12
        sudo update-alternatives --install /usr/bin/gfortran gfortran /usr/bin/gfortran-12 12
        sudo update-alternatives --config gcc

    # Only do this (lengthy) setup if dependency cache not found
    - if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
      name: install mcfost dependencies
      run: |
        cd lib
        ./install.sh
        cd ..

    - name: compile mcfost
      run: |
        cd src
        make all

    - name: run mcfost set up (downloads additional files)
      run: |
        cd src
        ./mcfost -setup
        cd ..

    - if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
      name: download reference data for test suite
      run: |
        cd test_suite
        wget http://136.186.108.129/test_data_dc5250a157a48a63fbea11f7822888130db64198.tar.gz
        rm -rf test_data
        tar xzf test_data_dc5250a157a48a63fbea11f7822888130db64198.tar.gz
        cd ..

    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: install pytest requirements
      run: python3 -m pip install -r test_suite/requirements.txt

    - name: test current commit against reference data
      run: |
        cd test_suite
        python3 -m pytest -v
