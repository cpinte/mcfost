module atmos_type

	use atom_type, only : AtomType, Element, ATOM_ID_WIDTH, AtomicLine, AtomicContinuum, AtomicTransition
	use uplow
	use getline!, only : getnextline
	use constant
	use messages
	use constantes, only : tiny_dp

	use healpix_mod !all at the moment

	!$ use omp_lib

  !MCFOST's originals
	use mcfost_env, only : mcfost_utils ! convert from the relative location of atomic data
                                      ! to mcfost's environnement folders.
	use parametres
	use utils, only : appel_syst, Gauss_Legendre_quadrature
	use fits_utils, only : print_error


	implicit none


  !!integer, parameter :: Nelem=99
	integer :: Nelem !set a reading abundance file now

  ! relative location in mcfost/utils/ specified by the mcfost environnement
  ! variables.
	character(len=50), parameter :: ABUNDANCE_FILE="./abundance.input"!"/Atoms/abundance.input"
	character(len=50), parameter :: KURUCZ_PF_FILE="/Atoms/pf_Kurucz.fits.gz"
  !path to your partition function data

  !Wrappers to create arrays of Pointers
!!-> move then to Atom_type.f90
	type atomPointerArray
		type(AtomType), pointer :: ptr_atom => NULL()
	end type atomPointerArray

  !Is this one really needed ? and why it doesn't work in solvene ?
	type elemPointerArray
		type(Element), pointer :: ptr_elem => NULL()
	end type elemPointerArray

	real(kind=dp), dimension(:,:), allocatable :: ds

	integer :: Npf, NactiveAtoms, Npassiveatoms, Natom
	real(kind=dp) :: metallicity, totalAbund, avgWeight, wght_per_H, tau, Taccretion
	real(kind=dp), allocatable, dimension(:) :: vR, v_z, vphi
	real(kind=dp), allocatable, dimension(:) :: BR, B_z, Bphi, vtheta, Btheta, gammab, chib, Bmag
	type (elemPointerArray), dimension(:), allocatable :: Elements
	type (atomPointerArray), dimension(:), allocatable :: Atoms, ActiveAtoms, PassiveAtoms
	real(kind=dp), dimension(:), allocatable :: nHtot, ne, Tpf, T, vturb
	real(kind=dp), dimension(:), allocatable :: nedag, nHmin !Hminus populations
	real(kind=dp) :: B_char = 0d0, v_char=0d0
           !B_char in Tesla and v_char in m/s, default 0T and 1km/s
	logical :: lMagnetized = .false., calc_ne, laccretion_shock

	real(kind=dp) :: thetai, thetao

	integer, allocatable, dimension(:) :: icompute_atomRT!
	real(kind=dp), dimension(:), allocatable :: xmu, wmu, xmux, xmuy
	!removed the depency in rays of some quantity (like phi_loc or I) since rate matrix
	!is built ray by ray, with is not the case for hogerheijde
    logical :: lmali_scheme, lhogerheijde_scheme !tmp
    character(len=50) :: angular_quadrature = "HEALpix"!"HEALpix"!"HEALpix_adapt"'carlson_A8_rh'!
	type (AtomType), pointer :: Hydrogen => NULL(), Helium => NULL()
	logical :: helium_is_active = .false.!avoid testing if helium is associated!


  contains


  subroutine compute_angular_integration_weights(Nmu,Nphi)
	integer, intent(in), optional :: Nmu, Nphi
	integer :: N1, N2, iray,iphi,imu, alloc_status, Nquad
	real(kind=dp) :: u0, v0, w0
	real, allocatable, dimension(:) :: colat, azim, wei
	real(kind=dp), allocatable, dimension(:) :: x1, x2, w1, w2
	!tests of the quadrature properties
	real(kind=dp) :: norm, integ1, integ2, integ3, integ, integ4, integ5, integ6


	select case (angular_quadrature)

	case ("HEALpix")

		N1 = healpix_npix(healpix_lorder)
		N2 = N1
		allocate(xmu(N1),wmu(N1),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmu and wmu")
		allocate(xmux(N2),xmuy(N2),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmux, xmuy")

		!phi (rad) x2
		allocate(x2(N1))

		call healpix_sphere(healpix_lorder,xmu,x2)

		xmux(:) = sqrt(1.0_dp - xmu(:)*xmu(:)) * cos(x2(:))
		xmuy(:) = sqrt(1.0_dp - xmu(:)*xmu(:)) * sin(x2(:))
		wmu(:)  = healpix_weight(healpix_lorder) !a constant actually

		write(*,"('HEALpix #'(1I8)' pixels, l='(1I2))") N1, healpix_lorder
		write(*,'(" -> Angular resolution "(1F12.3)" deg" )') healpix_angular_resolution(healpix_lorder)
! 		open(1, file="test_healpix",status="unknown")
! 		do iray=1,N1
! ! 			write(*,*) iray-1, xmux(iray), xmuy(iray), xmu(iray), wmu(iray)
! 			write(1,"(*(1ES18.9E3))") xmux(iray), xmuy(iray), xmu(iray), x2(iray), wmu(iray)
! ! 			write(*,*) iray-1, xmu(iray), x2(iray)
! 		enddo
! 		close(1)
!
! ! 		stop

		deallocate(x2)


	case ("HEALpix_adapt")

		!not needed yet, computing on the fly
		write(*,*) " Allocating space for healpix adapative scheme.."
!
! 		N1 = healpix_npix(healpix_lmax)
! 		N2 = N1
! 		allocate(xmu(N1),wmu(N1),stat=alloc_status)
! 		if (alloc_status > 0) call error("allocation error xmu and wmu")
! 		allocate(xmux(N2),xmuy(N2),stat=alloc_status)
! 		if (alloc_status > 0) call error("allocation error xmux, xmuy")

		!here we return
		return

	case ("gauss_legendre")
		if (present(Nmu)) then
			N1 = Nmu
		else
			N1 = 128
		endif
		if (present(Nphi)) then
			N2 = Nphi
		else
			N2 = 128
		endif

		allocate(x1(N1),x2(N2), w1(N1), w2(N2), xmu(N1*N2), wmu(N1*N2),xmux(N1*N2),xmuy(N1*N2),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmu and wmu")


		!w0 = xmu = cos(theta)
		call Gauss_Legendre_quadrature(-1.0_dp,1.0_dp,N1,x1,w1)
		w1(:) = 0.5 * w1(:)
		x2(1) = -pi
		do iphi=2, N2
			x2(iphi) = x2(iphi-1) + 2.0_dp*pi/real(N2 - 1,kind=dp)
		!!write(*,*) iphi, xphi(iphi)
		enddo
		w2(1) = 0.5 * (x2(2)-x2(1))
		w2(Nphi) = 0.5 * (x2(Nphi)-x2(Nphi-1))
		do iphi=2, N2-1
			w2(iphi) = 0.5 * (x2(iphi+1) - x2(iphi-1))
		enddo
		!wmu_phi(:) = wmu_phi(:) / (2.0*pi) !normed

		iray=1
		do imu=1,N1
			do iphi=1, N2
				xmu(iray) = x1(imu)
				xmux(iray) = sqrt(1.0 - x1(imu)**2) * cos(x2(iphi)) !u0
				xmuy(iray) = sqrt(1.0 - x1(imu)**2) * sin(x2(iphi)) !v0
				wmu(iray) = w1(imu) * w2(iphi) / (2.0 * pi)
				iray = iray+1
			enddo
		enddo

		deallocate(x1,x2,w1,w2)

	!S0 quadratures
	case ("bestard2021_L15N45")

		Nquad = 45 !for all octants
		allocate(colat(Nquad), azim(Nquad), wei(Nquad))

		wei = (/ 0.01114722, 0.01379874, 0.0172431 , 0.0172431 , 0.02112837,&
			0.02112837, 0.02133918, 0.02133918, 0.02266582, 0.02266582,&
			0.02005093, 0.02005093, 0.02055247, 0.02055247, 0.02304591,&
			0.02304591, 0.02296041, 0.02296041, 0.02172259, 0.02172259,&
			0.02420219, 0.02420219, 0.02274871, 0.02274871, 0.02251868,&
			0.02251868, 0.02309401, 0.02309401, 0.02361186, 0.02361186,&
			0.02258761, 0.02258761, 0.02398224, 0.02398224, 0.02442952,&
			0.02442952, 0.02414036, 0.02414036, 0.02454591, 0.02454591,&
			0.02422209, 0.02422209, 0.02426206, 0.02426206, 0.02494596 /)
		colat = (/ 123.64852794, 123.6485286 ,  38.23545799, 141.76454201,&
			125.46296721,  54.53703279,  81.20126964,  98.79873036,&
			32.10411667, 147.89588333, 128.81645772,  51.18354228,&
			82.65505169,  97.34494831,  18.33946358, 161.66053642,&
			76.93547444, 103.06452556, 108.41139959,  71.58860041,&
			13.53179867, 166.46820133,  78.55636139, 101.44363861,&
			117.60224289,  62.39775711, 115.11000594,  64.88999406,&
			94.61734552,  85.38265448, 137.16073815,  42.83926185,&
			142.64323112,  37.35676888, 120.02496442,  59.97503558,&
			77.55475424, 102.44524576, 146.03622764,  33.96377236,&
			99.05166262,  80.94833738, 123.10463125,  56.89536875,&
			56.3514717 /)
		azim = (/ 265.18155525,  94.81844513, 192.28328187, 347.71671813,&
			191.64388627, 348.35611373, 190.19821523,  10.19821523,&
			19.57605355, 160.42394645, 218.10157255,  38.10157255,&
			308.31285438, 231.68714562, 143.9417133 ,  36.0582867 ,&
			348.92227505, 191.07772495, 147.07670837,  32.92329163,&
			55.88395866, 235.88395866, 121.83710767,  58.16289233,&
			120.04070063,  59.95929937,  38.85820226, 141.14179774,&
			328.56503315, 211.43496685,  41.75679542, 138.24320458,&
			116.86299772, 296.86299772, 346.30505947, 166.30505947,&
			98.02153292, 278.02153292,  77.83645181, 102.16354819,&
			104.54232397, 284.54232397,  66.5552123 , 246.5552123 ,&
			274.81844496 /)

		N1 = Nquad; N2 = Nquad
		allocate(xmu(N1),wmu(N1),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmu and wmu")
		allocate(xmux(N2),xmuy(N2),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmux, xmuy")

		do imu=1, Nquad !loop not needed, just here for debug
			w0 = cos(colat(imu)*pi/180.0_dp)
			u0 = sqrt(1.0_dp  - w0*w0) * cos(azim(imu) * pi/180.0_dp)
			v0 = sqrt(1.0_dp  - w0*w0) * sin(azim(imu) * pi/180.0_dp)
			xmu(imu) = w0
			xmux(imu) = u0
			xmuy(imu) = v0
			wmu(imu) = wei(imu)
		enddo

		deallocate(azim, colat, wei)

	case ("bestard2021_L13N100")

		Nquad = 100 !for all octants
		allocate(colat(Nquad), azim(Nquad), wei(Nquad))

		wei = (/ 0.0071533 , 0.0071533 , 0.00768591, 0.00768591, 0.00814505,&
			0.00814505, 0.00904856, 0.00904856, 0.00950044, 0.00950044,&
			0.00824706, 0.00824706, 0.00948721, 0.00948721, 0.008946  ,&
			0.008946  , 0.00903666, 0.00903666, 0.01056593, 0.01056593,&
			0.00924798, 0.00924798, 0.0087072 , 0.0087072 , 0.00918496,&
			0.00918496, 0.01059342, 0.01059342, 0.0093276 , 0.0093276 ,&
			0.00962612, 0.00962612, 0.00917108, 0.00917108, 0.01070613,&
			0.01070613, 0.00941251, 0.00941251, 0.00986752, 0.00986752,&
			0.00881617, 0.00881617, 0.00970186, 0.00970186, 0.01008309,&
			0.01008309, 0.00975127, 0.00975127, 0.0100901 , 0.0100901 ,&
			0.00989028, 0.00989028, 0.01067073, 0.01067073, 0.0100696 ,&
			0.0100696 , 0.01160486, 0.01160486, 0.00814264, 0.00814264,&
			0.01030914, 0.01030914, 0.01071051, 0.01071051, 0.01059299,&
			0.01059299, 0.01029533, 0.01029533, 0.01048425, 0.01048425,&
			0.01219983, 0.01219983, 0.01076958, 0.01076958, 0.01016131,&
			0.01016131, 0.01093289, 0.01093289, 0.01106849, 0.01106849,&
			0.01077474, 0.01077474, 0.0112338 , 0.0112338 , 0.01127741,&
			0.01127741, 0.01129493, 0.01129493, 0.01183551, 0.01183551,&
			0.0120469 , 0.0120469 , 0.01188447, 0.01188447, 0.01230428,&
			0.01230428, 0.00941874, 0.00941874, 0.00792367, 0.00792367 /)

		colat = (/ 168.78580254,  11.21419746,  15.86118896, 164.13881104,&
			163.39805483,  16.60194517,  39.38236141, 140.61763859,&
			147.07488616,  32.92511384,  37.11822007, 142.88177993,&
			122.35784725,  57.64215275, 127.7784771 ,  52.2215229 ,&
			62.08213966, 117.91786034, 119.26472206,  60.73527794,&
			37.56356725, 142.43643275, 148.27256258,  31.72743742,&
			55.05673589, 124.94326411, 124.9246512 ,  55.0753488 ,&
			36.02215973, 143.97784027,  57.74651324, 122.25348676,&
			146.36658613,  33.63341387,  98.0503549 ,  81.9496451 ,&
			64.61896911, 115.38103089, 137.28690007,  42.71309993,&
			159.46390976,  20.53609024,  54.65556352, 125.34443648,&
			112.94278555,  67.05721445,  30.9740706 , 149.0259294 ,&
			120.06686531,  59.93313469, 135.01817409,  44.98182591,&
			101.70623462,  78.29376538, 140.77344165,  39.22655835,&
			77.59977158, 102.40022842, 162.06388975,  17.93611025,&
			52.24219964, 127.75780036,  59.79909174, 120.20090826,&
			76.93582445, 103.06417555,  74.59983044, 105.40016956,&
			73.7293437 , 106.2706563 ,  99.99633402,  80.00366598,&
			53.92314152, 126.07685848, 142.41970413,  37.58029587,&
			106.40814671,  73.59185329,  62.71933313, 117.28066687,&
			93.22457709,  86.77542291,  76.47551763, 103.52448237,&
			82.44828419,  97.55171581,  84.89903255,  95.10096745,&
			97.93377835,  82.06622165,  98.60009011,  81.39990989,&
			85.14914853,  94.85085147, 104.43662266,  75.56337734,&
			121.18483305,  58.81516695,  13.23539601, 166.76460399 /)
		azim = (/ 79.8072329 , 259.8072329 , 124.34380917, 304.34380917,&
			145.34314711, 325.34314711,  15.86668336, 195.86668336,&
			339.81631913, 159.81631913, 128.62326036, 308.62326036,&
			164.9108659 , 344.9108659 , 107.40834697, 287.40834697,&
			304.5813642 , 124.5813642 ,  11.94297955, 191.94297955,&
			100.22756578, 280.22756578, 112.83462177, 292.83462177,&
			265.85432511,  85.85432511, 348.67831979, 168.67831979,&
			346.45909527, 166.45909527, 120.04529173, 300.04529173,&
			80.26186953, 260.26186953,  11.62945434, 191.62945434,&
			325.75058904, 145.75058904, 138.59619   , 318.59619   ,&
			251.95383176,  71.95383176, 144.28779243, 324.28779243,&
			257.2898166 ,  77.2898166 , 225.12993614,  45.12993614,&
			277.89947394,  97.89947394, 253.6566505 ,  73.6566505 ,&
			193.18600994,  13.18600994, 225.90505375,  45.90505375,&
			169.77460487, 349.77460487, 201.36979551,  21.36979551,&
			241.09514547,  61.09514547,  30.82233415, 210.82233415,&
			126.19170507, 306.19170507, 147.96058233, 327.96058233,&
			257.29568427,  77.29568427, 169.89737066, 349.89737066,&
			215.72849209,  35.72849209,  12.13054389, 192.13054389,&
			55.10345235, 235.10345235,  54.37349393, 234.37349393,&
			261.5890436 ,  81.5890436 , 213.3646161 ,  33.3646161 ,&
			304.31786917, 124.31786917, 327.32316559, 147.32316559,&
			215.77715659,  35.77715659, 283.48863003, 103.48863003,&
			58.43126354, 238.43126354, 101.51273813, 281.51273813,&
			186.37634066,   6.37634066, 188.7546611 ,   8.7546611/)

		N1 = Nquad; N2 = Nquad
		allocate(xmu(N1),wmu(N1),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmu and wmu")
		allocate(xmux(N2),xmuy(N2),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmux, xmuy")

		do imu=1, Nquad !loop not needed, just here for debug
			w0 = cos(colat(imu)*pi/180.0_dp)
			u0 = sqrt(1.0_dp  - w0*w0) * cos(azim(imu) * pi/180.0_dp)
			v0 = sqrt(1.0_dp  - w0*w0) * sin(azim(imu) * pi/180.0_dp)
			xmu(imu) = w0
			xmux(imu) = u0
			xmuy(imu) = v0
			wmu(imu) = wei(imu)
		enddo

		deallocate(azim, colat, wei)

	case ("bestard2021_L15N124")

		Nquad = 124 !for all octants
		allocate(colat(Nquad), azim(Nquad), wei(Nquad))

		wei = (/ 0.00337284, 0.00337284, 0.00728555, 0.00728555, 0.00562708,&
			0.00562708, 0.00665609, 0.00665609, 0.00769006, 0.00769006,&
			0.00731889, 0.00731889, 0.00769476, 0.00769476, 0.00757717,&
			0.00757717, 0.00728657, 0.00728657, 0.00750884, 0.00750884,&
			0.00683845, 0.00683845, 0.00795773, 0.00795773, 0.00666746,&
			0.00666746, 0.007734  , 0.007734  , 0.00831532, 0.00831532,&
			0.00811567, 0.00811567, 0.00797968, 0.00797968, 0.00769831,&
			0.00769831, 0.00817986, 0.00817986, 0.00799763, 0.00799763,&
			0.00814381, 0.00814381, 0.00752333, 0.00752333, 0.00828704,&
			0.00828704, 0.00815958, 0.00815958, 0.0083905 , 0.0083905 ,&
			0.00856397, 0.00856397, 0.0082546 , 0.0082546 , 0.00836094,&
			0.00836094, 0.00844962, 0.00844962, 0.00812455, 0.00812455,&
			0.008591  , 0.008591  , 0.00889103, 0.00889103, 0.00864005,&
			0.00864005, 0.00826719, 0.00826719, 0.0086786 , 0.0086786 ,&
			0.00625146, 0.00625146, 0.00886981, 0.00886981, 0.00838762,&
			0.00838762, 0.00863183, 0.00863183, 0.00900692, 0.00900692,&
			0.00863007, 0.00863007, 0.00877411, 0.00877411, 0.00888528,&
			0.00888528, 0.00843168, 0.00843168, 0.00891205, 0.00891205,&
			0.0089607 , 0.0089607 , 0.00881659, 0.00881659, 0.0069437 ,&
			0.0069437 , 0.00883497, 0.00883497, 0.00918956, 0.00918956,&
			0.0090387 , 0.0090387 , 0.00922403, 0.00922403, 0.00949837,&
			0.00949837, 0.00925907, 0.00925907, 0.00938643, 0.00938643,&
			0.00990831, 0.00990831, 0.00532327, 0.00532327, 0.00815445,&
			0.00815445, 0.00654762, 0.00654762, 0.00878882, 0.00878882,&
			0.00807136, 0.00807136, 0.00844545, 0.00844545 /)

		colat = (/ 88.11239003,  91.88760997, 117.57269402,  62.42730598,&
			173.57550759,   6.42449241,  20.2690118 , 159.7309882 ,&
			24.06178057, 155.93821943,  44.84012978, 135.15987022,&
			44.68993618, 135.31006382,  62.48546441, 117.51453559,&
			157.17994079,  22.82005921, 116.85325026,  63.14674974,&
			155.93899601,  24.06100399,  64.41182857, 115.58817143,&
			16.99730639, 163.00269361,  41.04392832, 138.95607168,&
			41.81283807, 138.18716193, 120.1239171 ,  59.8760829 ,&
			99.21182033,  80.78817967,  23.61041496, 156.38958504,&
			59.1138782 , 120.8861218 ,  39.85087672, 140.14912328,&
			136.96397138,  43.03602862, 154.38384213,  25.61615787,&
			117.17891431,  62.82108569, 144.2273758 ,  35.7726242 ,&
			42.9484768 , 137.0515232 , 124.93796667,  55.06203333,&
			60.14756343, 119.85243657, 108.1119408 ,  71.8880592 ,&
			134.83539668,  45.16460332, 151.18684654,  28.81315346,&
			81.71726486,  98.28273514,  62.98624293, 117.01375707,&
			129.36643607,  50.63356393, 135.59199941,  44.40800059,&
			71.08671029, 108.91328971,  55.32650797, 124.67349203,&
			114.21282165,  65.78717835, 143.01196496,  36.98803504,&
			97.80046651,  82.19953349,  99.21603505,  80.78396495,&
			97.51818524,  82.48181476, 125.80402626,  54.19597374,&
			79.73568557, 100.26431443,  62.31246705, 117.68753295,&
			58.32600084, 121.67399916, 116.07311555,  63.92688445,&
			90.12424061,  89.87575939, 142.03549703,  37.96450297,&
			100.48744831,  79.51255169, 105.18738182,  74.81261818,&
			78.33501758, 101.66498242, 104.15044019,  75.84955981,&
			95.66403287,  84.33596713,  85.76534092,  94.23465908,&
			79.45560846, 100.54439154,  81.43187953,  98.56812047,&
			1.63211221, 178.36788779,  60.90436478, 119.09563522,&
			20.02586803, 159.97413197,  78.01080035, 101.98919965,&
			138.18196575,  41.81803425,  79.57087159, 100.42912841 /)

		azim = (/ 174.77345089, 354.77345089, 350.5860564 , 170.5860564 ,&
			70.33319257, 250.33319257, 107.86825608, 287.86825608,&
			336.51314148, 156.51314148, 333.50260454, 153.50260454,&
			210.93559094,  30.93559094, 130.65468494, 310.65468494,&
			115.67112147, 295.67112147,  20.44740162, 200.44740162,&
			324.87276282, 144.87276282,  23.67729608, 203.67729608,&
			60.93064326, 240.93064326, 310.7028696 , 130.7028696 ,&
			162.50540193, 342.50540193, 292.27342707, 112.27342707,&
			23.34681263, 203.34681263,  17.48771839, 197.48771839,&
			301.34961492, 121.34961492, 109.65913619, 289.65913619,&
			314.92244549, 134.92244549,  41.64738133, 221.64738133,&
			40.8529623 , 220.8529623 , 260.19974489,  80.19974489,&
			283.59976184, 103.59976184, 270.63409428,  90.63409428,&
			150.8964034 , 330.8964034 , 259.12124422,  79.12124422,&
			56.45011396, 236.45011396,  78.28954737, 258.28954737,&
			222.10689325,  42.10689325, 321.79034048, 141.79034048,&
			80.21069387, 260.21069387, 203.57290398,  23.57290398,&
			260.9689834 ,  80.9689834 , 185.36437744,   5.36437744,&
			61.2760318 , 241.2760318 , 229.2665114 ,  49.2665114 ,&
			138.75397892, 318.75397892, 158.26526291, 338.26526291,&
			198.33197237,  18.33197237, 246.48517587,  66.48517587,&
			160.56641976, 340.56641976, 343.82092784, 163.82092784,&
			44.07243641, 224.07243641, 100.5619543 , 280.5619543 ,&
			80.50372692, 260.50372692,   8.23902628, 188.23902628,&
			320.9073453 , 140.9073453 , 239.26817941,  59.26817941,&
			299.86888776, 119.86888776, 279.44374973,  99.44374973,&
			100.42567824, 280.42567824, 241.06536349,  61.06536349,&
			39.30423116, 219.30423116, 119.90104344, 299.90104344,&
			339.36553119, 159.36553119,   4.39736598, 184.39736598,&
			182.35156724,   2.35156724, 183.68622053,   3.68622053,&
			177.69545682, 357.69545682, 359.39348695, 179.39348695 /)

		N1 = Nquad; N2 = Nquad
		allocate(xmu(N1),wmu(N1),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmu and wmu")
		allocate(xmux(N2),xmuy(N2),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmux, xmuy")

		do imu=1, Nquad !loop not needed, just here for debug
			w0 = cos(colat(imu)*pi/180.0_dp)
			u0 = sqrt(1.0_dp  - w0*w0) * cos(azim(imu) * pi/180.0_dp)
			v0 = sqrt(1.0_dp  - w0*w0) * sin(azim(imu) * pi/180.0_dp)
			xmu(imu) = w0
			xmux(imu) = u0
			xmuy(imu) = v0
			wmu(imu) = wei(imu)
		enddo

		deallocate(azim, colat, wei)

	!S1 quadrature with L=15 and N=11*8 (total sphere)
	case ("stepan2020")
		Nquad = 11 !points per octant = Ntotal / 8
		allocate(colat(Nquad), azim(Nquad), wei(Nquad))
		! weight over the all sphere / theta (deg)  /    azimuth (deg)
		! for the first octant

		colat(:) = (/ 53.315719928593146903, 81.382467213182962951, 34.127332208658117452, 15.578524934891703424, &
					37.579916693977011732, 78.016940549443560826, 64.924968260607656134, 78.016940549443560826, &
					53.315719928593146903, 61.289485196402061717, 85.965248921746891142 /)
		azim(:) = (/ 84.610163655558565665, 62.110163655558558560, 62.110163655558544349, 17.110163655558558560, &
					17.110163655558569218, 84.610163655558551454, 17.110163655558555007, 39.610163655558558560, &
					 39.610163655558558560, 62.110163655558544349, 17.110163655558551454 /)
		wei(:) = (/ 0.011309124685216070, 0.009652307741108415, 0.013486249257448579, 0.011644240437362686, 0.012045724827157482, &
					0.012838609802518424, 0.011977125696312044, 0.012838609802518421, 0.011309124685216068,0.010715526695526693, &
					0.007183356369615116 /)

		N1 = 8*Nquad; N2 = 8*Nquad
		allocate(xmu(N1),wmu(N1),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmu and wmu")
		allocate(xmux(N2),xmuy(N2),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmux, xmuy")


		!define for each octant
		!z > 0
		!1)
		do imu=1, Nquad !loop not needed, just here for debug
			w0 = cos(colat(imu)*pi/180.0_dp)
			u0 = sqrt(1.0_dp  - w0*w0) * cos(azim(imu) * pi/180.0_dp)
			v0 = sqrt(1.0_dp  - w0*w0) * sin(azim(imu) * pi/180.0_dp)
			xmu(imu) = w0
			xmux(imu) = u0
			xmuy(imu) = v0
			wmu(imu) = wei(imu)
		enddo

		!2)
		do imu=1, Nquad
			w0 = cos(colat(imu)*pi/180.0_dp)
			u0 = sqrt(1.0_dp  - w0*w0) * cos((90.0 + azim(imu)) * pi/180.0_dp)
			v0 = sqrt(1.0_dp  - w0*w0) * sin((90.0 + azim(imu)) * pi/180.0_dp)
			xmu(Nquad+imu) = w0
			xmux(Nquad+imu) = u0
			xmuy(Nquad+imu) = v0
			wmu(Nquad+imu) = wei(imu)
		enddo

		!3)
		do imu=1, Nquad
			w0 = cos(colat(imu)*pi/180.0_dp)
			u0 = sqrt(1.0_dp  - w0*w0) * cos((180.0 + azim(imu)) * pi/180.0_dp)
			v0 = sqrt(1.0_dp  - w0*w0) * sin((180.0 + azim(imu)) * pi/180.0_dp)
			xmu(2*Nquad+imu) = w0
			xmux(2*Nquad+imu) = u0
			xmuy(2*Nquad+imu) = v0
			wmu(2*Nquad+imu) = wei(imu)
		enddo

		!4)
		do imu=1, Nquad
			w0 = cos(colat(imu)*pi/180.0_dp)
			u0 = sqrt(1.0_dp  - w0*w0) * cos((270.0 + azim(imu)) * pi/180.0_dp)
			v0 = sqrt(1.0_dp  - w0*w0) * sin((270.0 + azim(imu)) * pi/180.0_dp)
			xmu(3*Nquad+imu) = w0
			xmux(3*Nquad+imu) = u0
			xmuy(3*Nquad+imu) = v0
			wmu(3*Nquad+imu) = wei(imu)
		enddo

		!z < 0
		!5)
		do imu=1, Nquad !loop not needed, just here for debug
			w0 = -cos(colat(imu)*pi/180.0_dp)
			u0 = sqrt(1.0_dp  - w0*w0) * cos(azim(imu) * pi/180.0_dp)
			v0 = sqrt(1.0_dp  - w0*w0) * sin(azim(imu) * pi/180.0_dp)
			xmu(4*Nquad+imu) = w0
			xmux(4*Nquad+imu) = u0
			xmuy(4*Nquad+imu) = v0
			wmu(4*Nquad+imu) = wei(imu)
		enddo

		!6)
		do imu=1, Nquad
			w0 = -cos(colat(imu)*pi/180.0_dp)
			u0 = sqrt(1.0_dp  - w0*w0) * cos((90.0 + azim(imu)) * pi/180.0_dp)
			v0 = sqrt(1.0_dp  - w0*w0) * sin((90.0 + azim(imu)) * pi/180.0_dp)
			xmu(5*Nquad+imu) = w0
			xmux(5*Nquad+imu) = u0
			xmuy(5*Nquad+imu) = v0
			wmu(5*Nquad+imu) = wei(imu)
		enddo

		!7)
		do imu=1, Nquad
			w0 = -cos(colat(imu)*pi/180.0_dp)
			u0 = sqrt(1.0_dp  - w0*w0) * cos((180.0 + azim(imu)) * pi/180.0_dp)
			v0 = sqrt(1.0_dp  - w0*w0) * sin((180.0 + azim(imu)) * pi/180.0_dp)
			xmu(6*Nquad+imu) = w0
			xmux(6*Nquad+imu) = u0
			xmuy(6*Nquad+imu) = v0
			wmu(6*Nquad+imu) = wei(imu)
		enddo

		!8)
		do imu=1, Nquad
			w0 = -cos(colat(imu)*pi/180.0_dp)
			u0 = sqrt(1.0_dp  - w0*w0) * cos((270.0 + azim(imu)) * pi/180.0_dp)
			v0 = sqrt(1.0_dp  - w0*w0) * sin((270.0 + azim(imu)) * pi/180.0_dp)
			xmu(7*Nquad+imu) = w0
			xmux(7*Nquad+imu) = u0
			xmuy(7*Nquad+imu) = v0
			wmu(7*Nquad+imu) = wei(imu)
		enddo

		deallocate(colat, azim, wei)


	case ("carlson_A8")
	!B. G. Carlson
		Nquad = 10 !S8
		N1 = 8*Nquad; N2 = 8*Nquad
		allocate(xmu(N1),wmu(N1),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmu and wmu")
		allocate(xmux(N2),xmuy(N2),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmux, xmuy")

		!mine
		xmu(:) = (/ 0.95118973,  0.78679579,  0.78679579,  0.57735027,  0.57735027,&
        0.57735027,  0.21821789,  0.21821789,  0.21821789,  0.21821789, &
        0.95118973,  0.78679579,  0.78679579,  0.57735027,  0.57735027, &
        0.57735027,  0.21821789,  0.21821789,  0.21821789,  0.21821789, &
        0.95118973,  0.78679579,  0.78679579,  0.57735027,  0.57735027, &
        0.57735027,  0.21821789,  0.21821789,  0.21821789,  0.21821789, &
        0.95118973,  0.78679579,  0.78679579,  0.57735027,  0.57735027, &
        0.57735027,  0.21821789,  0.21821789,  0.21821789,  0.21821789, &
       -0.95118973, -0.78679579, -0.78679579, -0.57735027, -0.57735027, &
       -0.57735027, -0.21821789, -0.21821789, -0.21821789, -0.21821789, &
       -0.95118973, -0.78679579, -0.78679579, -0.57735027, -0.57735027, &
       -0.57735027, -0.21821789, -0.21821789, -0.21821789, -0.21821789, &
       -0.95118973, -0.78679579, -0.78679579, -0.57735027, -0.57735027, &
       -0.57735027, -0.21821789, -0.21821789, -0.21821789, -0.21821789, &
       -0.95118973, -0.78679579, -0.78679579, -0.57735027, -0.57735027, &
       -0.57735027, -0.21821789, -0.21821789, -0.21821789, -0.21821789/)


		xmux(:) = (/0.21821789,  0.57735027,  0.21821789,  0.78679579,  0.57735027, &
        0.21821789,  0.95118973,  0.78679579,  0.57735027,  0.21821789, &
       -0.21821789, -0.57735027, -0.21821789, -0.78679579, -0.57735027, &
       -0.21821789, -0.95118973, -0.78679579, -0.57735027, -0.21821789, &
       -0.21821789, -0.57735027, -0.21821789, -0.78679579, -0.57735027, &
       -0.21821789, -0.95118973, -0.78679579, -0.57735027, -0.21821789, &
        0.21821789,  0.57735027,  0.21821789,  0.78679579,  0.57735027, &
        0.21821789,  0.95118973,  0.78679579,  0.57735027,  0.21821789, &
        0.21821789,  0.57735027,  0.21821789,  0.78679579,  0.57735027, &
        0.21821789,  0.95118973,  0.78679579,  0.57735027,  0.21821789, &
       -0.21821789, -0.57735027, -0.21821789, -0.78679579, -0.57735027, &
       -0.21821789, -0.95118973, -0.78679579, -0.57735027, -0.21821789, &
       -0.21821789, -0.57735027, -0.21821789, -0.78679579, -0.57735027, &
       -0.21821789, -0.95118973, -0.78679579, -0.57735027, -0.21821789, &
        0.21821789,  0.57735027,  0.21821789,  0.78679579,  0.57735027, &
        0.21821789,  0.95118973,  0.78679579,  0.57735027,  0.21821789/)

		xmuy(:) = (/0.21821789,  0.21821789,  0.57735027,  0.21821789,  0.57735027,&
        0.78679579,  0.21821789,  0.57735027,  0.78679579,  0.95118973, &
        0.21821789,  0.21821789,  0.57735027,  0.21821789,  0.57735027, &
        0.78679579,  0.21821789,  0.57735027,  0.78679579,  0.95118973, &
       -0.21821789, -0.21821789, -0.57735027, -0.21821789, -0.57735027, &
       -0.78679579, -0.21821789, -0.57735027, -0.78679579, -0.95118973, &
       -0.21821789, -0.21821789, -0.57735027, -0.21821789, -0.57735027, &
       -0.78679579, -0.21821789, -0.57735027, -0.78679579, -0.95118973, &
        0.21821789,  0.21821789,  0.57735027,  0.21821789,  0.57735027, &
        0.78679579,  0.21821789,  0.57735027,  0.78679579,  0.95118973, &
        0.21821789,  0.21821789,  0.57735027,  0.21821789,  0.57735027, &
        0.78679579,  0.21821789,  0.57735027,  0.78679579,  0.95118973, &
       -0.21821789, -0.21821789, -0.57735027, -0.21821789, -0.57735027, &
       -0.78679579, -0.21821789, -0.57735027, -0.78679579, -0.95118973, &
       -0.21821789, -0.21821789, -0.57735027, -0.21821789, -0.57735027, &
       -0.78679579, -0.21821789, -0.57735027, -0.78679579, -0.95118973/)

		!normalized to 8 octants to have sum(wmu) = 1.0
		wmu(:) = (/0.01602704, 0.01130115, 0.01130115, 0.01130115, 0.00911197,&
       0.01130115, 0.01602704, 0.01130115, 0.01130115, 0.01602704,&
       0.01602704, 0.01130115, 0.01130115, 0.01130115, 0.00911197,&
       0.01130115, 0.01602704, 0.01130115, 0.01130115, 0.01602704,&
       0.01602704, 0.01130115, 0.01130115, 0.01130115, 0.00911197,&
       0.01130115, 0.01602704, 0.01130115, 0.01130115, 0.01602704,&
       0.01602704, 0.01130115, 0.01130115, 0.01130115, 0.00911197,&
       0.01130115, 0.01602704, 0.01130115, 0.01130115, 0.01602704,&
       0.01602704, 0.01130115, 0.01130115, 0.01130115, 0.00911197,&
       0.01130115, 0.01602704, 0.01130115, 0.01130115, 0.01602704,&
       0.01602704, 0.01130115, 0.01130115, 0.01130115, 0.00911197,&
       0.01130115, 0.01602704, 0.01130115, 0.01130115, 0.01602704,&
       0.01602704, 0.01130115, 0.01130115, 0.01130115, 0.00911197,&
       0.01130115, 0.01602704, 0.01130115, 0.01130115, 0.01602704,&
       0.01602704, 0.01130115, 0.01130115, 0.01130115, 0.00911197,&
       0.01130115, 0.01602704, 0.01130115, 0.01130115, 0.01602704/)

	case ("carlson_A8_rh")
	!B. G. Carlson
		Nquad = 10 !S8
		N1 = 8*Nquad; N2 = 8*Nquad
		allocate(xmu(N1),wmu(N1),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmu and wmu")
		allocate(xmux(N2),xmuy(N2),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmux, xmuy")

		!!rh similar to mine apart from order and numerical accuracy of weight
		xmu(:) = (/0.2182179 ,  0.2182179 ,  0.2182179 ,  0.2182179 ,  0.57735027,&
        0.57735027,  0.57735027,  0.78679579,  0.78679579,  0.95118973,&
        0.2182179 ,  0.2182179 ,  0.2182179 ,  0.2182179 ,  0.57735027,&
        0.57735027,  0.57735027,  0.78679579,  0.78679579,  0.95118973,&
        0.2182179 ,  0.2182179 ,  0.2182179 ,  0.2182179 ,  0.57735027,&
        0.57735027,  0.57735027,  0.78679579,  0.78679579,  0.95118973,&
        0.2182179 ,  0.2182179 ,  0.2182179 ,  0.2182179 ,  0.57735027,&
        0.57735027,  0.57735027,  0.78679579,  0.78679579,  0.95118973,&
       -0.2182179 , -0.2182179 , -0.2182179 , -0.2182179 , -0.57735027,&
       -0.57735027, -0.57735027, -0.78679579, -0.78679579, -0.95118973,&
       -0.2182179 , -0.2182179 , -0.2182179 , -0.2182179 , -0.57735027,&
       -0.57735027, -0.57735027, -0.78679579, -0.78679579, -0.95118973,&
       -0.2182179 , -0.2182179 , -0.2182179 , -0.2182179 , -0.57735027,&
       -0.57735027, -0.57735027, -0.78679579, -0.78679579, -0.95118973,&
       -0.2182179 , -0.2182179 , -0.2182179 , -0.2182179 , -0.57735027,&
       -0.57735027, -0.57735027, -0.78679579, -0.78679579, -0.95118973 /)

		xmux(:) = (/0.95118973,  0.78679579,  0.57735027,  0.21821789,  0.78679579,&
        0.57735027,  0.21821789,  0.57735027,  0.21821789,  0.21821789,&
       -0.95118973, -0.78679579, -0.57735027, -0.21821789, -0.78679579,&
       -0.57735027, -0.21821789, -0.57735027, -0.21821789, -0.21821789,&
       -0.95118973, -0.78679579, -0.57735027, -0.21821789, -0.78679579,&
       -0.57735027, -0.21821789, -0.57735027, -0.21821789, -0.21821789,&
        0.95118973,  0.78679579,  0.57735027,  0.21821789,  0.78679579,&
        0.57735027,  0.21821789,  0.57735027,  0.21821789,  0.21821789,&
        0.95118973,  0.78679579,  0.57735027,  0.21821789,  0.78679579,&
        0.57735027,  0.21821789,  0.57735027,  0.21821789,  0.21821789,&
       -0.95118973, -0.78679579, -0.57735027, -0.21821789, -0.78679579,&
       -0.57735027, -0.21821789, -0.57735027, -0.21821789, -0.21821789,&
       -0.95118973, -0.78679579, -0.57735027, -0.21821789, -0.78679579,&
       -0.57735027, -0.21821789, -0.57735027, -0.21821789, -0.21821789,&
        0.95118973,  0.78679579,  0.57735027,  0.21821789,  0.78679579,&
        0.57735027,  0.21821789,  0.57735027,  0.21821789,  0.21821789/)

		xmuy(:) = (/0.21821789,  0.57735027,  0.78679579,  0.95118973,  0.21821789,&
        0.57735027,  0.78679579,  0.21821789,  0.57735027,  0.21821789,&
        0.21821789,  0.57735027,  0.78679579,  0.95118973,  0.21821789,&
        0.57735027,  0.78679579,  0.21821789,  0.57735027,  0.21821789,&
       -0.21821789, -0.57735027, -0.78679579, -0.95118973, -0.21821789,&
       -0.57735027, -0.78679579, -0.21821789, -0.57735027, -0.21821789,&
       -0.21821789, -0.57735027, -0.78679579, -0.95118973, -0.21821789,&
       -0.57735027, -0.78679579, -0.21821789, -0.57735027, -0.21821789,&
        0.21821789,  0.57735027,  0.78679579,  0.95118973,  0.21821789,&
        0.57735027,  0.78679579,  0.21821789,  0.57735027,  0.21821789,&
        0.21821789,  0.57735027,  0.78679579,  0.95118973,  0.21821789,&
        0.57735027,  0.78679579,  0.21821789,  0.57735027,  0.21821789,&
       -0.21821789, -0.57735027, -0.78679579, -0.95118973, -0.21821789,&
       -0.57735027, -0.78679579, -0.21821789, -0.57735027, -0.21821789,&
       -0.21821789, -0.57735027, -0.78679579, -0.95118973, -0.21821789,&
       -0.57735027, -0.78679579, -0.21821789, -0.57735027, -0.21821789/)

		!normalized to 8 octants to have sum(wmu) = 1.0
		wmu(:) = (/0.01587267, 0.01142294, 0.01142294, 0.01587267, 0.01142294,&
       0.00884434, 0.01142294, 0.01142294, 0.01142294, 0.01587267,&
       0.01587267, 0.01142294, 0.01142294, 0.01587267, 0.01142294,&
       0.00884434, 0.01142294, 0.01142294, 0.01142294, 0.01587267,&
       0.01587267, 0.01142294, 0.01142294, 0.01587267, 0.01142294,&
       0.00884434, 0.01142294, 0.01142294, 0.01142294, 0.01587267,&
       0.01587267, 0.01142294, 0.01142294, 0.01587267, 0.01142294,&
       0.00884434, 0.01142294, 0.01142294, 0.01142294, 0.01587267,&
       0.01587267, 0.01142294, 0.01142294, 0.01587267, 0.01142294,&
       0.00884434, 0.01142294, 0.01142294, 0.01142294, 0.01587267,&
       0.01587267, 0.01142294, 0.01142294, 0.01587267, 0.01142294,&
       0.00884434, 0.01142294, 0.01142294, 0.01142294, 0.01587267,&
       0.01587267, 0.01142294, 0.01142294, 0.01587267, 0.01142294,&
       0.00884434, 0.01142294, 0.01142294, 0.01142294, 0.01587267,&
       0.01587267, 0.01142294, 0.01142294, 0.01587267, 0.01142294,&
       0.00884434, 0.01142294, 0.01142294, 0.01142294, 0.01587267/)

	case ("carlson_B8_rh")
		!rh
		Nquad = 10
		N1 = 8*Nquad; N2 = 8*Nquad
		allocate(xmu(N1),wmu(N1),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmu and wmu")
		allocate(xmux(N2),xmuy(N2),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmux, xmuy")

		xmu(:) = (/ 0.50307326,  0.50307327,  0.50307327,  0.50307326,  0.70273364,&
        0.70273364,  0.70273364,  0.85708017,  0.85708017,  0.98759216,&
        0.50307326,  0.50307327,  0.50307327,  0.50307326,  0.70273364,&
        0.70273364,  0.70273364,  0.85708017,  0.85708017,  0.98759216,&
        0.50307326,  0.50307327,  0.50307327,  0.50307326,  0.70273364,&
        0.70273364,  0.70273364,  0.85708017,  0.85708017,  0.98759216,&
        0.50307326,  0.50307327,  0.50307327,  0.50307326,  0.70273364,&
        0.70273364,  0.70273364,  0.85708017,  0.85708017,  0.98759216,&
       -0.50307326, -0.50307327, -0.50307327, -0.50307326, -0.70273364,&
       -0.70273364, -0.70273364, -0.85708017, -0.85708017, -0.98759216,&
       -0.50307326, -0.50307327, -0.50307327, -0.50307326, -0.70273364,&
       -0.70273364, -0.70273364, -0.85708017, -0.85708017, -0.98759216,&
       -0.50307326, -0.50307327, -0.50307327, -0.50307326, -0.70273364,&
       -0.70273364, -0.70273364, -0.85708017, -0.85708017, -0.98759216,&
       -0.50307326, -0.50307327, -0.50307327, -0.50307326, -0.70273364,&
       -0.70273364, -0.70273364, -0.85708017, -0.85708017, -0.98759216/)


		xmux(:) = (/0.85708018,  0.70273364,  0.50307327,  0.1110444 ,  0.70273364,&
        0.50307327,  0.1110444 ,  0.50307327,  0.1110444 ,  0.1110444 ,&
       -0.85708018, -0.70273364, -0.50307327, -0.1110444 , -0.70273364,&
       -0.50307327, -0.1110444 , -0.50307327, -0.1110444 , -0.1110444 ,&
       -0.85708018, -0.70273364, -0.50307327, -0.1110444 , -0.70273364,&
       -0.50307327, -0.1110444 , -0.50307327, -0.1110444 , -0.1110444 ,&
        0.85708018,  0.70273364,  0.50307327,  0.1110444 ,  0.70273364,&
        0.50307327,  0.1110444 ,  0.50307327,  0.1110444 ,  0.1110444 ,&
        0.85708018,  0.70273364,  0.50307327,  0.1110444 ,  0.70273364,&
        0.50307327,  0.1110444 ,  0.50307327,  0.1110444 ,  0.1110444 ,&
       -0.85708018, -0.70273364, -0.50307327, -0.1110444 , -0.70273364,&
       -0.50307327, -0.1110444 , -0.50307327, -0.1110444 , -0.1110444 ,&
       -0.85708018, -0.70273364, -0.50307327, -0.1110444 , -0.70273364,&
       -0.50307327, -0.1110444 , -0.50307327, -0.1110444 , -0.1110444 ,&
        0.85708018,  0.70273364,  0.50307327,  0.1110444 ,  0.70273364,&
        0.50307327,  0.1110444 ,  0.50307327,  0.1110444 ,  0.1110444/)

		xmuy(:) = (/0.1110444 ,  0.50307327,  0.70273364,  0.85708018,  0.1110444 ,&
        0.50307327,  0.70273364,  0.1110444 ,  0.50307327,  0.1110444 ,&
        0.1110444 ,  0.50307327,  0.70273364,  0.85708018,  0.1110444 ,&
        0.50307327,  0.70273364,  0.1110444 ,  0.50307327,  0.1110444 ,&
       -0.1110444 , -0.50307327, -0.70273364, -0.85708018, -0.1110444 ,&
       -0.50307327, -0.70273364, -0.1110444 , -0.50307327, -0.1110444 ,&
       -0.1110444 , -0.50307327, -0.70273364, -0.85708018, -0.1110444 ,&
       -0.50307327, -0.70273364, -0.1110444 , -0.50307327, -0.1110444 ,&
        0.1110444 ,  0.50307327,  0.70273364,  0.85708018,  0.1110444 ,&
        0.50307327,  0.70273364,  0.1110444 ,  0.50307327,  0.1110444 ,&
        0.1110444 ,  0.50307327,  0.70273364,  0.85708018,  0.1110444 ,&
        0.50307327,  0.70273364,  0.1110444 ,  0.50307327,  0.1110444 ,&
       -0.1110444 , -0.50307327, -0.70273364, -0.85708018, -0.1110444 ,&
       -0.50307327, -0.70273364, -0.1110444 , -0.50307327, -0.1110444 ,&
       -0.1110444 , -0.50307327, -0.70273364, -0.85708018, -0.1110444 ,&
       -0.50307327, -0.70273364, -0.1110444 , -0.50307327, -0.1110444/)

		!normalized to 8 octants to have sum(wmu) = 1.0
		wmu(:) = (/0.02144029, 0.00862565, 0.00862565, 0.02144029, 0.00862565,&
       0.00892523, 0.00862565, 0.00862565, 0.00862565, 0.02144029,&
       0.02144029, 0.00862565, 0.00862565, 0.02144029, 0.00862565,&
       0.00892523, 0.00862565, 0.00862565, 0.00862565, 0.02144029,&
       0.02144029, 0.00862565, 0.00862565, 0.02144029, 0.00862565,&
       0.00892523, 0.00862565, 0.00862565, 0.00862565, 0.02144029,&
       0.02144029, 0.00862565, 0.00862565, 0.02144029, 0.00862565,&
       0.00892523, 0.00862565, 0.00862565, 0.00862565, 0.02144029,&
       0.02144029, 0.00862565, 0.00862565, 0.02144029, 0.00862565,&
       0.00892523, 0.00862565, 0.00862565, 0.00862565, 0.02144029,&
       0.02144029, 0.00862565, 0.00862565, 0.02144029, 0.00862565,&
       0.00892523, 0.00862565, 0.00862565, 0.00862565, 0.02144029,&
       0.02144029, 0.00862565, 0.00862565, 0.02144029, 0.00862565,&
       0.00892523, 0.00862565, 0.00862565, 0.00862565, 0.02144029,&
       0.02144029, 0.00862565, 0.00862565, 0.02144029, 0.00862565,&
       0.00892523, 0.00862565, 0.00862565, 0.00862565, 0.02144029/)

    case ("carlson_C16")
		Nquad = 36
		N1 = 8*Nquad; N2 = 8*Nquad
		allocate(xmu(N1),wmu(N1),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmu and wmu")
		allocate(xmux(N2),xmuy(N2),stat=alloc_status)
		if (alloc_status > 0) call error("allocation error xmux, xmuy")

		xmu(:) = (/0.97752522,  0.9067647 ,  0.9067647 ,  0.82999331,  0.82999331,&
        0.82999331,  0.74535599,  0.74535599,  0.74535599,  0.74535599,&
        0.64978629,  0.64978629,  0.64978629,  0.64978629,  0.64978629,&
        0.53748385,  0.53748385,  0.53748385,  0.53748385,  0.53748385,&
        0.53748385,  0.39440532,  0.39440532,  0.39440532,  0.39440532,&
        0.39440532,  0.39440532,  0.39440532,  0.1490712 ,  0.1490712 ,&
        0.1490712 ,  0.1490712 ,  0.1490712 ,  0.1490712 ,  0.1490712 ,&
        0.1490712 ,  0.97752522,  0.9067647 ,  0.9067647 ,  0.82999331,&
        0.82999331,  0.82999331,  0.74535599,  0.74535599,  0.74535599,&
        0.74535599,  0.64978629,  0.64978629,  0.64978629,  0.64978629,&
        0.64978629,  0.53748385,  0.53748385,  0.53748385,  0.53748385,&
        0.53748385,  0.53748385,  0.39440532,  0.39440532,  0.39440532,&
        0.39440532,  0.39440532,  0.39440532,  0.39440532,  0.1490712 ,&
        0.1490712 ,  0.1490712 ,  0.1490712 ,  0.1490712 ,  0.1490712 ,&
        0.1490712 ,  0.1490712 ,  0.97752522,  0.9067647 ,  0.9067647 ,&
        0.82999331,  0.82999331,  0.82999331,  0.74535599,  0.74535599,&
        0.74535599,  0.74535599,  0.64978629,  0.64978629,  0.64978629,&
        0.64978629,  0.64978629,  0.53748385,  0.53748385,  0.53748385,&
        0.53748385,  0.53748385,  0.53748385,  0.39440532,  0.39440532,&
        0.39440532,  0.39440532,  0.39440532,  0.39440532,  0.39440532,&
        0.1490712 ,  0.1490712 ,  0.1490712 ,  0.1490712 ,  0.1490712 ,&
        0.1490712 ,  0.1490712 ,  0.1490712 ,  0.97752522,  0.9067647 ,&
        0.9067647 ,  0.82999331,  0.82999331,  0.82999331,  0.74535599,&
        0.74535599,  0.74535599,  0.74535599,  0.64978629,  0.64978629,&
        0.64978629,  0.64978629,  0.64978629,  0.53748385,  0.53748385,&
        0.53748385,  0.53748385,  0.53748385,  0.53748385,  0.39440532,&
        0.39440532,  0.39440532,  0.39440532,  0.39440532,  0.39440532,&
        0.39440532,  0.1490712 ,  0.1490712 ,  0.1490712 ,  0.1490712 ,&
        0.1490712 ,  0.1490712 ,  0.1490712 ,  0.1490712 , -0.97752522,&
       -0.9067647 , -0.9067647 , -0.82999331, -0.82999331, -0.82999331,&
       -0.74535599, -0.74535599, -0.74535599, -0.74535599, -0.64978629,&
       -0.64978629, -0.64978629, -0.64978629, -0.64978629, -0.53748385,&
       -0.53748385, -0.53748385, -0.53748385, -0.53748385, -0.53748385,&
       -0.39440532, -0.39440532, -0.39440532, -0.39440532, -0.39440532,&
       -0.39440532, -0.39440532, -0.1490712 , -0.1490712 , -0.1490712 ,&
       -0.1490712 , -0.1490712 , -0.1490712 , -0.1490712 , -0.1490712 ,&
       -0.97752522, -0.9067647 , -0.9067647 , -0.82999331, -0.82999331,&
       -0.82999331, -0.74535599, -0.74535599, -0.74535599, -0.74535599,&
       -0.64978629, -0.64978629, -0.64978629, -0.64978629, -0.64978629,&
       -0.53748385, -0.53748385, -0.53748385, -0.53748385, -0.53748385,&
       -0.53748385, -0.39440532, -0.39440532, -0.39440532, -0.39440532,&
       -0.39440532, -0.39440532, -0.39440532, -0.1490712 , -0.1490712 ,&
       -0.1490712 , -0.1490712 , -0.1490712 , -0.1490712 , -0.1490712 ,&
       -0.1490712 , -0.97752522, -0.9067647 , -0.9067647 , -0.82999331,&
       -0.82999331, -0.82999331, -0.74535599, -0.74535599, -0.74535599,&
       -0.74535599, -0.64978629, -0.64978629, -0.64978629, -0.64978629,&
       -0.64978629, -0.53748385, -0.53748385, -0.53748385, -0.53748385,&
       -0.53748385, -0.53748385, -0.39440532, -0.39440532, -0.39440532,&
       -0.39440532, -0.39440532, -0.39440532, -0.39440532, -0.1490712 ,&
       -0.1490712 , -0.1490712 , -0.1490712 , -0.1490712 , -0.1490712 ,&
       -0.1490712 , -0.1490712 , -0.97752522, -0.9067647 , -0.9067647 ,&
       -0.82999331, -0.82999331, -0.82999331, -0.74535599, -0.74535599,&
       -0.74535599, -0.74535599, -0.64978629, -0.64978629, -0.64978629,&
       -0.64978629, -0.64978629, -0.53748385, -0.53748385, -0.53748385,&
       -0.53748385, -0.53748385, -0.53748385, -0.39440532, -0.39440532,&
       -0.39440532, -0.39440532, -0.39440532, -0.39440532, -0.39440532,&
       -0.1490712 , -0.1490712 , -0.1490712 , -0.1490712 , -0.1490712 ,&
       -0.1490712 , -0.1490712 , -0.1490712/)

		xmux(:) = (/0.1490712 ,  0.39440532,  0.1490712 ,  0.53748385,  0.39440532,&
        0.1490712 ,  0.64978629,  0.53748385,  0.39440532,  0.1490712 ,&
        0.74535599,  0.64978629,  0.53748385,  0.39440532,  0.1490712 ,&
        0.82999331,  0.74535599,  0.64978629,  0.53748385,  0.39440532,&
        0.1490712 ,  0.9067647 ,  0.82999331,  0.74535599,  0.64978629,&
        0.53748385,  0.39440532,  0.1490712 ,  0.97752522,  0.9067647 ,&
        0.82999331,  0.74535599,  0.64978629,  0.53748385,  0.39440532,&
        0.1490712 , -0.1490712 , -0.39440532, -0.1490712 , -0.53748385,&
       -0.39440532, -0.1490712 , -0.64978629, -0.53748385, -0.39440532,&
       -0.1490712 , -0.74535599, -0.64978629, -0.53748385, -0.39440532,&
       -0.1490712 , -0.82999331, -0.74535599, -0.64978629, -0.53748385,&
       -0.39440532, -0.1490712 , -0.9067647 , -0.82999331, -0.74535599,&
       -0.64978629, -0.53748385, -0.39440532, -0.1490712 , -0.97752522,&
       -0.9067647 , -0.82999331, -0.74535599, -0.64978629, -0.53748385,&
       -0.39440532, -0.1490712 , -0.1490712 , -0.39440532, -0.1490712 ,&
       -0.53748385, -0.39440532, -0.1490712 , -0.64978629, -0.53748385,&
       -0.39440532, -0.1490712 , -0.74535599, -0.64978629, -0.53748385,&
       -0.39440532, -0.1490712 , -0.82999331, -0.74535599, -0.64978629,&
       -0.53748385, -0.39440532, -0.1490712 , -0.9067647 , -0.82999331,&
       -0.74535599, -0.64978629, -0.53748385, -0.39440532, -0.1490712 ,&
       -0.97752522, -0.9067647 , -0.82999331, -0.74535599, -0.64978629,&
       -0.53748385, -0.39440532, -0.1490712 ,  0.1490712 ,  0.39440532,&
        0.1490712 ,  0.53748385,  0.39440532,  0.1490712 ,  0.64978629,&
        0.53748385,  0.39440532,  0.1490712 ,  0.74535599,  0.64978629,&
        0.53748385,  0.39440532,  0.1490712 ,  0.82999331,  0.74535599,&
        0.64978629,  0.53748385,  0.39440532,  0.1490712 ,  0.9067647 ,&
        0.82999331,  0.74535599,  0.64978629,  0.53748385,  0.39440532,&
        0.1490712 ,  0.97752522,  0.9067647 ,  0.82999331,  0.74535599,&
        0.64978629,  0.53748385,  0.39440532,  0.1490712 ,  0.1490712 ,&
        0.39440532,  0.1490712 ,  0.53748385,  0.39440532,  0.1490712 ,&
        0.64978629,  0.53748385,  0.39440532,  0.1490712 ,  0.74535599,&
        0.64978629,  0.53748385,  0.39440532,  0.1490712 ,  0.82999331,&
        0.74535599,  0.64978629,  0.53748385,  0.39440532,  0.1490712 ,&
        0.9067647 ,  0.82999331,  0.74535599,  0.64978629,  0.53748385,&
        0.39440532,  0.1490712 ,  0.97752522,  0.9067647 ,  0.82999331,&
        0.74535599,  0.64978629,  0.53748385,  0.39440532,  0.1490712 ,&
       -0.1490712 , -0.39440532, -0.1490712 , -0.53748385, -0.39440532,&
       -0.1490712 , -0.64978629, -0.53748385, -0.39440532, -0.1490712 ,&
       -0.74535599, -0.64978629, -0.53748385, -0.39440532, -0.1490712 ,&
       -0.82999331, -0.74535599, -0.64978629, -0.53748385, -0.39440532,&
       -0.1490712 , -0.9067647 , -0.82999331, -0.74535599, -0.64978629,&
       -0.53748385, -0.39440532, -0.1490712 , -0.97752522, -0.9067647 ,&
       -0.82999331, -0.74535599, -0.64978629, -0.53748385, -0.39440532,&
       -0.1490712 , -0.1490712 , -0.39440532, -0.1490712 , -0.53748385,&
       -0.39440532, -0.1490712 , -0.64978629, -0.53748385, -0.39440532,&
       -0.1490712 , -0.74535599, -0.64978629, -0.53748385, -0.39440532,&
       -0.1490712 , -0.82999331, -0.74535599, -0.64978629, -0.53748385,&
       -0.39440532, -0.1490712 , -0.9067647 , -0.82999331, -0.74535599,&
       -0.64978629, -0.53748385, -0.39440532, -0.1490712 , -0.97752522,&
       -0.9067647 , -0.82999331, -0.74535599, -0.64978629, -0.53748385,&
       -0.39440532, -0.1490712 ,  0.1490712 ,  0.39440532,  0.1490712 ,&
        0.53748385,  0.39440532,  0.1490712 ,  0.64978629,  0.53748385,&
        0.39440532,  0.1490712 ,  0.74535599,  0.64978629,  0.53748385,&
        0.39440532,  0.1490712 ,  0.82999331,  0.74535599,  0.64978629,&
        0.53748385,  0.39440532,  0.1490712 ,  0.9067647 ,  0.82999331,&
        0.74535599,  0.64978629,  0.53748385,  0.39440532,  0.1490712 ,&
        0.97752522,  0.9067647 ,  0.82999331,  0.74535599,  0.64978629,&
        0.53748385,  0.39440532,  0.1490712 /)

		xmuy(:) = (/0.1490712 ,  0.1490712 ,  0.39440532,  0.1490712 ,  0.39440532,&
        0.53748385,  0.1490712 ,  0.39440532,  0.53748385,  0.64978629,&
        0.1490712 ,  0.39440532,  0.53748385,  0.64978629,  0.74535599,&
        0.1490712 ,  0.39440532,  0.53748385,  0.64978629,  0.74535599,&
        0.82999331,  0.1490712 ,  0.39440532,  0.53748385,  0.64978629,&
        0.74535599,  0.82999331,  0.9067647 ,  0.1490712 ,  0.39440532,&
        0.53748385,  0.64978629,  0.74535599,  0.82999331,  0.9067647 ,&
        0.97752522,  0.1490712 ,  0.1490712 ,  0.39440532,  0.1490712 ,&
        0.39440532,  0.53748385,  0.1490712 ,  0.39440532,  0.53748385,&
        0.64978629,  0.1490712 ,  0.39440532,  0.53748385,  0.64978629,&
        0.74535599,  0.1490712 ,  0.39440532,  0.53748385,  0.64978629,&
        0.74535599,  0.82999331,  0.1490712 ,  0.39440532,  0.53748385,&
        0.64978629,  0.74535599,  0.82999331,  0.9067647 ,  0.1490712 ,&
        0.39440532,  0.53748385,  0.64978629,  0.74535599,  0.82999331,&
        0.9067647 ,  0.97752522, -0.1490712 , -0.1490712 , -0.39440532,&
       -0.1490712 , -0.39440532, -0.53748385, -0.1490712 , -0.39440532,&
       -0.53748385, -0.64978629, -0.1490712 , -0.39440532, -0.53748385,&
       -0.64978629, -0.74535599, -0.1490712 , -0.39440532, -0.53748385,&
       -0.64978629, -0.74535599, -0.82999331, -0.1490712 , -0.39440532,&
       -0.53748385, -0.64978629, -0.74535599, -0.82999331, -0.9067647 ,&
       -0.1490712 , -0.39440532, -0.53748385, -0.64978629, -0.74535599,&
       -0.82999331, -0.9067647 , -0.97752522, -0.1490712 , -0.1490712 ,&
       -0.39440532, -0.1490712 , -0.39440532, -0.53748385, -0.1490712 ,&
       -0.39440532, -0.53748385, -0.64978629, -0.1490712 , -0.39440532,&
       -0.53748385, -0.64978629, -0.74535599, -0.1490712 , -0.39440532,&
       -0.53748385, -0.64978629, -0.74535599, -0.82999331, -0.1490712 ,&
       -0.39440532, -0.53748385, -0.64978629, -0.74535599, -0.82999331,&
       -0.9067647 , -0.1490712 , -0.39440532, -0.53748385, -0.64978629,&
       -0.74535599, -0.82999331, -0.9067647 , -0.97752522,  0.1490712 ,&
        0.1490712 ,  0.39440532,  0.1490712 ,  0.39440532,  0.53748385,&
        0.1490712 ,  0.39440532,  0.53748385,  0.64978629,  0.1490712 ,&
        0.39440532,  0.53748385,  0.64978629,  0.74535599,  0.1490712 ,&
        0.39440532,  0.53748385,  0.64978629,  0.74535599,  0.82999331,&
        0.1490712 ,  0.39440532,  0.53748385,  0.64978629,  0.74535599,&
        0.82999331,  0.9067647 ,  0.1490712 ,  0.39440532,  0.53748385,&
        0.64978629,  0.74535599,  0.82999331,  0.9067647 ,  0.97752522,&
        0.1490712 ,  0.1490712 ,  0.39440532,  0.1490712 ,  0.39440532,&
        0.53748385,  0.1490712 ,  0.39440532,  0.53748385,  0.64978629,&
        0.1490712 ,  0.39440532,  0.53748385,  0.64978629,  0.74535599,&
        0.1490712 ,  0.39440532,  0.53748385,  0.64978629,  0.74535599,&
        0.82999331,  0.1490712 ,  0.39440532,  0.53748385,  0.64978629,&
        0.74535599,  0.82999331,  0.9067647 ,  0.1490712 ,  0.39440532,&
        0.53748385,  0.64978629,  0.74535599,  0.82999331,  0.9067647 ,&
        0.97752522, -0.1490712 , -0.1490712 , -0.39440532, -0.1490712 ,&
       -0.39440532, -0.53748385, -0.1490712 , -0.39440532, -0.53748385,&
       -0.64978629, -0.1490712 , -0.39440532, -0.53748385, -0.64978629,&
       -0.74535599, -0.1490712 , -0.39440532, -0.53748385, -0.64978629,&
       -0.74535599, -0.82999331, -0.1490712 , -0.39440532, -0.53748385,&
       -0.64978629, -0.74535599, -0.82999331, -0.9067647 , -0.1490712 ,&
       -0.39440532, -0.53748385, -0.64978629, -0.74535599, -0.82999331,&
       -0.9067647 , -0.97752522, -0.1490712 , -0.1490712 , -0.39440532,&
       -0.1490712 , -0.39440532, -0.53748385, -0.1490712 , -0.39440532,&
       -0.53748385, -0.64978629, -0.1490712 , -0.39440532, -0.53748385,&
       -0.64978629, -0.74535599, -0.1490712 , -0.39440532, -0.53748385,&
       -0.64978629, -0.74535599, -0.82999331, -0.1490712 , -0.39440532,&
       -0.53748385, -0.64978629, -0.74535599, -0.82999331, -0.9067647 ,&
       -0.1490712 , -0.39440532, -0.53748385, -0.64978629, -0.74535599,&
       -0.82999331, -0.9067647 , -0.97752522 /)

		wmu(:) = (/0.00437572, 0.00274193, 0.00274193, 0.00215982, 0.00174144,&
       0.00215982, 0.01649865, 0.0116337 , 0.0116337 , 0.01649865,&
       0.00198342, 0.00132394, 0.00115784, 0.00132394, 0.00198342,&
       0.00215982, 0.00139857, 0.00115784, 0.00115784, 0.00139857,&
       0.00215982, 0.00274193, 0.00174144, 0.00139857, 0.00132394,&
       0.00139857, 0.00174144, 0.00274193, 0.00437572, 0.00274193,&
       0.00215982, 0.00198342, 0.00198342, 0.00215982, 0.00274193,&
       0.00437572, 0.00437572, 0.00274193, 0.00274193, 0.00215982,&
       0.00174144, 0.00215982, 0.01649865, 0.0116337 , 0.0116337 ,&
       0.01649865, 0.00198342, 0.00132394, 0.00115784, 0.00132394,&
       0.00198342, 0.00215982, 0.00139857, 0.00115784, 0.00115784,&
       0.00139857, 0.00215982, 0.00274193, 0.00174144, 0.00139857,&
       0.00132394, 0.00139857, 0.00174144, 0.00274193, 0.00437572,&
       0.00274193, 0.00215982, 0.00198342, 0.00198342, 0.00215982,&
       0.00274193, 0.00437572, 0.00437572, 0.00274193, 0.00274193,&
       0.00215982, 0.00174144, 0.00215982, 0.01649865, 0.0116337 ,&
       0.0116337 , 0.01649865, 0.00198342, 0.00132394, 0.00115784,&
       0.00132394, 0.00198342, 0.00215982, 0.00139857, 0.00115784,&
       0.00115784, 0.00139857, 0.00215982, 0.00274193, 0.00174144,&
       0.00139857, 0.00132394, 0.00139857, 0.00174144, 0.00274193,&
       0.00437572, 0.00274193, 0.00215982, 0.00198342, 0.00198342,&
       0.00215982, 0.00274193, 0.00437572, 0.00437572, 0.00274193,&
       0.00274193, 0.00215982, 0.00174144, 0.00215982, 0.01649865,&
       0.0116337 , 0.0116337 , 0.01649865, 0.00198342, 0.00132394,&
       0.00115784, 0.00132394, 0.00198342, 0.00215982, 0.00139857,&
       0.00115784, 0.00115784, 0.00139857, 0.00215982, 0.00274193,&
       0.00174144, 0.00139857, 0.00132394, 0.00139857, 0.00174144,&
       0.00274193, 0.00437572, 0.00274193, 0.00215982, 0.00198342,&
       0.00198342, 0.00215982, 0.00274193, 0.00437572, 0.00437572,&
       0.00274193, 0.00274193, 0.00215982, 0.00174144, 0.00215982,&
       0.01649865, 0.0116337 , 0.0116337 , 0.01649865, 0.00198342,&
       0.00132394, 0.00115784, 0.00132394, 0.00198342, 0.00215982,&
       0.00139857, 0.00115784, 0.00115784, 0.00139857, 0.00215982,&
       0.00274193, 0.00174144, 0.00139857, 0.00132394, 0.00139857,&
       0.00174144, 0.00274193, 0.00437572, 0.00274193, 0.00215982,&
       0.00198342, 0.00198342, 0.00215982, 0.00274193, 0.00437572,&
       0.00437572, 0.00274193, 0.00274193, 0.00215982, 0.00174144,&
       0.00215982, 0.01649865, 0.0116337 , 0.0116337 , 0.01649865,&
       0.00198342, 0.00132394, 0.00115784, 0.00132394, 0.00198342,&
       0.00215982, 0.00139857, 0.00115784, 0.00115784, 0.00139857,&
       0.00215982, 0.00274193, 0.00174144, 0.00139857, 0.00132394,&
       0.00139857, 0.00174144, 0.00274193, 0.00437572, 0.00274193,&
       0.00215982, 0.00198342, 0.00198342, 0.00215982, 0.00274193,&
       0.00437572, 0.00437572, 0.00274193, 0.00274193, 0.00215982,&
       0.00174144, 0.00215982, 0.01649865, 0.0116337 , 0.0116337 ,&
       0.01649865, 0.00198342, 0.00132394, 0.00115784, 0.00132394,&
       0.00198342, 0.00215982, 0.00139857, 0.00115784, 0.00115784,&
       0.00139857, 0.00215982, 0.00274193, 0.00174144, 0.00139857,&
       0.00132394, 0.00139857, 0.00174144, 0.00274193, 0.00437572,&
       0.00274193, 0.00215982, 0.00198342, 0.00198342, 0.00215982,&
       0.00274193, 0.00437572, 0.00437572, 0.00274193, 0.00274193,&
       0.00215982, 0.00174144, 0.00215982, 0.01649865, 0.0116337 ,&
       0.0116337 , 0.01649865, 0.00198342, 0.00132394, 0.00115784,&
       0.00132394, 0.00198342, 0.00215982, 0.00139857, 0.00115784,&
       0.00115784, 0.00139857, 0.00215982, 0.00274193, 0.00174144,&
       0.00139857, 0.00132394, 0.00139857, 0.00174144, 0.00274193,&
       0.00437572, 0.00274193, 0.00215982, 0.00198342, 0.00198342,&
       0.00215982, 0.00274193, 0.00437572 /)

	case ("bruls1999")
	!Same as Carlson ? not useful ?
		call error("Not defined yet","Bruls1999")

	case default

		call error("Anuglar integration method unknown!", trim(angular_quadrature))

	end select

	!Check the normalisation conditions + one integral
	!1)
	! int over dOmega is 4pi = sum of weights
	!2)
	! int over dOmega of (nx,ny,z) must be 0
	!3) not mandatory
	! int over dOmega of dot(n,n) should, eventually be 4pi/3 or 1/3

  	norm = 0.0   ! int (dOmega) / 4pi
  	integ1 = 0.0 !cos(theta)
  	integ2 = 0.0 !cos(phi)*sin(theta)
  	integ3 = 0.0 !sin(phi)*sin(theta)
  	integ4 = 0.0 ! dot (n,n)
  	integ = 0.0  ! exp(-(nz**2 + nx**2)) over the sphere
  	do imu=1,size(xmu)
  		norm = norm + wmu(imu)
  		integ1 = integ1 + wmu(imu) * xmu(imu)
    	integ2 = integ2 + wmu(imu) * xmux(imu)
  		integ3 = integ3 + wmu(imu) * xmuy(imu)
  		integ4 = integ4 + wmu(imu) * (xmu(imu)**2 + xmux(imu)**2 + xmuy(imu)**2)
		integ = integ + wmu(imu) * exp(-(xmu(imu)**2 + xmux(imu)**2))
  	enddo
  	write(*,*) "1) sum weights (no norm):",  4.0*pi*norm, " domega/4pi:", sum(wmu) !=norm
	write(*,*) "2) (nx,ny,nz):", integ1, integ2, integ3
	write(*,*) "3) (n.n):", integ4/3.0_dp, 1.0_dp/3.0_dp!4.0/3.0 * pi
	write(*,*) " int(exp(-(nz**2 + nx**2)) dOmega):", integ, " true = ", 6.76171 / (4.0 * pi)


  return
  end subroutine compute_angular_integration_weights

 function VBROAD_atom(icell, atom) result(vD)
  real(kind=dp) :: vD
  integer :: icell
  type (AtomType) :: atom

   vD = sqrt( Vtherm*T(icell)/atom%weight + vturb(icell)**2 )

 return
 end function VBROAD_atom

 function nTotal_atom(icell, atom) result(ntotal)
  real(kind=dp) :: ntotal
  integer :: icell
  type (AtomType) :: atom

   ntotal =  atom%Abund * nHtot(icell)

 return
 end function nTotal_atom

  subroutine freeZeemanMultiplet(line)
   type(AtomicLine), intent(inout) :: line

   if (allocated(line%zm%strength)) deallocate(line%zm%strength)
   if (allocated(line%zm%q)) deallocate(line%zm%q)
   if (allocated(line%zm%shift)) deallocate(line%zm%shift)

  return
  end subroutine freeZeemanMultiplet

  subroutine freeAtom(atom)
  ! This subroutine free atmos%atoms properly including lines
  ! and continua.

   integer :: n, l, c
   type (AtomType), intent(inout) :: atom
   type (AtomicLine) :: line
   type (AtomicContinuum) :: cont

    !why error with deallocate(lines)
    atom%ID="" !just for checking

    if (allocated(atom%label)) deallocate(atom%label)
    if (allocated(atom%stage)) deallocate(atom%stage)
    if (allocated(atom%Lorbit)) deallocate(atom%Lorbit)
    if (allocated(atom%g)) deallocate(atom%g)
    if (allocated(atom%E)) deallocate(atom%E)
    !if (allocated(atom%vbroad)) deallocate(atom%vbroad)
    !if (allocated(atom%ntotal)) deallocate(atom%ntotal)
    if (allocated(atom%qS)) deallocate(atom%qS)
    if (allocated(atom%qJ)) deallocate(atom%qJ)
    !if (allocated(atom%C)) deallocate(atom%C)
    !free collision here
    if (allocated(atom%Gamma)) deallocate(atom%Gamma)
    if (allocated(atom%collision_lines)) deallocate(atom%collision_lines)

    !! maintenant se sont des pointeurs n et nstar
    !! so we need ot check if %n is an alias or not.
    !! if it is an alias, when %nstar is deallocated,
    !! %n needs to be nullified, not deallocated as
    !! it is already delinked from %nstar
    if ((atom%active).or.(atom%NLTEpops)) then
     if (associated(atom%n)) deallocate(atom%n)
     if (associated(atom%nstar)) deallocate(atom%nstar)
    else !passive
      NULLIFY(atom%n)
      if (associated(atom%nstar)) deallocate(atom%nstar)
    end if
    if (allocated(atom%b)) deallocate(atom%b)
!     if (allocated(atom%gij)) deallocate(atom%gij)
!     if (allocated(atom%Vij)) deallocate(atom%Vij)

    if (allocated(atom%eta)) deallocate(atom%eta)
    if (allocated(atom%etac)) deallocate(atom%etac)
    if (allocated(atom%chic)) deallocate(atom%chic)
	if (allocated(atom%gauss_prof)) deallocate(atom%Gauss_prof,atom%ug)

!!!     for this atom, free lines if allocated
     if (allocated(atom%lines)) then
     do l=1,atom%Nline
      line = atom%lines(l)
      if (allocated(line%phi)) deallocate(line%phi)
      if (allocated(line%map)) deallocate(line%map)
      if (allocated(line%mapc)) deallocate(line%mapc)
!       if (allocated(line%phi_Q)) deallocate(line%phi_Q)
!       if (allocated(line%phi_U)) deallocate(line%phi_U)
!       if (allocated(line%phi_V)) deallocate(line%phi_V)
!       if (allocated(line%psi_Q)) deallocate(line%psi_Q)
!       if (allocated(line%psi_U)) deallocate(line%psi_U)
!       if (allocated(line%psi_V)) deallocate(line%psi_V)
      if (allocated(line%lambda)) deallocate(line%lambda)
      !The net cooling rates is stored instead of the radiative rates
      !which are now scalar.
      if (allocated(line%CoolRates_ij)) deallocate(line%CoolRates_ij)
!       if (allocated(line%Rij)) deallocate(line%Rij)
!       if (allocated(line%Rji)) deallocate(line%Rji)
	  if (allocated(line%u)) deallocate(line%u)
      if (allocated(line%w_lam)) deallocate(line%w_lam) !over frequencies and angles and proc
      !if (allocated(line%Qelast)) deallocate(line%Qelast)
      !if (allocated(line%c_shift)) deallocate(line%c_shift)
      !if (allocated(line%c_fraction)) deallocate(line%c_fraction)
      !if (allocated(line%adamp)) deallocate(line%adamp)
      if (allocated(line%rho_pfr)) deallocate(line%rho_pfr)
      !if (allocated(line%gij)) deallocate(line%gij)
      !if (allocated(line%Vij)) deallocate(line%Vij)
!       if (allocated(line%chi_up)) deallocate(line%chi_up)
       !if (allocated(line%chi)) deallocate(line%chi)
       !if (allocated(line%U)) deallocate(line%U)
      !!if (allocated(line%Jbar)) deallocate(line%Jbar)
      if (associated(line%atom)) NULLIFY(line%atom)
      call freeZeemanMultiplet(line)
     end do
      deallocate(atom%lines)
     end if
!!!     now free continua if allocated
     if (allocated(atom%continua)) then
     do c=1, atom%Ncont
      cont = atom%continua(c)
      if (allocated(cont%lambda)) deallocate(cont%lambda)
      if (allocated(cont%alpha)) deallocate(cont%alpha)
      if (allocated(cont%CoolRates_ij)) deallocate(cont%CoolRates_ij)
      if (allocated(cont%w_lam)) deallocate(cont%w_lam)
      if (allocated(cont%gij)) deallocate(cont%gij)
      if (allocated(cont%twohnu3_c2)) deallocate(cont%twohnu3_c2)
      !if (allocated(cont%Vij)) deallocate(cont%Vij)
!       if (allocated(cont%chi_up)) deallocate(cont%chi_up)
       !if (allocated(cont%chi)) deallocate(cont%chi)
       !if (allocated(cont%U)) deallocate(cont%U)
	  !!if (allocated(cont%Jbar)) deallocate(cont%Jbar)
      if (associated(cont%atom)) NULLIFY(cont%atom)
     end do
      deallocate(atom%continua)
     end if

  return
  end subroutine freeAtom


  subroutine realloc_transitions(atom, Nt, mask)
  !Only kept indexes in atom%at if line contribute to opac
   integer, intent(in) :: Nt
   type (AtomType), intent(inout) :: atom
   logical, intent(in), dimension(:) :: mask
   integer :: k, k1
   type (AtomicTransition), dimension(atom%Ntr) :: trans

    !temporary storage
    trans = atom%at

    deallocate(atom%at)
    allocate(atom%at(Nt));atom%Ntr=Nt

    k1=1
    do k=1,atom%Nline
     !write(*,*) trans(k)%ik, trans(k)%trtype
     if (mask(k)) then
      atom%at(k1) = trans(k)
      !write(*,*) atom%at(k1)%ik, atom%at(k1)%trtype
      k1 = k1 + 1
     end if
    end do

    atom%Ntr_line = k1-1

    k1 = atom%Ntr_line + 1
    do k=Atom%Nline+1,atom%Nline+atom%Ncont
     !write(*,*) trans(k)%ik, trans(k)%trtype
     if (mask(k)) then
      atom%at(k1) = trans(k)
      !write(*,*) atom%at(k1)%ik, atom%at(k1)%trtype
      k1 = k1 + 1
     end if
    end do

    !write(*,*) atom%Ntr_line, atom%Ntr, size(trans), size(atom%lines), size(atom%continua)
   k1 = 0
  return
  end subroutine realloc_transitions


  subroutine realloc_line_transitions_deprec(atom, Nl_new, mask)
  !basicazlly does what PAck does
   integer, intent(in) :: Nl_new
   type (AtomType), intent(inout) :: atom
   logical, intent(in), dimension(:) :: mask
   !integer, intent(in), dimension(:) :: indexes
   integer :: k, k1
   type (AtomicLine), dimension(:), allocatable :: lines

    !temporary storage
    allocate(lines(atom%Nline)); lines=atom%lines
     do k=1,atom%Nline
      if (allocated(atom%lines(k)%phi)) &
      	deallocate(atom%lines(k)%phi)
      if (allocated(atom%lines(k)%lambda)) &
      	deallocate(atom%lines(k)%lambda)
      if (allocated(atom%lines(k)%CoolRates_ij)) &
      	deallocate(atom%lines(k)%CoolRates_ij)
      !if (allocated(atom%lines(k)%wlam)) &
      !	deallocate(atom%lines(k)%wlam)
      if (allocated(atom%lines(k)%phi)) &
      	deallocate(atom%lines(k)%phi)
      if (allocated(atom%lines(k)%rho_pfr)) &
      	deallocate(atom%lines(k)%rho_pfr)
      !if (allocated(atom%lines(k)%gij)) &
      !	deallocate(atom%lines(k)%gij)
      !if (allocated(atom%lines(k)%Vij)) &
      !	deallocate(atom%lines(k)%Vij)

      !!if (allocated(atom%lines(k)%Jbar)) &
      	!!deallocate(atom%lines(k)%Jbar)
      if (associated(atom%lines(k)%atom)) &
      	NULLIFY(atom%lines(k)%atom)
      call freeZeemanMultiplet(atom%lines(k))
     end do
    !Pack the transitions
    deallocate(atom%lines)
    allocate(atom%lines(Nl_new));atom%Nline=Nl_new
    k1=1
    do k=1,size(lines)
     if (mask(k)) then
      atom%lines(k1) = lines(k)
      k1 = k1 + 1
     end if
    end do
    deallocate(lines)

  return
  end subroutine realloc_line_transitions_deprec

  subroutine realloc_continuum_transitions_deprec(atom, Nc_new, mask)
   integer, intent(in) :: Nc_new
   logical, intent(in), dimension(:) :: mask
   type (AtomType), intent(inout) :: atom
   !integer, intent(in), dimension(:) :: indexes
   integer :: k, k1
   type (AtomicContinuum), dimension(:), allocatable :: conta


    allocate(conta(atom%Ncont)); conta=atom%continua
    do k=1,atom%Ncont
     if (allocated(atom%continua(k)%lambda)) &
     	deallocate(atom%continua(k)%lambda)
     if (allocated(atom%continua(k)%alpha)) &
     	deallocate(atom%continua(k)%alpha)
     if (allocated(atom%continua(k)%coolrates_ij)) &
     	deallocate(atom%continua(k)%coolrates_ij)
     !need to be reallocated in case of active atoms
     !if (allocated(atom%continua(k)%gij)) &
     !	deallocate(atom%continua(k)%gij)
     !if (allocated(atom%continua(k)%Vij)) &
     !	deallocate(atom%continua(k)%Vij)
	 !!if (allocated(atom%continua(k)%Jbar)) &
	    !!deallocate(atom%continua(k)%Jbar)
     if (associated(atom%continua(k)%atom)) &
     	NULLIFY(atom%continua(k)%atom)
    end do
    !Pack the transitions
    deallocate(atom%continua)
    allocate(atom%continua(Nc_new));atom%Ncont=Nc_new
    k1=1
    do k=1,size(conta)
     !write(*,*) size(conta), k, k1, mask(k)
     if (mask(k)) then
      atom%continua(k1) = conta(k)
      !write(*,*) maxval(atmos%Atoms(n)%ptr_atom%continua(k1)%alpha), maxval(conta(k)%alpha)
      k1 = k1 + 1
     end if
    end do
    deallocate(conta)

  return
  end subroutine realloc_continuum_transitions_deprec

  subroutine readKurucz_pf(code, Npf, Nstage, ionpot, pf)
   !return pf function for atom with Z = code
   ! there is an HDU for each element (+one for T grid already read)
   integer :: unit, EOF, blocksize, i, j
   integer, intent(in) :: code
   integer :: NAXISPF(2), naxis_found, hdutype, Z, shape_pf(2)
   character(len=256) :: some_comments
   integer,  intent(inout) :: Nstage
   integer,  intent(in) :: Npf
   real(kind=dp), allocatable, dimension(:,:) :: data_krz
   real(kind=dp), allocatable, intent(inout), dimension(:,:) :: pf
   real(kind=dp), allocatable, intent(inout), dimension(:) :: ionpot
   logical :: anynull

   EOF = 0
   !get unique unit number
   call ftgiou(unit,EOF)
   ! open fits file in readmode'
   call ftopen(unit, TRIM(mcfost_utils)//TRIM(KURUCZ_PF_FILE), 0, blocksize, EOF)

    !move to nexthdu, 1=Primary, already read
    !Hydrogen = 2 = code+1
    call FTMAHD(unit,code+1,hdutype,EOF)
    if (EOF.ne.0) then
     write(*,*) "error reading partition function"
     write(*,*) "error to change HDU at ", code+1
     write(*,*) "exiting..."
     stop
    end if
    call ftgkyj(unit, "NSTAGE", Nstage, some_comments, EOF) !replace j with d if read double instead of int
    call ftgkyj(unit, "Z", Z, some_comments, EOF)
    !j'arrive pas a lire ce string, but it is not necessary
    !but should asks christophe to know how to do
    !call ftgkyj(unit, "ELEM", AtomID, commentfits, EOF)

    !write(*,*) "Nstage", Nstage, "Z=", Z, "for elem:", elemental_ID(code)
    !write(*,*) "Npf points = ", Npf
    !now read partition function
    call ftgknj(unit, 'NAXIS', 1, 2, NAXISPF, naxis_found, EOF)
    if (NAXISPF(1).ne.Npf.and.NAXISPF(2).ne.Nstage) then
      write(*,*) "error reading partition function"
      write(*,*) "NAXISPF(len=2)=",NAXISPF," NPOINTS=", &
                 Npf, " NSTAGE=", Nstage
      write(*,*) "exiting"
      stop
    end if
    !data are actually transposed from my fits to fortran
    allocate(data_krz(Npf+1,Nstage))
    allocate(ionpot(Nstage))
    allocate(pf(Nstage, Npf))
    !now read the value of pf for that atom
    ! remember: pf(:,1) =  ion potentials
    !           pf(:,2:) = partition functions for all ion pots.
    !e = real*4
    !d = real*8            !shape(data_krz)
    shape_pf(1) = Npf+1; shape_pf(2) = Nstage
    call FTG2Dd(unit,1,-999,shape_pf,Npf+1,Nstage,data_krz,anynull,EOF)
    !do i=1,Nstage
    ! write(*,*) "potential in cm-1 for elem ", elemental_ID(code),":", &
    !            data_krz(1,i)
     !fill ionpot array and pf array for that elem
     ! store value in Joule
     ionpot(:) = data_krz(1,:) * HPLANCK*CLIGHT / (CM_TO_M)
     !write(*,*) "chi(i) = ", data_krz(1,i)
     !do not forget to write partition function has (Nstage,Npf)
     !instead of (Npf, Nstage) as read by FTG2D
     !store value in logarithm of partition function, for interpolation
     do i=1,Nstage
      do j=2,Npf+1
       !!if (code.eq.1) write(*,*) 'pf=', data_krz(j,i)
       !!!pf(i,j-1) = LOG10(data_krz(j,i)) !29/12/2019, using neperien log
       pf(i,j-1) = LOG(data_krz(j,i))
       !!if (code.eq.1) write(*,*) 'pf10powLog=', 10**(pf(i,j-1))
      end do
     end do
    !end do
    !check shapes
    !write(*,*) "Shapes ionpot and pf: ", shape(ionpot), shape(pf)


    !close file
    call ftclos(unit, EOF)
    ! free the unit number
    call ftfiou(unit, EOF)
    deallocate(data_krz)
  return
  end subroutine readKurucz_pf

  subroutine dealloc_atomic_atmos()
  integer :: n

  if (allocated(ds)) deallocate(ds)
  if (allocated(xmu)) deallocate(xmu, wmu, xmux, xmuy)

  if (allocated(Elements)) then
    do n=1,Nelem
     if (allocated(Elements(n)%ptr_elem%mol_index)) deallocate (Elements(n)%ptr_elem%mol_index)
     if (allocated(Elements(n)%ptr_elem%ionpot)) deallocate (Elements(n)%ptr_elem%ionpot)
     if (allocated(Elements(n)%ptr_elem%pf)) deallocate (Elements(n)%ptr_elem%pf)
!      if (allocated(Elements(n)%ptr_elem%n))  deallocate (Elements(n)%ptr_elem%n)
     !if alias exist for this element free it.
     if (associated(Elements(n)%ptr_elem%model)) NULLIFY(Elements(n)%ptr_elem%model)
!       ! de-alias %model to the proper Atoms(nmet), Atoms will be freed after.
    end do
   deallocate(Elements) !here it works
  end if

  if (allocated(nHtot)) deallocate(nHtot)
  if (allocated(ne)) deallocate(ne)
  if (allocated(Tpf)) deallocate(Tpf)
  if (allocated(T)) deallocate(T)
  if (allocated(vturb)) deallocate(vturb)
  if (allocated(nHmin)) deallocate(nHmin)
  if (allocated(icompute_atomRT)) deallocate(icompute_atomRT)
!   if (allocated(lcompute_atomRT)) deallocate(lcompute_atomRT)
!   if (allocated(ldark_zone)) deallocate(ldark_zone)
!   if (allocated(Vxyz)) deallocate(Vxyz)
  if (allocated(vR)) deallocate(vR)
  if (allocated(v_z)) deallocate(v_z)
  if (allocated(vphi)) deallocate(vphi)

  if (allocated(BR)) deallocate(BR)
  if (allocated(B_z)) deallocate(B_z)
  if (allocated(Bphi)) deallocate(Bphi)
  if (allocated(Bmag)) deallocate(Bmag)
  if (allocated(gammab)) deallocate(gammab)
  if (allocated(chib)) deallocate(chib)
  !write(*,*) "Free Atoms"
  ! start freeing Atoms if previously allocated
  ! in readAtom()
   !if (allocated(Atoms)) then
  do n=1,Npassiveatoms
   if (associated(PassiveAtoms(n)%ptr_atom)) NULLIFY(PassiveAtoms(n)%ptr_atom)
  end do
  if (allocated(PassiveAtoms)) deallocate(PassiveAtoms)
  do n=1,Nactiveatoms
   if (associated(ActiveAtoms(n)%ptr_atom)) NULLIFY(ActiveAtoms(n)%ptr_atom)
  end do
  if (allocated(ActiveAtoms)) deallocate(ActiveAtoms)
  do n=1,Natom
   if (associated(Atoms(n)%ptr_atom)) then !now c'est un pointeur array
!    ! H is alway presents as it is required !
!    ! but He exists only if a model atom is given and so
!    ! Helium is allocated only if He exists i.e., if
!    ! Atoms(n)%periodic_tabel.eq.2 with n a number.
    if (associated(Hydrogen)) NULLIFY(Hydrogen) ! Hydrogen is always associated
    if (associated(Helium)) NULLIFY(Helium)
!    do n=1,Natom
     call freeAtom(Atoms(n)%ptr_atom)
!    end do
!    if (associated(ActiveAtoms)) deallocate(ActiveAtoms)
!   deallocate(Atoms)
    NULLIFY(Atoms(n)%ptr_atom)
   end if
  end do
  deallocate(Atoms)
  return
  end subroutine dealloc_atomic_atmos

!   subroutine fillElements()
!   !This routine read the abundance of elements listed in the
!   ! abundance.input file, and keep the log partition function values
!   ! for each elements in atmos%Elements
!   !
!   !Elements in Abundance file are read in order of Z, so that H is 1, He is 2 ect
!   type (Element) :: elem
!   integer :: EOF, n, blocksize, unit, i, j, k, ni
!   integer :: NAXIST, naxis_found, hdutype, Z
!   character(len=256) :: some_comments
!   logical :: anynull
!   character(len=4) :: charID
!   real :: A
!
!   EOF = 0
!   !Start reading partition function by first reading the grid
!   !get unique unit number
!   call ftgiou(unit,EOF)
!   ! open fits file in readmode'
!   call ftopen(unit, TRIM(mcfost_utils)//TRIM(KURUCZ_PF_FILE), 0, blocksize, EOF)
!   !some check about the first axis!
!   !get first axis
!   call ftgknj(unit, 'NAXIS', 1, 1, NAXIST, naxis_found, EOF)
!   !read dimension of partition function table
!   call ftgkyj(unit, "NPOINTS", atmos%Npf, some_comments, EOF)
!   if (NAXIST.ne.atmos%Npf) then
!    write(*,*) "Error in reading pf data !"
!    write(*,*) "NAXIST=",NAXIST," NPOINTS=", atmos%Npf
!    write(*,*) "exiting... !"
!    stop
!   end if
!   !write(*,*) NAXIST, atmos%Npf
!
!   allocate(atmos%Tpf(atmos%Npf))
!   !now read temperature grid
!   call ftgpvd(unit,1,1,atmos%Npf,-999,atmos%Tpf,anynull,EOF) !d because double !!
! !   do k=1,atmos%Npf
! !    write(*,*) "T=", atmos%Tpf(k), "K"
! !   end do
!   !close file
!   call ftclos(unit, EOF)
!   ! free the unit number
!   call ftfiou(unit, EOF)
!
!   n = 1 !H is the first element read
!   EOF = 0
!   !write(*,*) "Metallicity = ", atmos%metallicity
!
!   !read abundances
!   open(unit=1, file=TRIM(ABUNDANCE_FILE),status="old")
!   do while (n <= Nelem)!(EOF == 0)
!    read(1, '(1A4, 1F5.3)', IOSTAT=EOF) charID, A
!    if (EOF /= 0) exit !stop before doing something if no more elem in abundance file
!    if ((charID(1:1) /= '#').or.(charID(1:1)/="")) then
!     allocate(atmos%Elements(n)%ptr_elem)
!     atmos%Elements(n)%ptr_elem%weight=atomic_weights(n)
!     atmos%Elements(n)%ptr_elem%ID = charID(1:2) !supposed to be lowercases!!!!!
!     atmos%Elements(n)%ptr_elem%abund = 10.**(A-12.0)
!
!     if (A <= -99) atmos%Elements(n)%ptr_elem%abund = 0d0
!
!     write(*,*) n, "Element ", atmos%Elements(n)%ptr_elem%ID," has an abundance of A=",&
!               atmos%Elements(n)%ptr_elem%abund,A," and a weight of w=",&
!                atmos%Elements(n)%ptr_elem%weight
! !
! !     if (n.gt.1 .and. atmos%metallicity.gt.0.) then
! !      atmos%Elements(n)%ptr_elem%abund = &
! !                      atmos%Elements(n)%ptr_elem%abund*10.**(atmos%metallicity)
! !     end if
!     atmos%totalAbund = atmos%totalAbund+atmos%Elements(n)%ptr_elem%abund
!     atmos%avgWeight = atmos%avgWeight+atmos%Elements(n)%ptr_elem%abund* &
!                      atmos%Elements(n)%ptr_elem%weight
!     !write(*,*) "updating total Abundance = ",atmos%totalAbund
!     !write(*,*) "updating average weight = ", atmos%avgWeight
!
!     !attribute partition function to each element
!     !the temperature grid is shared and saved in atmos%Tpf
!     !write(*,*) "Fill partition function for element ", atmos%Elements(n)%ID
!     call readKurucz_pf(n, atmos%Npf, &
!               atmos%Elements(n)%ptr_elem%Nstage, atmos%Elements(n)%ptr_elem%ionpot, &
!               atmos%Elements(n)%ptr_elem%pf)
!     !do i=1,atmos%Elements(n)%Nstage !convert from J->eV
!     ! write(*,*) "Inpot for stage ", i, &
!     !            atmos%Elements(n)%ionpot(i)*JOULE_TO_EV, " eV"
!     !end do
!     !! allocate space for futur populations of each stage
!     !!allocate(atmos%Elements(n)%n(atmos%Elements(n)%Nstage, atmos%Nspace))
!     !write(*,*) "Elem pop" !BEWARE of n index and Elements(n)%n
!     ! there is a conflict
! !     do ni=1,Nelem
! !      atmos%Elements(n)%n(:,:)=0d0
! !     end do
!
!     !write(*,*) "************************************"
!     n = n + 1 !go to next element, n is 1 at init for H
!    end if
!
! !    if (n > Nelem) then
! !     exit
! !    end if
!   end do
!   atmos%wght_per_H = atmos%avgWeight
!   atmos%avgWeight = atmos%avgWeight/atmos%totalAbund
!   write(*,*) "Total Abundance in the atmosphere = ", atmos%totalAbund
!   write(*,*) "Total average weight = ", atmos%avgWeight
!   write(*,*) "Weight per Hydrogen = ", atmos%wght_per_H
!   write(*,*) ""
!   stop
!   close(unit=1)
!
!   return
!   end subroutine fillElements

  subroutine fillElements()
  !This routine read the abundance of elements listed in the
  ! abundance.input file, and keep the log partition function values
  ! for each elements in atmos%Elements
  !
  !Elements in Abundance file are read in order of Z, so that H is 1, He is 2 ect
  type (Element) :: elem
  integer :: EOF, n, blocksize, unit, i, j, k, ni, syst_status
  integer :: NAXIST(1), naxis_found, hdutype, Z, Nread
  character(len=256) :: some_comments
  logical :: anynull
  character(len=4) :: charID
  character(len=MAX_LENGTH) :: inputline, FormatLine, cmd
  real :: A

  EOF = 0
  !Start reading partition function by first reading the grid
  !get unique unit number
  call ftgiou(unit,EOF)
  ! open fits file in readmode'
  call ftopen(unit, TRIM(mcfost_utils)//TRIM(KURUCZ_PF_FILE), 0, blocksize, EOF)
  !some check about the first axis!
  !get first axis
  call ftgknj(unit, 'NAXIS', 1, 1, NAXIST, naxis_found, EOF)
  !read dimension of partition function table
  call ftgkyj(unit, "NPOINTS", Npf, some_comments, EOF)
  if (NAXIST(1).ne.Npf) then
   write(*,*) "Error in reading pf data !"
   write(*,*) "NAXIST=",NAXIST," NPOINTS=", Npf
   write(*,*) "exiting... !"
   stop
  end if
  !write(*,*) NAXIST, Npf

  allocate(Tpf(Npf))
  !now read temperature grid
  call ftgpvd(unit,1,1,Npf,-999,Tpf,anynull,EOF) !d because double !!
!   do k=1,Npf
!    write(*,*) "T=", Tpf(k), "K"
!   end do
  !close file
  call ftclos(unit, EOF)
  ! free the unit number
  call ftfiou(unit, EOF)

  !write(*,*) "Metallicity = ", metallicity

  !read abundances
  write(FormatLine,'("(1"A,I3")")') "A", MAX_LENGTH

  !get number of elements
  cmd = "wc -l "//TRIM(ABUNDANCE_FILE)//" > abund_nelem.txt"
  call appel_syst(cmd,syst_status)
  open(unit=1,file="abund_nelem.txt",status="old")
  read(1,*) Nelem
  close(unit=1)
  write(*,*) " Reading abundances of ", Nelem, " elements..."
  if (Nelem < 3) write(*,*) " WARNING:, not that using Nelem < 3 will cause problem", &
  		" in solvene.f90 or other functions assuming abundances of metal of to 26 are known!!"

  if (.not.allocated(Elements)) allocate(Elements(Nelem))

  open(unit=1, file=TRIM(ABUNDANCE_FILE),status="old")
  !Read Number of elements
  !-> need to modify the file format to include if at the biginning
  !call getnextline(1, "#", FormatLine, inputline, Nread)
  !read(inputline,*) Nelem

  do n=1, Nelem !H is first, then He ect

    call getnextline(1, "#", FormatLine, inputline, Nread)
    read(inputline,*) charID, A

    allocate(Elements(n)%ptr_elem)
    Elements(n)%ptr_elem%weight=atomic_weights(n)
    Elements(n)%ptr_elem%ID = charID(1:2) !supposed to be lowercases!!!!!
    Elements(n)%ptr_elem%abund = 10.**(A-12.0)

    if (A <= -99) Elements(n)%ptr_elem%abund = 0d0

!     write(*,*) n, "Element ", Elements(n)%ptr_elem%ID," has an abundance of A=",&
!               Elements(n)%ptr_elem%abund,A," and a weight of w=",&
!                Elements(n)%ptr_elem%weight

    Elements(n)%ptr_elem%abundance_set = .true.
!
!     if (n.gt.1 .and. metallicity.gt.0.) then
!      Elements(n)%ptr_elem%abund = &
!                      Elements(n)%ptr_elem%abund*10.**(metallicity)
!     end if
    totalAbund = totalAbund+Elements(n)%ptr_elem%abund
    avgWeight = avgWeight+Elements(n)%ptr_elem%abund* &
                     Elements(n)%ptr_elem%weight
    !write(*,*) "updating total Abundance = ",totalAbund
    !write(*,*) "updating average weight = ", avgWeight

    !attribute partition function to each element
    !the temperature grid is shared and saved in Tpf
    !write(*,*) "Fill partition function for element ", Elements(n)%ID
    call readKurucz_pf(n, Npf, &
              Elements(n)%ptr_elem%Nstage, Elements(n)%ptr_elem%ionpot, &
              Elements(n)%ptr_elem%pf)
    !do i=1,Elements(n)%Nstage !convert from J->eV
    ! write(*,*) "Inpot for stage ", i, &
    !            Elements(n)%ionpot(i)*JOULE_TO_EV, " eV"
    !end do
    !! allocate space for futur populations of each stage
    !!allocate(Elements(n)%n(Elements(n)%Nstage, Nspace))
    !write(*,*) "Elem pop" !BEWARE of n index and Elements(n)%n
    ! there is a conflict
!     do ni=1,Nelem
!      Elements(n)%n(:,:)=0d0
!     end do

    !write(*,*) "************************************"
  end do !over elem read
  close(unit=1)

  wght_per_H = avgWeight
  avgWeight = avgWeight/totalAbund
  write(*,*) "Total Abundance in the atmosphere = ", totalAbund
  write(*,*) "Total average weight = ", avgWeight
  write(*,*) "Weight per Hydrogen = ", wght_per_H !i.e., per AMU = total mass
  write(*,*) ""

  !store also the mass fraction of each element
  do n=1, Nelem
   Elements(n)%ptr_elem%massf = Elements(n)%ptr_elem%weight*Elements(n)%ptr_elem%Abund/wght_per_H
  enddo


  return
  end subroutine fillElements

  subroutine alloc_atomic_atmos()!(Nspace)
   integer(kind=8) :: mem_alloc_local = 0

   if (allocated(T).or.(allocated(nHtot)) &
       .or.(allocated(ne))) then
    write(*,*) "An atomic atmosphere is already allocated, exiting..."
    stop
   end if

   if (.not.allocated(T)) allocate(T(n_cells))
   !!-> allocated in fill elements, as Nelem is read from file now
   !!if (.not.allocated(Elements)) allocate(Elements(Nelem))

   if (lvoronoi) then
   	write(*,*) "Velocity fields for Voronoi cells mutualised with master version!"
    !allocate(Vxyz(Nspace,3))
    !Vxyz(:,:) = 0d0
  else
    call warning("Futur deprecation of v_z, spherical vector use disntead")
    allocate(vR(n_cells)); vR = 0.0_dp
    allocate(vtheta(n_cells))
    allocate(v_z(n_cells)); v_z = 0.0_dp
    allocate(vphi(n_cells)); vphi = 0.0_dp
   end if

   Natom = 0
   Nactiveatoms = 0
   totalAbund=0
   avgWeight=0
   wght_per_H=0
   metallicity = 0. !not used yet
   Npf = 0
   calc_ne = .false.
   T(:) = 0d0
   v_char = 0d0
   B_char = 0d0

   if (.not.allocated(nHtot)) allocate(nHtot(n_cells))
   if (.not.allocated(vturb)) allocate(vturb(n_cells))
   if (.not.allocated(ne)) allocate(ne(n_cells))
   !if (.not.allocated(nHmin)) allocate(nHmin(Nspace)) temporary


   ne(:) = 0d0
   !nHmin(:) = 0d0 !temporary
   nHtot(:) = 0d0
   vturb(:) = 0d0 !m/s

   call fillElements()

!    allocate(lcompute_atomRT(Nspace))
   allocate(icompute_atomRT(n_cells))
   icompute_atomRT(:) = 0 !everything transparent at init.

    mem_alloc_local = sizeof(icompute_atomRT) * 10

	mem_alloc_tot = mem_alloc_tot + mem_alloc_local
	write(*,'("Total memory allocated in alloc_atomic_atmos:"(1ES17.8E3)" MB")') mem_alloc_local / 1024./1024.


   return
   end subroutine alloc_atomic_atmos
!
! !to do, this routine should change according to mcfost density array
!    subroutine define_atomRT_domain(itiny_T, itiny_nH)
! !    ! Set where to solve for the RT equation: where a cell is not
! !    ! transparent = where there is a significant density and temperature.
! !    ! Determines also if we have to force electron density calculation
! !    ! Might be used to tell where we solve the atomic line RT in case of a wind, magnetospheric
! !    !protoplanetary disk model.
! !    ! It is also set dark zones.
! !    ! icompute_atomRT = 0 -> transparent (rho, T <= tiny_H, tiny_T)
! !    ! icompute_atomRT = 1 -> filled (rho, T > tiny_H, tiny_T)
! !    ! icompute_atomRT = -1 -> dark (rho goes to infinity and T goes to 0)
! !     integer :: icell
!     real(kind=dp), optional :: itiny_nH, itiny_T
! !     real(kind=dp) :: Vchar=0d0, tiny_nH=1d0, tiny_T=1d2
! !     !with Very low value of densities or temperature it is possible to have
! !     !nan or infinity in the populations calculations because of numerical precisions
! !
! !     if (present(itiny_T)) then
! !      write(*,*) "changing the value of tiny_T (K) = ", tiny_T," to", itiny_T
! !      tiny_T = itiny_T !K
! !     end if
! !
! !     if (present(itiny_nH)) then
! !      write(*,*) "changing the value of tiny_nH (m^-3) = ", tiny_nH," to", itiny_nH
! !      tiny_nH = itiny_nH !m^-3
! !     end if
! !
! !     if (maxval(ne) == 0d0) calc_ne = .true.
! !
! !     if (tiny_T <= 0) then
! !      write(*,*) "changing the value of tiny_T = ", tiny_T," to", 2d2
! !      tiny_T = 2d0
! !     end if
! !     if (tiny_nH <= 0) then
! !      write(*,*) "changing the value of tiny_nH = ", tiny_nH," to", 1d0
! !      tiny_nH = 1d0
! !     end if
! !
! ! write(*,*) nHtot
! ! write(*,*) "*"
! ! write(*,*) T
! ! stop
! !     !atmos%lcompute_atomRT = (atmos%nHtot > tiny_nH) .and. (atmos%T > tiny_T)
! !     ! atmos%icompute_atomRT(:) = 0 !transparent !already init
! !     where((nHtot > tiny_nH) .and. (T > tiny_T))
! !     	icompute_atomRT = 1
! !     end where
! ! !     do icell=1,atmos%Nspace
! ! ! !      atmos%lcompute_atomRT(icell) = &
! ! ! !        (atmos%nHtot(icell) > tiny_nH) .and. (atmos%T(icell) > tiny_T)
! ! !     if ((atmos%nHtot(icell) > tiny_nH) .and. (atmos%T(icell) > tiny_T)) &
! ! !      	atmos%icompute_atomRT(icell) = 1 !filled
! ! !     end do
! !
!    return
!    end subroutine define_atomRT_domain

   subroutine alloc_magnetic_field()
   ! ----------------------------------------- !
   ! Allocate space for magnetic field
   ! ----------------------------------------- !

!    write(*,*) ""
!    call Warning("Allocate all arrays for magnetic field")
!    write(*,*) ""

!     allocate(BR(n_cells)); BR = 0.0_dp
!     allocate(Bphi(n_cells)); Bphi = 0.0_dp
!     allocate(Btheta(n_cells)); Btheta = 0.0_dp
!     allocate(B_z(n_cells)); B_z = 0.0_dp

    allocate(gammab(n_cells)); gammab = 0.0_dp
    allocate(chib(n_cells)); chib = 0.0_dp
    allocate(Bmag(n_cells)); Bmag = 0.0_dp

   return
   end subroutine alloc_magnetic_field

   function B_project_from_vc(icell, x,y,z,u,v,w, cog, sigsq, co2c, si2c) result(Bmodule)
   ! ------------------------------------------- !
   ! Using the vector component
   ! Returned the module of the magnetic field at
   ! one point of the model icell and the cosine of the angles
   ! gamma and 2*chi.
   ! Gamma is the angle between B and the los
   ! chi is the angle between Bperp and ex
   ! Bperp is the projection of B onto a plane
   ! perpendicular to the los
   !
   ! cos(gamma) = n dot B
   ! cos(2x) = cos(x)**2 - sin(x)**2
   ! sin(2x) = 2*cos(x)*sin(x)
   ! ------------------------------------------- !
    integer :: icell
    real(kind=dp) :: x, y, z, u, v, w, Bmodule
    real(kind=dp) :: bx, by, bz, r, norme, r2, norme2
    real(kind=dp) :: sig, cgb, ctb, stb
    real(kind=dp), intent(inout) :: cog, co2c, si2c, sigsq
    real :: sign

 	call error("Not implemented")

	Bmodule = sqrt(bx*bx + by*by + bz*bz)
    cog = (bx*u + by*v + bz*w) / ( Bmodule + tiny_dp )
    sig = sqrt(1.0 - cog*cog)
	sigsq = sig*sig


    co2c = ctb*ctb - stb*stb
    si2c = 2.0 * ctb * stb

    return
   end function B_project_From_vc

  function B_project_angles(icell, x,y,z,u,v,w, cog, sigsq, co2c, si2c) result(Bmodule)
   ! ------------------------------------------- !
   ! Returned the module of the magnetic field at
   ! one point of the model icell and the cosine of the angles
   ! gamma and 2*chi.
   ! Gamma is the angle between B and the los
   ! chi is the angle between Bperp and ex
   ! Bperp is the projection of B onto a plane
   ! perpendicular to the los
   !
   ! cos(gamma) = n dot B
   ! cos(2x) = cos(x)**2 - sin(x)**2
   ! sin(2x) = 2*cos(x)*sin(x)
   ! ------------------------------------------- !
    integer :: icell
    real(kind=dp) :: x, y, z, u, v, w, Bmodule
    real(kind=dp) :: bx, by, bz, b1, b2, csc_theta
    real(kind=dp) :: co_2chi, si_2chi, co_chi, si_chi, gamm
    real(kind=dp), intent(inout) :: cog, co2c, si2c, sigsq
    real :: sign

	if (Bmag(icell) == 0.0_dp) then
		Bmodule = 0.0
		cog = 0.0;co2c = 0.0;si2c = 0.0;sigsq = 0.0
		return
	endif

	gamm = gammaB(icell)


	if (lmagnetoaccr) then

		if (.not.l3d) then
			if (z < 0.0_dp) gamm = gamm + pi
			co_chi = x / sqrt(x*x+y*y)
			si_chi = y / sqrt(y*y + x*x)
			si_2chi = 2 * co_chi * si_chi
			co_2chi = (co_chi**2 - si_chi**2)
		endif
	else
		co_chi = cos(chiB(icell))
		si_chi = sin(chiB(icell))
		co_2chi = cos(2*chiB(icell))
		si_2chi = sin(2*chiB(icell))
	endif

	Bx = co_chi * sin(gamm)
	By = si_chi * sin(gamm)
	Bz = cos(gamm)

	if (abs(w) == 1.0) then
		Bmodule = Bmag(icell)
		cog = Bz
		si2c = si_2chi
		co2c = co_2chi
		sigsq = 1.0 - cog*cog
	else
		csc_theta = 1.0 / sqrt(1.0 - w*w)
		Bmodule = Bmag(icell)
    	cog = (bx*u + by*v + bz*w)
    	sigsq = 1.0 - cog*cog

		b1 = (Bz - w * cog) * csc_theta
		b2 = (v*Bx - By*u) * csc_theta


    	co2c = (b1*b1 - b2*b2) / (1.0 - cog*cog)
    	si2c = 2.0 * b1 * b2 / (1.0 - cog*cog)

    endif
! 	write(*,*) Bmodule*1e4, cog, co2c, si2c, bx, by, bz
! 	stop
    return
   end function B_project_angles


!    !!should be moved in Atom_type
!    function atomZnumber_old(atomID) result(Z)
!    --------------------------------------
!    return the atomic number of an atom
!    with ID = atomID.
!    Hydrogen is 1
!    --------------------------------------
!     character(len=ATOM_ID_WIDTH) :: atomID
!     integer :: Z, i
!
!     Z = 1
!     do i=1,Nelem
!      if (atmos%Elements(i)%ID.eq.atomID) then
!        Z = i
!        exit
!      end if
!     do while (atmos%Elements(Z)%ptr_elem%ID.ne.atomID)
!      Z=Z+1
!     end do
!
!    return
!    end function atomZnumber_old

  subroutine write_atmos_domain()
 ! ------------------------------------ !
 ! ------------------------------------ !
  use fits_utils, only : print_error
  integer :: unit, EOF = 0, blocksize, naxes(3), naxis,group, bitpix, fpixel
  logical :: extend, simple
  integer :: nelements

  !get unique unit number
  call ftgiou(unit,EOF)

  blocksize=1

  call ftinit(unit,"atomRT_domain.fits.gz",blocksize,EOF)
  !  Initialize parameters about the FITS image
  simple = .true. !Standard fits
  group = 1
  fpixel = 1
  extend = .false.
  bitpix = 64

  if (lVoronoi) then
   naxis = 1
   naxes(1) = n_cells
   nelements = naxes(1)
  else
   if (l3D) then
    naxis = 3
    naxes(1) = n_rad
    naxes(2) = 2*nz
    naxes(3) = n_az
    nelements = naxes(1) * naxes(2) * naxes(3)
   else
    naxis = 2
    naxes(1) = n_rad
    naxes(2) = nz
    nelements = naxes(1) * naxes(2)
   end if
  end if

  call ftphpr(unit,simple,bitpix,naxis,naxes,0,1,extend,EOF)
  ! Additional optional keywords
  call ftpkys(unit, "integer", "0=empty,1=filled;-1=dark", ' ', EOF)
  !write data
  call ftpprj(unit,group,fpixel,nelements,icompute_atomRT,EOF)

  call ftclos(unit, EOF)
  call ftfiou(unit, EOF)

  if (EOF > 0) call print_error(EOF)


  return
  end subroutine write_atmos_domain

 subroutine writeTemperature()
 ! ------------------------------------ !
 ! T in K
 ! ------------------------------------ !
  integer :: unit, EOF = 0, blocksize, naxes(4), naxis,group, bitpix, fpixel
  logical :: extend, simple
  integer :: nelements

  !get unique unit number
  call ftgiou(unit,EOF)

  blocksize=1
  call ftinit(unit,"Temperature.fits.gz",blocksize,EOF)
  !  Initialize parameters about the FITS image
  simple = .true. !Standard fits
  group = 1 !??
  fpixel = 1
  extend = .false. !??
  bitpix = -64

  if (lVoronoi) then
   naxis = 1
   naxes(1) = n_cells ! equivalent n_cells
   nelements = naxes(1)
  else
   if (l3D) then
    naxis = 3
    naxes(1) = n_rad
    naxes(2) = 2*nz
    naxes(3) = n_az
    nelements = naxes(1) * naxes(2) * naxes(3) ! != n_cells ? should be
   else
    naxis = 2
    naxes(1) = n_rad
    naxes(2) = nz
    nelements = naxes(1) * naxes(2) ! should be n_cells also
   end if
  end if
  ! write(*,*) 'yoyo2', n_rad, nz, n_cells, atmos%Nspace
  !  Write the required header keywords.

  call ftphpr(unit,simple,bitpix,naxis,naxes,0,1,extend,EOF)
  ! Additional optional keywords
  call ftpkys(unit, "UNIT", "K", ' ', EOF)
  !write data
  call ftpprd(unit,group,fpixel,nelements,T,EOF)

  call ftclos(unit, EOF)
  call ftfiou(unit, EOF)

  if (EOF > 0) call print_error(EOF)

 return
 end subroutine writeTemperature


	subroutine readAtmos_ascii(filename)
	! ------------------------------------------- !
	! Read from ascii file a model to be used
	! with the spherical grid of mcfost.
	! Suppose that the model read is computed on
	! a predefined grid by mcfost.
	! We never enter here if lvoronoi is TRUE
	! ------------------------------------------- !
		use getline
		use constantes
		use grid, only : cell_map
		character(len=*), intent(in)	:: filename
		real(kind=dp) Tshk!, Oi, Oo
		real(kind=dp) :: Tring, tilt!,thetai, thetao
		integer, parameter :: Nhead = 3 !Add more
		character(len=MAX_LENGTH) :: rotation_law
		integer :: icell, Nread, syst_status, N_points, k, i, j, acspot, N_fixed_ne = 0
		character(len=MAX_LENGTH) :: inputline, FormatLine, cmd
		logical :: accretion_spots
		real :: south
		real, parameter :: Lextent = 1.0!1.1
		real(kind=dp) :: rr, zz, pp!, dimension(n_cells) , V2
		real(kind=dp), dimension(:), allocatable :: B2, V2
		logical :: is_not_dark!, xit
		real(kind=dp) :: rho_to_nH, Lr, rmi, rmo, tc, phic, Vmod, Vinf

		lmagnetoaccr = .false.
		lspherical_velocity = .false.
		lVoronoi = .false.
		!read from file the velocity law if any
		call alloc_atomic_atmos()
		allocate(V2(n_cells)); V2=0.0_dp
		!For now we do not necessarily need to compute B if no polarization at all
		lmagnetized = lzeeman_polarisation !if Zeeman polarisation read magnetic field!
		if (lmagnetized) then
			write(*,*) " Allocating magnetic field array"
			call alloc_magnetic_field()
!     allocate(B2(n_cells))
    !only to read either Bz or Btheta depending on velocity law
		endif

   !change mean molecular weight in atom weight mean and mean molecular weight as mu*(1-ne/nTot) Hubeny pa 792
		rho_to_nH = 1d3 /masseH / wght_per_H!atmos%avgWeight !density kg/m3 -> nHtot m^-3
   !rho/avgWeight = Ngas total, see rutten page 143 eq 7.3
		!or use rho and for each element use the masse fraction to define its total number ?
		!should be the same as using Abund wrt to nHtot


		write(FormatLine,'("(1"A,I3")")') "A", MAX_LENGTH

   !could add header with magnetic field and so on
   !location of spots + lmagnetoaccretion flags if other kind of models with the use of spots
   ! + Tschok

		cmd = "wc -l "//trim(filename)//" > ntest.txt"
		call appel_syst(cmd,syst_status)
		open(unit=1,file="ntest.txt",status="old")
		read(1,*) N_points
		close(unit=1)
		!-2 because 2 headers lines
		write(*,*) "Found ", N_points - Nhead, " points and grid has", n_cells, " points"
		if (N_points - Nhead/= n_cells) then
			call error( "Should read a model for the exact same grid as mcfost !" )
		end if

		open(unit=1,file=filename, status="old")
		call getnextline(1, "#", FormatLine, inputline, Nread)
		read(inputline(1:Nread),*) rotation_law


		select case (rotation_law)
		case ("magneto-accretion")
			lmagnetoaccr = .true.
			write(*,*) " Velocity law is ", trim(rotation_law), lmagnetoaccr
		case ("spherical_vector")
			lspherical_velocity = .true.
			write(*,*) " Velocity law is ", trim(rotation_law), lspherical_velocity
		case ("None")
			write(*,*) " No interpolation of the velocity field", trim(rotation_law)
			write(*,*) " Profile and v_proj not modified to use that with not Voronoi grid yet"
			stop
		case default
			write(*,*) " Velocity law ", rotation_law," not handled yet"
			stop
		end select


   !read T shock and if accretion spots
		call getnextline(1, "#", FormatLine, inputline, Nread)
		read(inputline(1:Nread),*) Tshk, acspot
		accretion_spots = .false.
		if (acspot==1) accretion_spots = .true.
		laccretion_shock = accretion_spots
		Taccretion = Tshk
		if (Taccretion==0.0_dp) Taccretion = -1.0_dp
		!
		!If Tshk is <= 0, the shock temperature is computed from the mass flux onto the star.
		!However, Tshk becomes a correction factor un Tshock = abs(Tshk) * mass_flux
		!
		!now read thetao and thetai, the colatitudes of the shock on the stellar surface (roughly with numerical sim.)
		call getnextline(1, "#", FormatLine, inputline, Nread)
		read(inputline(1:Nread),*) thetai, thetao, tilt
		thetai = thetai * pi/180.
		thetao = thetao * pi/180.
		tilt = tilt * pi/180.

		do i=1, n_rad
			do j=j_start,nz !j_start = -nz in 3D
				do k=1, n_az
       				if (j==0) then !midplane
        				!icell = cell_map(i,1,k)
        				cycle
       				else
         				icell = cell_map(i,j,k)
       				end if
    				Nread = 0
    				if (lmagnetized) then

     					call getnextline(1, "#", FormatLine, inputline, Nread)

					!In case of no polarisation, but magnetic field is present in the file, it is better to
					!read the mandatory variables and put the magnetic field at the end of the file
						read(inputline(1:Nread),*) rr, zz, pp, T(icell), nHtot(icell), ne(icell), &
							vR(icell), V2(icell), Vphi(icell), vturb(icell), icompute_atomRT(icell), &
							Bmag(icell), gammab(icell), chib(icell)
         !BR(icell), B2(icell), Bphi(icell)
         !Bmag(icell), gammab(icell), chib(icell)
					else
						call getnextLine(1, "#", FormatLine, inputline, Nread)
						read(inputline(1:Nread),*) rr, zz, pp, T(icell), nHtot(icell), ne(icell), &
							vR(icell), V2(icell), vphi(icell), vturb(icell), icompute_atomRT(icell)

					end if !magnetized
				end do
			end do
		end do
		close(unit=1)

		if (lspherical_velocity) then
			vtheta(:) = V2(:)
			deallocate(V2)
!     if (lmagnetized) then
!      Btheta(:) = B2(:)
!      deallocate(B2, B_z)
!     endif
		else if (lmagnetoaccr) then
			v_z(:) = V2(:)
			deallocate(V2)
!     if (lmagnetized) then
!      B_z(:) = B2(:)
!      deallocate(B2, Btheta)
!     endif
		else!should not happen here
			call error ("Wrong velocity law (should not happen here)")
		endif

		!rho -> nH
		nHtot = nHtot * rho_to_nH

		write(*,*) "Read ", size(pack(icompute_atomRT,mask=icompute_atomRT>0)), " density zones"
		write(*,*) "Read ", size(pack(icompute_atomRT,mask=icompute_atomRT==0)), " transparent zones"
		write(*,*) "Read ", size(pack(icompute_atomRT,mask=icompute_atomRT<0)), " dark zones"

!old way of setting geometrical structures onto the stellar surface. Using stars.f90/intersect_spots and etoile(1)%SurfB
!-> future deprecation
!-> not used anymore, to be removed (kept for checking accretion spot with old routines)
		if (thetai-thetao /= 0.0) then
! 			rmi = 1d0 / sin(thetai)**2
! 			rmo = 1d0 / sin(thetao)**2
! !    if ((present(Oi)) .and. (present(Oo))) then
! !     rmi = 1d0 / sin(Oi * PI/180.)**2
! !     rmo = 1d0 / sin(Oo * PI/180.)**2
! !     thetai = Oi * PI/180.!asin(sqrt(1d0/rmi))
! !     thetao = Oo * PI/180 !asin(sqrt(1d0/rmo))
! !    else
! !     rmi = 2d0
! !     rmo = 3d0
! !     thetai = asin(sqrt(1d0/2d0))
! !     thetao = asin(sqrt(1d0/3d0))
! !    end if
! 			Lr = Ggrav * etoile(1)%M * Msun_to_kg * Msun /3.154e7  / (etoile(1)%r*au_to_m) * (1. - 2./(rmi + rmo))
!
!
! 			write(*,*) "Angles at stellar surface (deg)", thetao*rad_to_deg, thetai*rad_to_deg
! 			Tring = Lr / (4d0 * PI * (etoile(1)%r*au_to_m)**2 * sigma * abs(cos(thetai)-cos(thetao)))
! 			Tring = Tring**0.25
! 			write(*,*) " Accretion spots tilt (deg)", tilt*180./pi

! 			if (Tshk > 0) Tring = Tshk
!
!
! 			!2 is for two rings, 2Pi is dphi from 0 to 2pi / total sphere surface
! 			write(*,*) "Ring T ", Tring, "K"
! 			write(*,*) "Surface ", 100*(abs(cos(thetai)-cos(thetao))), "%" !couverte par les deux anneaux sur toute la sphere
! 			write(*,*) "Luminosity", Lr/Lsun, "Lsun"

			!Add ring
			if (accretion_spots) then
				etoile(1)%Nr = 2
				allocate(etoile(1)%SurfB(etoile(1)%Nr))
				do k=1,etoile(1)%Nr!should be 1 ring for testing
					south = 1.
					tc = tilt!0d0 * PI/180 !center of vector position
					phic = 0d0 !vector position, pointing to the center of the spot
					if (k==2) then
						south = -1. !for the ring in the southern hemisphere
						tc = tc + pi
					endif
    				etoile(1)%SurfB(k)%T = Tring
        !center of the spot
   	    			etoile(1)%SurfB(k)%r(1) = cos(phic)*sin(tc)! *cos(tilt) - sin(tc)*sin(tilt)
   	    			etoile(1)%SurfB(k)%r(2) = sin(phic)*sin(tc)
   	    			etoile(1)%SurfB(k)%r(3) = cos(tc)!south*(cos(tc) * cos(tilt) + cos(phic)*sin(tc)*sin(tilt))

					etoile(1)%SurfB(k)%mui = cos(thetai)
    				etoile(1)%SurfB(k)%muo = cos(thetao)
!     	etoile(1)%SurfB(k)%phio = 2*PI; etoile(1)%SurfB(k)%phii = 0d0
    				etoile(1)%SurfB(k)%phio = PI; etoile(1)%SurfB(k)%phii = -PI
    	!with new location of spots in intersect_spots
    	!should not change if no tilt i.e., (from 0 to 2pi)
    	!In case of a tilt we should also take into account that the half ring turns into a point as the tilt goes to 90 degrees
    				if (tilt>0) then
						etoile(1)%SurfB(k)%mui = sqrt(1. - sin(thetai)**2 * (1.0 - sin(tilt)) )
    					etoile(1)%SurfB(k)%muo = sqrt(1. - sin(thetao)**2 * (1.0 - sin(tilt)) )

					!or use the factor 1/sqrt(1 - sin(tilt)**2 * cos(phi)**2) that makes the spot circular at tilt=90
   	    				if (etoile(1)%SurfB(k)%r(3) >= 0) then
   	    					etoile(1)%SurfB(k)%phio = pi/2 * cos(tilt)**2!/ sqrt(1.0 - sin(tilt)**2)
   	    					etoile(1)%SurfB(k)%phii = -pi/2 * cos(tilt)**2
   	    				else
   	    					etoile(1)%SurfB(k)%phio = -pi/2 * cos(tilt)**2
   	    					etoile(1)%SurfB(k)%phii = pi/2 * cos(tilt)**2
   	    				endif
   	    			endif

  	  			end do
			endif !if accretion spot
		end if !thetai-thetao /= 0
!-> end future deprec

		if (lmagnetoaccr) then
			Vmod = maxval(sqrt(vR**2+v_z(:)**2+vphi(:)**2))
		else if (lspherical_velocity) then
			Vmod = maxval(sqrt(vR**2+vtheta(:)**2+vphi(:)**2))
		endif


    	v_char = v_char + Vmod


		if (lmagnetized) then
!    	if (lmagnetoaccr) then
!      B_char = maxval(sqrt(BR**2+B_z(:)**2+Bphi(:)**2))
!     else if (lspherical_velocity) then
!      B_char = maxval(sqrt(BR**2+Btheta(:)**2+Bphi(:)**2))
!     endif
			gammaB = gammaB * pi / 180.0
			chiB = chiB * pi / 180.0
			B_char = maxval(Bmag)
			write(*,*)  "Typical Magnetic field modulus (G)", B_char * 1d4


			if (B_char <= 0.0_dp) then
!    		deallocate(BR,Bphi)
!    		if (allocated(B_z)) deallocate(B_z)
!    		if (allocated(Btheta)) deallocate(Btheta)
				deallocate(Bmag, gammab,chib)
				lmagnetized = .false.
			endif
		endif


		calc_ne = .false.
		icell_loop : do icell=1,n_cells
    !check that in filled cells there is electron density otherwise we need to compute it
    !from scratch.
			if (icompute_atomRT(icell) > 0) then

   				if (ne(icell) <= 0.0_dp) then
   					write(*,*) "  ** No electron density found in the model! ** "
   					calc_ne = .true.
   					exit icell_loop
   				endif

			endif
		enddo icell_loop
		N_fixed_ne = size(pack(icompute_atomRT,mask=(icompute_atomRT==2)))
		if (N_fixed_ne > 0) then
			write(*,'("Found "(1I5)" cells with fixed electron density values! ("(1I3)" %)")') &
            N_fixed_ne, nint(real(N_fixed_ne) / real(n_cells) * 100)
		endif

	!no need if we do not the dark_zones from input file.
		call write_atmos_domain() !but for consistency with the plot functions in python


		write(*,*) "Maximum/minimum velocities in the model (km/s):"

		if (lspherical_velocity) then
			write(*,*) " Vr = ", 1d-3 * maxval(abs(vR)), 1d-3*minval(abs(vr),mask=icompute_atomRT>0)
			write(*,*) " Vtheta = ",  1d-3 * maxval(abs(vtheta)), 1d-3*minval(abs(vtheta),mask=icompute_atomRT>0)
		else if (lmagnetoaccr) then
			write(*,*) " VRz = ", 1d-3 * maxval(sqrt(VR(:)**2 + v_z(:)**2)), 1d-3*minval(sqrt(VR(:)**2 + v_z(:)**2),mask=icompute_atomRT>0)
			write(*,*) " VR = ", 1d-3 * maxval(abs(vR)), 1d-3*minval(abs(vR),mask=icompute_atomRT>0)
			write(*,*) " v_z = ",  1d-3 * maxval(abs(v_z)), 1d-3*minval(abs(v_z),mask=icompute_atomRT>0)
		endif
		write(*,*) " Vphi = ",  1d-3 * maxval(abs(vphi)), 1d-3*minval(abs(vphi),mask=icompute_atomRT>0)


		write(*,*) "Typical line extent due to V fields (km/s):"
		v_char = Lextent * v_char
		write(*,*) v_char/1d3

		write(*,*) "Maximum/minimum turbulent velocity (km/s):"
		write(*,*) maxval(vturb)/1d3, minval(vturb, mask=icompute_atomRT>0)/1d3

		write(*,*) "Maximum/minimum Temperature in the model (K):"
		write(*,*) MAXVAL(T), MINVAL(T,mask=icompute_atomRT>0)
		write(*,*) "Maximum/minimum Hydrogen total density in the model (m^-3):"
		write(*,*) MAXVAL(nHtot), MINVAL(nHtot,mask=icompute_atomRT>0)
		if (.not.calc_ne) then
			write(*,*) "Maximum/minimum ne density in the model (m^-3):"
			write(*,*) MAXVAL(ne), MINVAL(ne,mask=icompute_atomRT>0)
		endif

		return
	end subroutine readAtmos_ascii

!   subroutine shock_surface(shock_area)
!   	!identify the cell close to the choc and sum their area.
!   	real(kind=dp), intent(out) :: shock_area
!
!   return
!   end subroutine


  !building
  subroutine refine_healpix_sphere()
	use grid, only				: test_exit_grid, cross_cell, pos_em_cellule, move_to_grid
	use stars, only				: intersect_stars
	use cylindrical_grid, only	: r_grid, z_grid, phi_grid, area
	use spherical_grid, only	: solid_angle_cell_sph
  !given a base resolution healpix_lorder, refine each pixel according
  !to a given criterion up to healpix_lmax.
  !criterion is dOmega(icell) / dOmega_healpix <= Nr_min, with
  !dOmega(icell) the solid angle at which a cell is seen from a point source at r,
  !dOmega_healpix the solid angle subtended by each healpix pixels and Nr_min;
  !the minimum number of rays that has to pass in each cell.

  	integer, parameter :: Nr_min = 5
  	real(kind=dp) :: cm_lim =  1d2 !column density limit
  	integer :: icell, ipix, i_star, icell_star, icell_prev, next_cell, previous_cell
  	integer :: nbr_cell
  	logical, allocatable, dimension(:) :: mask
  	real(kind=dp) :: x0, y0, z0, cm, x,y,a,u,v,w, x1, y1, z1
  	real(kind=dp) :: ls, l_contrib, l_void_before, nH_to_rho
  	logical :: lintersect_stars , lcellule_non_vide
  	real(kind=dp) :: dOmega, wphi, dOmega_l

  	!we have to do it iteratively to be sure that most cells are seen from ezch cell
  	!which is not the case with the starting low resolution.
  	!Otherwise the problem is straightforward.


	nH_to_rho = 1-3 * masseH * wght_per_H
  !first init arrays for nested algorithm
  	call init_pix2xy_and_xy2pix

  	!Init healpix max for each cell that have density.

  	allocate(mask(n_cells))
!   	mask = .false.
  	mask = (icompute_atomRT > 0)
  	call init_healpix_map(healpix_lorder,mask) !deallocated at the end of non-LTE loop
  	deallocate(mask)

  	!each pixel in base reoslution in healpix_map(icell)%p(:) will be refined up to
  	!lmax, in healpix_map(icell)%l(:)
  	!The actual pixels and angles associated are computed locally at the moment.

  	!for each cell propagates
  	!OMP directive here
!   	do icell = 1, n_cells
!   		if (icompute_atomRT(icell) > 0) then
! 			x = r_grid(icell) * cos(phi_grid(icell))
! 			y = r_grid(icell) * sin(phi_grid(icell))
! 			z = z_grid(icell)
!
! 			do ipix=0, healpix_npix(healpix_lorder)-1
!
! 				healpix_pix_heirs_new
!
! 				ipix_start = 0
! 				ipix_end = healpix_npix(healpix_lorder)-1
!
! 			do ipix=ipix_start, ipix_end
!
! 				call healpix_nested_mu_and_phi(l, ipix, w, wphi)
!
! 				!condition to increase l by 1 is:
! 				! dOmega / dOmega_l > Nr_min
! 				!dOmega * 3 * 4**l / pi > Nr_min
!
!   				cm = 0.0
!
! 				call intersect_stars(x,y,z, u,v,w, lintersect_stars, i_star, icell_star)
!
!   ! Boucle infinie sur les cellules
! 		infinie : do ! Boucle infinie
!     ! Indice de la cellule
!     		icell_prev = icell !duplicate with previous_cell, but this avoid problem with Voronoi grid here
! 			icell = next_cell
! 			x0=x1 ; y0=y1 ; z0=z1
!     !write(*,*) "Boucle infinie, icell=", icell
!
! 			if (icell <= n_cells) then
! 				lcellule_non_vide = (icompute_atomRT(icell) > 0)
! 				if (icompute_atomRT(icell) < 0) return !-1 if dark
! 			else
! 				lcellule_non_vide=.false.
! 			endif
!
!     ! Test sortie ! "The ray has reach the end of the grid"
!
! 			if (test_exit_grid(icell, x0, y0, z0)) return
!
! 			if (lintersect_stars) then
! 				if (icell == icell_star) then
!        				return
!       			end if
!    			 endif
!
! 			nbr_cell = nbr_cell + 1
!
!     ! Calcul longeur de vol et profondeur optique dans la cellule
! 			previous_cell = 0 ! unused, just for Voronoi
! 			call cross_cell(x0,y0,z0, u,v,w,  icell, previous_cell, x1,y1,z1, next_cell,ls, l_contrib, l_void_before)
!
!     !count opacity only if the cell is filled, else go to next cell
! 			if (lcellule_non_vide) then
!
!
! 			!integrate column density in that direction
! 			cm = cm + nH_to_rho * nHtot(icell) * l_contrib
! ! 				if (cm) > cm_lim) then
! ! 					return
! ! 				endif
!
!
! 			end if  ! lcellule_non_vide
! 		end do infinie
!
!
! 			enddo
!
!   		endif
!   	enddo
!



  return
  end subroutine refine_healpix_sphere

  !few healpix routines, moved to healpix_mod.f90

!   function largest_integer_smaller_than_x(x)
!   	real(kind=dp), intent(in) :: x
!   	integer(kind=8) largest_integer_smaller_than_x
!
!   	largest_integer_smaller_than_x = int(ceiling(x)) - 1
!
!   	return
!   end function largest_integer_smaller_than_x
!
!   function healpix_children_nested_index(pix)
!   	!given the index of the parent pixel pix
!   	!computes the 4 children pixel indexes
!   	integer, parameter :: n_children = 4
!   	integer, intent(in) :: pix
!   	integer, dimension(n_children) :: healpix_children_nested_index
!   	integer :: n
!
!   	do n=0,n_children-1
!   		healpix_children_nested_index(n+1) = 4*pix + n
!   	enddo
!
!   	return
!   end function healpix_children_nested_index
!
!   function healpix_parent_nested_index(m)
!   	integer, intent(in) :: m
!   	integer :: healpix_parent_nested_index
!
!   	!m=0,1,2,3 have the same parent
!   	!m=4,5,6,7 have the same parent...
!   	healpix_parent_nested_index = int(real(m)/4.0)
!
!   	return
!   end function healpix_parent_nested_index
!
!   function healpix_npix(l)
!   	integer, intent(in) :: l
!   	integer(kind=8) :: healpix_npix
!
!   	!Npix = 12 * Nside**2
!   	!with Nside = 2**l, the resolution of the grid
!   	healpix_npix = 12 * 4**l
!
!   	return
!   end function healpix_npix
!
!   function healpix_weight(l)
!   	integer, intent(in) :: l
!   	real(kind=dp) :: healpix_weight
!
!   	!weight = area/4pi
!   	!area is 4pi / Npix
!   	!Npix = 12 * Nside**2
!   	!Nside = 2**l
!   	!area = pi/3/Nside/Nside = pi/3/4**l
!   	!weight = (pi/3)/(4pi)/4**l
!   	!weight = (1./12.)/4**l
!   	healpix_weight = (1.0/12.0) / real(4**l,kind=dp)
!
!   	return
!   end function healpix_weight
!
!   function healpix_angular_resolution(l)
!   	!in degrees
!   	integer, intent(in) :: l
!   	real(kind=dp) :: healpix_angular_resolution
!
!   	!4pi * healpix_weight is actually the solid angle it's the "square" resolution
!   	!healpix_angular_resolution = 180.0 * sqrt( 4.0 * pi * healpix_weight(l) )/ pi
! 	healpix_angular_resolution = 180.0 * sqrt(pi/real(3*4**l)) / pi
!
! 	return
!   end function healpix_angular_resolution
!     	  !lshift, rshift
!
!   subroutine healpix_mu_and_phi(l, pix, mu, phi)
!   	integer, intent(in) :: l, pix
!   	integer :: p, i, j, pp
!   	real(kind=dp), intent(out) :: mu, phi !cos(theta) and azimuth from the north pole
!   	integer(kind=8) :: Npix, Nside, North_cap
!   	real(kind=dp) :: four_on_Npix, ph, fodd, s
!
!   	Npix = healpix_npix(l)
!   	Nside = 2**l
!   	North_cap = 2 * Nside * (Nside-1)
!
!   	!C index
!   	p = pix - 1
!
!   	!better to do that out of the subroutine if called many times
!   	!if pix in a do loop (do pix=1,Npix) should never happen
!   	if (pix > Npix) then
!   		write(*,*) pix, Npix, l
!   		call error("(Healpix_mu_and_phi) pixel index larger than Npix")
!   	endif
!
!   	four_on_Npix = 4.0 / real(Npix)
!
!   	if (p < North_cap) then !north
!   		ph = 0.5 * real(1 + p)
!
!   		! i = largest_integer_small_than_x(ph)
!   		i = rshift(int(1 + floor(sqrt(real(1+2*p)))),1)
!
! 		j = (p+1) - 2 * i * (i-1)
!
! 		mu = 1.0 - real(i*i) * four_on_Npix
! 		phi = (real(j) - 0.5) * 0.5 * pi / real(i)
!
! 	elseif (p < (Npix - North_cap)) then !equator
! 		pp = p - North_cap
! 		i = pp/(4*Nside) + Nside !integer
! 		j = mod(pp,4*Nside) + 1
!
! 		!1 if i+Nside odd, 0.5 otherwise
! 		if (mod(i+Nside,2)==0) then
! 			fodd = 0.5
! 		else !odd
! 			fodd = 1.0
! 		endif
! 		s = 0.5 * mod(i-Nside+1,2)
! 		!fodd = s, should give the same result
!
! 		!!see, it is simply 4/3
! 		!!(2*Nside * 4.0 / Npix ) * (Nside <<1) = 4/3 whatever Nside
! 		!!(4/Npix) * (Nside << 1) = 2/3/Nside whatever Nside
! 		!mu = four_on_Npix * real( ( 2 * Nside - i) * lshift(Nside,1) )
! 		mu = 4.0 / 3.0 - 2.0 * real(i) / real(3*Nside)
! 		phi = (real(j) - fodd) * pi / real(2 * Nside)
!
! 	else !south
! 		pp = Npix - p
! 		i = rshift(int(1 + floor(sqrt(real(2*pp-1)))),1)
! 		j = 4 * i + 1 - (pp - 2*i*(i-1))
!
! 		mu = -1.0 + real(i*i) * four_on_Npix
! 		phi = (real(j) - 0.5) * 0.5 * pi / real(i)
!
! 	endif
!
!   	return
!   end subroutine healpix_mu_and_phi
!
!   subroutine healpix_sphere(l,mu,phi)
!   	integer, intent(in) :: l
!   	real(kind=dp), dimension(12*4**l), intent(out) :: mu, phi
!   	integer :: pix
!
!   	mu(:) = 0.0_dp
!   	phi(:) = 0.0_dp
!
!   	do pix=1,healpix_npix(l)
!
!   		call healpix_mu_and_phi(l,pix,mu(pix),phi(pix))
!
!   	enddo
!
!   	return
!   end subroutine healpix_sphere


!! Futur deprecation
!
!   subroutine writeAtmos_ascii()
!   ! ------------------------------------- !
!    ! Write GridType atmos to ascii file.
!    ! ultimately this model will be mapped
!    ! onto a Voronoi mesh.
!   ! ------------------------------------- !
!    use grid
!    character(len=10)	:: filename="model.s"
!    integer :: icell, i, j, k
!    real(kind=dp), dimension(n_cells) :: XX, YY, ZZ
!    real(kind=dp) :: r, rcyl, phi, z, sinTheta, rho_to_nH, fact
!    real(kind=dp) :: dx, dy, dz, smooth_scale
!
!    rho_to_nH = 1d0 / AMU /atmos%avgWeight
!
!    if (n_az <= 1) then
!     write(*,*) "Error, in this case, lmagnetoaccr is false, and", &
!     	' n_az > 1'
!     stop
!    end if
!    !X, Y, Z cartesian coordinates
!    do i=1, n_rad
!     do j=j_start,nz
!      do k=1, n_az
!       if (j==0) then !midplane
!         icell = cell_map(i,1,k)
!         rcyl = r_grid(icell) !AU
!         z = 0.0_dp
!       else
!        icell = cell_map(i,j,k)
!        rcyl = r_grid(icell)
!        z = z_grid(icell)/z_scaling_env
!       end if
!       phi = phi_grid(icell)
!       r = sqrt(z**2 + rcyl**2)
!       fact = 1d0
!       if (z<0) fact = -1
!       sinTheta = fact*sqrt(1.-(z/r)**2)
!       !XX(icell) = rcyl*cos(phi)*AU_to_m!r*cos(phi)*sinTheta * AU_to_m
!       !YY(icell) = rcyl*sin(phi)*AU_to_m!r*sin(phi)*sinTheta * AU_to_m
!        XX(icell) = r*cos(phi)*sinTheta * AU_to_m
!        YY(icell) = r*sin(phi)*sinTheta * AU_to_m
!        ZZ(icell) = z*AU_to_m
!      end do
!     end do
!    end do
!
!    if (lstatic) then
!     allocate(atmos%Vxyz(n_cells,3))
!     atmos%Vxyz = 0d0
!    end if
!
!    open(unit=1,file=trim(filename),status="replace")
!    atmos%nHtot = atmos%nHtot / rho_to_nH !using total density instead of nHtot for writing
!    !write Masses per cell instead of densities. Voronoi cells Volume is different than
!    !grid cell right ?
!    write(*,*) "Maximum/minimum density in the model (kg/m^3):"
!    write(*,*) maxval(atmos%nHtot), minval(atmos%nHtot,mask=atmos%icompute_atomRT>0)
!    atmos%nHtot = atmos%nHtot * volume * AU3_to_m3  * kg_to_Msun!Msun
!    do icell=1, atmos%Nspace
!      dx = XX(icell) - etoile(1)%x*AU_to_m
!      dy = YY(icell) - etoile(1)%y*AU_to_m
!      dz = ZZ(icell) - etoile(1)%z*AU_to_m
!      smooth_scale = 5. * Rmax * AU_to_m
!      if (min(dx,dy,dz) < 2*etoile(1)%r*AU_to_m) then
!       if ((dx**2+dy**2+dz**2) < (2*etoile(1)%r*AU_to_m)**2) then
!          smooth_scale = sqrt(dx**2+dy**2+dz**2)/3. * AU_to_m
!          !=etoile(1)%r*AU_to_m!etoile(1)%r/3. * AU_to_m!m
!       end if
!      end if
!         write(1,"(8E6.3)") XX(icell), YY(icell), ZZ(icell), atmos%nHtot(icell), &
!     	 atmos%Vxyz(icell,1), atmos%Vxyz(icell,2), atmos%Vxyz(icell,3), smooth_scale
!    end do
!    write(*,*) "Maximum/minimum mass in the model (Msun):"
!    write(*,*) maxval(atmos%nHtot), minval(atmos%nHtot,mask=atmos%icompute_atomRT>0)
!    write(*,*) "Maximum/minimum mass in the model (Kg):"
!    write(*,*) maxval(atmos%nHtot)*Msun_to_kg, &
!    				minval(atmos%nHtot,mask=atmos%icompute_atomRT>0)*Msun_to_kg
!    write(*,*) "Maximum/minimum velocities in the model (km/s):"
!    write(*,*) maxval(sqrt(sum(atmos%Vxyz**2,dim=2)), dim=1)*1d-3,  &
!      		  minval(sqrt(sum(atmos%Vxyz**2,dim=2)), dim=1,&
!      		  mask=sum(atmos%Vxyz**2,dim=2)>0)*1d-3
!    close(unit=1)
!
!   return
!   end subroutine writeAtmos_ascii

end module atmos_type

!   subroutine compute_anglequad_centres()
!
! ! 	if (icentres==5) then
! !
! ! 		Ncentre = 5
! ! 		allocate(frac_pos(Ncentre, 3)); frac_pos(:,:) = 0.0
! ! 	!-> Sobol
! ! 		frac_pos(:,1) = (/ 0.5  , 0.75 , 0.25 , 0.375, 0.875 /)
! ! 		frac_pos(:,2) = (/ 0.5  , 0.25 , 0.75 , 0.375, 0.875 /)
! ! 		frac_pos(:,3) = (/ 0.5  , 0.75 , 0.25 , 0.625, 0.125 /)
! ! 	else
! 	if (icentres==10) then
!
! 		Ncentre = 10
! 		allocate(frac_pos(Ncentre, 3)); frac_pos(:,:) = 0.0_dp
!
! 	!-> halton
! 		frac_pos(:,1) = (/ 0.375 , 0.875 , 0.0625 , 0.5625 , 0.3125 ,0.8125 , 0.1875 , 0.6875 , 0.4375 , 0.9375 /)
! 		frac_pos(:,2) = (/ 0.22222222, 0.55555556, 0.88888889, 0.03703704, 0.37037037,0.7037037 , 0.14814815, 0.48148148, 0.81481481, 0.25925926 /)
! 		frac_pos(:,3) = (/ 0.24, 0.44, 0.64, 0.84, 0.08 ,0.28 , 0.48, 0.68  , 0.88 , 0.12 /)
! 	!-> Sobol
! ! 		frac_pos(:,1) = (/ 0.5   , 0.75  , 0.25  , 0.375 , 0.875 , 0.625 , 0.125 , 0.1875, 0.6875, 0.9375 /)
! ! 		frac_pos(:,2) = (/ 0.5   , 0.25  , 0.75  , 0.375 , 0.875 , 0.125 , 0.625 , 0.3125, 0.8125, 0.0625 /)
! ! 		frac_pos(:,3) = (/ 0.5   , 0.75  , 0.25  , 0.625 , 0.125 , 0.375 , 0.875 , 0.3125, 0.8125, 0.5625 /)
!
! 	else if (icentres==50) then
! 		Ncentre = 50
! 		allocate(frac_pos(Ncentre, 3)); frac_pos(:,:) = 0.0_dp
!
! 	!-> Halton
! 		frac_pos(:,1) = (/ 0.375   , 0.875   , 0.0625  , 0.5625  , 0.3125  , 0.8125  ,&
!        0.1875  , 0.6875  , 0.4375  , 0.9375  , 0.03125 , 0.53125 ,&
!        0.28125 , 0.78125 , 0.15625 , 0.65625 , 0.40625 , 0.90625 ,&
!        0.09375 , 0.59375 , 0.34375 , 0.84375 , 0.21875 , 0.71875 ,&
!        0.46875 , 0.96875 , 0.015625, 0.515625, 0.265625, 0.765625,&
!        0.140625, 0.640625, 0.390625, 0.890625, 0.078125, 0.578125,&
!        0.328125, 0.828125, 0.203125, 0.703125, 0.453125, 0.953125,&
!        0.046875, 0.546875, 0.296875, 0.796875, 0.171875, 0.671875,&
!        0.421875, 0.921875 /)
! 		frac_pos(:,2) = (/ 0.22222222, 0.55555556, 0.88888889, 0.03703704, 0.37037037,&
!        0.7037037 , 0.14814815, 0.48148148, 0.81481481, 0.25925926,&
!        0.59259259, 0.92592593, 0.07407407, 0.40740741, 0.74074074,&
!        0.18518519, 0.51851852, 0.85185185, 0.2962963 , 0.62962963,&
!        0.96296296, 0.01234568, 0.34567901, 0.67901235, 0.12345679,&
!        0.45679012, 0.79012346, 0.2345679 , 0.56790123, 0.90123457,&
!        0.04938272, 0.38271605, 0.71604938, 0.16049383, 0.49382716,&
!        0.82716049, 0.27160494, 0.60493827, 0.9382716 , 0.08641975,&
!        0.41975309, 0.75308642, 0.19753086, 0.5308642 , 0.86419753,&
!        0.30864198, 0.64197531, 0.97530864, 0.02469136, 0.35802469 /)
! 		frac_pos(:,3) = (/ 0.24 , 0.44 , 0.64 , 0.84 , 0.08 , 0.28 , 0.48 , 0.68 , 0.88 ,&
!        0.12 , 0.32 , 0.52 , 0.72 , 0.92 , 0.16 , 0.36 , 0.56 , 0.76 ,&
!        0.96 , 0.008, 0.208, 0.408, 0.608, 0.808, 0.048, 0.248, 0.448,&
!        0.648, 0.848, 0.088, 0.288, 0.488, 0.688, 0.888, 0.128, 0.328,&
!        0.528, 0.728, 0.928, 0.168, 0.368, 0.568, 0.768, 0.968, 0.016,&
!        0.216, 0.416, 0.616, 0.816, 0.056 /)
!
! 	!-> Sobol
! ! 		frac_pos(:,1) = (/ 0.5     , 0.75    , 0.25    , 0.375   , 0.875   , 0.625   ,&
! !        0.125   , 0.1875  , 0.6875  , 0.9375  , 0.4375  , 0.3125  ,&
! !        0.8125  , 0.5625  , 0.0625  , 0.09375 , 0.59375 , 0.84375 ,&
! !        0.34375 , 0.46875 , 0.96875 , 0.71875 , 0.21875 , 0.15625 ,&
! !        0.65625 , 0.90625 , 0.40625 , 0.28125 , 0.78125 , 0.53125 ,&
! !        0.03125 , 0.046875, 0.546875, 0.796875, 0.296875, 0.421875,&
! !        0.921875, 0.671875, 0.171875, 0.234375, 0.734375, 0.984375,&
! !        0.484375, 0.359375, 0.859375, 0.609375, 0.109375, 0.078125,&
! !        0.578125, 0.828125 /)
! !
! ! 		frac_pos(:,2) = (/ 0.5     , 0.25    , 0.75    , 0.375   , 0.875   , 0.125   ,&
! !        0.625   , 0.3125  , 0.8125  , 0.0625  , 0.5625  , 0.1875  ,&
! !        0.6875  , 0.4375  , 0.9375  , 0.46875 , 0.96875 , 0.21875 ,&
! !        0.71875 , 0.09375 , 0.59375 , 0.34375 , 0.84375 , 0.15625 ,&
! !        0.65625 , 0.40625 , 0.90625 , 0.28125 , 0.78125 , 0.03125 ,&
! !        0.53125 , 0.265625, 0.765625, 0.015625, 0.515625, 0.140625,&
! !        0.640625, 0.390625, 0.890625, 0.078125, 0.578125, 0.328125,&
! !        0.828125, 0.453125, 0.953125, 0.203125, 0.703125, 0.234375,&
! !        0.734375, 0.484375 /)
! !
! ! 		frac_pos(:,3) = (/ 0.5     , 0.75    , 0.25    , 0.625   , 0.125   , 0.375   ,&
! !        0.875   , 0.3125  , 0.8125  , 0.5625  , 0.0625  , 0.9375  ,&
! !        0.4375  , 0.1875  , 0.6875  , 0.84375 , 0.34375 , 0.09375 ,&
! !        0.59375 , 0.46875 , 0.96875 , 0.71875 , 0.21875 , 0.53125 ,&
! !        0.03125 , 0.28125 , 0.78125 , 0.15625 , 0.65625 , 0.90625 ,&
! !        0.40625 , 0.609375, 0.109375, 0.359375, 0.859375, 0.234375,&
! !        0.734375, 0.984375, 0.484375, 0.796875, 0.296875, 0.046875,&
! !        0.546875, 0.421875, 0.921875, 0.671875, 0.171875, 0.265625,&
! !        0.765625, 0.515625 /)
!
! 	else if (icentres==100) then
!
! 		Ncentre = 100
! 		allocate(frac_pos(Ncentre, 3)); frac_pos(:,:) = 0.0_dp
!
! 	!halton
! 		frac_pos(:,1) = (/ 0.375    , 0.875    , 0.0625   , 0.5625   , 0.3125   , 0.8125,&
!        0.1875   , 0.6875   , 0.4375   , 0.9375   , 0.03125  , 0.53125  ,&
!        0.28125  , 0.78125  , 0.15625  , 0.65625  , 0.40625  , 0.90625  ,&
!        0.09375  , 0.59375  , 0.34375  , 0.84375  , 0.21875  , 0.71875  ,&
!        0.46875  , 0.96875  , 0.015625 , 0.515625 , 0.265625 , 0.765625 ,&
!        0.140625 , 0.640625 , 0.390625 , 0.890625 , 0.078125 , 0.578125 ,&
!        0.328125 , 0.828125 , 0.203125 , 0.703125 , 0.453125 , 0.953125 ,&
!        0.046875 , 0.546875 , 0.296875 , 0.796875 , 0.171875 , 0.671875 ,&
!        0.421875 , 0.921875 , 0.109375 , 0.609375 , 0.359375 , 0.859375 ,&
!        0.234375 , 0.734375 , 0.484375 , 0.984375 , 0.0078125, 0.5078125,&
!        0.2578125, 0.7578125, 0.1328125, 0.6328125, 0.3828125, 0.8828125,&
!        0.0703125, 0.5703125, 0.3203125, 0.8203125, 0.1953125, 0.6953125,&
!        0.4453125, 0.9453125, 0.0390625, 0.5390625, 0.2890625, 0.7890625,&
!        0.1640625, 0.6640625, 0.4140625, 0.9140625, 0.1015625, 0.6015625,&
!        0.3515625, 0.8515625, 0.2265625, 0.7265625, 0.4765625, 0.9765625,&
!        0.0234375, 0.5234375, 0.2734375, 0.7734375, 0.1484375, 0.6484375,&
!        0.3984375, 0.8984375, 0.0859375, 0.5859375 /)
!
! 		frac_pos(:,2) = (/ 0.22222222, 0.55555556, 0.88888889, 0.03703704, 0.37037037,&
!        0.7037037 , 0.14814815, 0.48148148, 0.81481481, 0.25925926,&
!        0.59259259, 0.92592593, 0.07407407, 0.40740741, 0.74074074,&
!        0.18518519, 0.51851852, 0.85185185, 0.2962963 , 0.62962963,&
!        0.96296296, 0.01234568, 0.34567901, 0.67901235, 0.12345679,&
!        0.45679012, 0.79012346, 0.2345679 , 0.56790123, 0.90123457,&
!        0.04938272, 0.38271605, 0.71604938, 0.16049383, 0.49382716,&
!        0.82716049, 0.27160494, 0.60493827, 0.9382716 , 0.08641975,&
!        0.41975309, 0.75308642, 0.19753086, 0.5308642 , 0.86419753,&
!        0.30864198, 0.64197531, 0.97530864, 0.02469136, 0.35802469,&
!        0.69135802, 0.13580247, 0.4691358 , 0.80246914, 0.24691358,&
!        0.58024691, 0.91358025, 0.0617284 , 0.39506173, 0.72839506,&
!        0.17283951, 0.50617284, 0.83950617, 0.28395062, 0.61728395,&
!        0.95061728, 0.09876543, 0.43209877, 0.7654321 , 0.20987654,&
!        0.54320988, 0.87654321, 0.32098765, 0.65432099, 0.98765432,&
!        0.00411523, 0.33744856, 0.67078189, 0.11522634, 0.44855967,&
!        0.781893  , 0.22633745, 0.55967078, 0.89300412, 0.04115226,&
!        0.3744856 , 0.70781893, 0.15226337, 0.48559671, 0.81893004,&
!        0.26337449, 0.59670782, 0.93004115, 0.0781893 , 0.41152263,&
!        0.74485597, 0.18930041, 0.52263374, 0.85596708, 0.30041152 /)
!
! 		frac_pos(:,3) = (/ 0.24 , 0.44 , 0.64 , 0.84 , 0.08 , 0.28 , 0.48 , 0.68 , 0.88 ,&
!        0.12 , 0.32 , 0.52 , 0.72 , 0.92 , 0.16 , 0.36 , 0.56 , 0.76 ,&
!        0.96 , 0.008, 0.208, 0.408, 0.608, 0.808, 0.048, 0.248, 0.448,&
!        0.648, 0.848, 0.088, 0.288, 0.488, 0.688, 0.888, 0.128, 0.328,&
!        0.528, 0.728, 0.928, 0.168, 0.368, 0.568, 0.768, 0.968, 0.016,&
!        0.216, 0.416, 0.616, 0.816, 0.056, 0.256, 0.456, 0.656, 0.856,&
!        0.096, 0.296, 0.496, 0.696, 0.896, 0.136, 0.336, 0.536, 0.736,&
!        0.936, 0.176, 0.376, 0.576, 0.776, 0.976, 0.024, 0.224, 0.424,&
!        0.624, 0.824, 0.064, 0.264, 0.464, 0.664, 0.864, 0.104, 0.304,&
!        0.504, 0.704, 0.904, 0.144, 0.344, 0.544, 0.744, 0.944, 0.184,&
!        0.384, 0.584, 0.784, 0.984, 0.032, 0.232, 0.432, 0.632, 0.832,&
!        0.072 /)
!
! ! 	-> Sobol
! ! 		frac_pos(:,1) = (/ 0.5      , 0.75     , 0.25     , 0.375    , 0.875    , 0.625    ,&
! !        	0.125    , 0.1875   , 0.6875   , 0.9375   , 0.4375   , 0.3125   ,&
! !        	0.8125   , 0.5625   , 0.0625   , 0.09375  , 0.59375  , 0.84375  ,&
! !        	0.34375  , 0.46875  , 0.96875  , 0.71875  , 0.21875  , 0.15625  ,&
! !        	0.65625  , 0.90625  , 0.40625  , 0.28125  , 0.78125  , 0.53125  ,&
! !        	0.03125  , 0.046875 , 0.546875 , 0.796875 , 0.296875 , 0.421875 ,&
! !        	0.921875 , 0.671875 , 0.171875 , 0.234375 , 0.734375 , 0.984375 ,&
! !        	0.484375 , 0.359375 , 0.859375 , 0.609375 , 0.109375 , 0.078125 ,&
! !        	0.578125 , 0.828125 , 0.328125 , 0.453125 , 0.953125 , 0.703125 ,&
! !        	0.203125 , 0.140625 , 0.640625 , 0.890625 , 0.390625 , 0.265625 ,&
! !        	0.765625 , 0.515625 , 0.015625 , 0.0234375, 0.5234375, 0.7734375,&
! !        	0.2734375, 0.3984375, 0.8984375, 0.6484375, 0.1484375, 0.2109375,&
! !        	0.7109375, 0.9609375, 0.4609375, 0.3359375, 0.8359375, 0.5859375,&
! !        	0.0859375, 0.1171875, 0.6171875, 0.8671875, 0.3671875, 0.4921875,&
! !        	0.9921875, 0.7421875, 0.2421875, 0.1796875, 0.6796875, 0.9296875,&
! !        	0.4296875, 0.3046875, 0.8046875, 0.5546875, 0.0546875, 0.0390625,&
! !        	0.5390625, 0.7890625, 0.2890625, 0.4140625 /)
! !
! !     	frac_pos(:,2) = (/ 0.5      , 0.25     , 0.75     , 0.375    , 0.875    , 0.125    ,&
! !        	0.625    , 0.3125   , 0.8125   , 0.0625   , 0.5625   , 0.1875   ,&
! !        	0.6875   , 0.4375   , 0.9375   , 0.46875  , 0.96875  , 0.21875  ,&
! !        	0.71875  , 0.09375  , 0.59375  , 0.34375  , 0.84375  , 0.15625  ,&
! !        	0.65625  , 0.40625  , 0.90625  , 0.28125  , 0.78125  , 0.03125  ,&
! !        	0.53125  , 0.265625 , 0.765625 , 0.015625 , 0.515625 , 0.140625 ,&
! !        	0.640625 , 0.390625 , 0.890625 , 0.078125 , 0.578125 , 0.328125 ,&
! !        	0.828125 , 0.453125 , 0.953125 , 0.203125 , 0.703125 , 0.234375 ,&
! !        	0.734375 , 0.484375 , 0.984375 , 0.359375 , 0.859375 , 0.109375 ,&
! !        	0.609375 , 0.421875 , 0.921875 , 0.171875 , 0.671875 , 0.046875 ,&
! !        	0.546875 , 0.296875 , 0.796875 , 0.3984375, 0.8984375, 0.1484375,&
! !        	0.6484375, 0.0234375, 0.5234375, 0.2734375, 0.7734375, 0.2109375,&
! !        	0.7109375, 0.4609375, 0.9609375, 0.3359375, 0.8359375, 0.0859375,&
! !        	0.5859375, 0.1171875, 0.6171875, 0.3671875, 0.8671875, 0.4921875,&
! !        	0.9921875, 0.2421875, 0.7421875, 0.3046875, 0.8046875, 0.0546875,&
! !        	0.5546875, 0.1796875, 0.6796875, 0.4296875, 0.9296875, 0.1328125,&
! !        	0.6328125, 0.3828125, 0.8828125, 0.2578125 /)
! !
! !     	frac_pos(:,3) = (/ 0.5      , 0.75     , 0.25     , 0.625    , 0.125    , 0.375    ,&
! !        	0.875    , 0.3125   , 0.8125   , 0.5625   , 0.0625   , 0.9375   ,&
! !        	0.4375   , 0.1875   , 0.6875   , 0.84375  , 0.34375  , 0.09375  ,&
! !        	0.59375  , 0.46875  , 0.96875  , 0.71875  , 0.21875  , 0.53125  ,&
! !        	0.03125  , 0.28125  , 0.78125  , 0.15625  , 0.65625  , 0.90625  ,&
! !        	0.40625  , 0.609375 , 0.109375 , 0.359375 , 0.859375 , 0.234375 ,&
! !        	0.734375 , 0.984375 , 0.484375 , 0.796875 , 0.296875 , 0.046875 ,&
! !        	0.546875 , 0.421875 , 0.921875 , 0.671875 , 0.171875 , 0.265625 ,&
! !        	0.765625 , 0.515625 , 0.015625 , 0.890625 , 0.390625 , 0.140625 ,&
! !        	0.640625 , 0.078125 , 0.578125 , 0.828125 , 0.328125 , 0.703125 ,&
! !        	0.203125 , 0.453125 , 0.953125 , 0.4453125, 0.9453125, 0.6953125,&
! !        	0.1953125, 0.8203125, 0.3203125, 0.0703125, 0.5703125, 0.1328125,&
! !        	0.6328125, 0.8828125, 0.3828125, 0.5078125, 0.0078125, 0.2578125,&
! !        	0.7578125, 0.6640625, 0.1640625, 0.4140625, 0.9140625, 0.0390625,&
! !        	0.5390625, 0.7890625, 0.2890625, 0.9765625, 0.4765625, 0.2265625,&
! !        	0.7265625, 0.3515625, 0.8515625, 0.6015625, 0.1015625, 0.9296875,&
! !       	0.4296875, 0.1796875, 0.6796875, 0.3046875 /)
!     else if (icentres == 1000) then
! 		Ncentre = 1000
! 		allocate(frac_pos(Ncentre, 3)); frac_pos(:,:) = 0.0_dp
!
! 	!-> Sobol
! 		frac_pos(:,1) = (/ 0.5       , 0.75      , 0.25      , 0.375     , 0.875     ,&
!        0.625     , 0.125     , 0.1875    , 0.6875    , 0.9375    ,&
!        0.4375    , 0.3125    , 0.8125    , 0.5625    , 0.0625    ,&
!        0.09375   , 0.59375   , 0.84375   , 0.34375   , 0.46875   ,&
!        0.96875   , 0.71875   , 0.21875   , 0.15625   , 0.65625   ,&
!        0.90625   , 0.40625   , 0.28125   , 0.78125   , 0.53125   ,&
!        0.03125   , 0.046875  , 0.546875  , 0.796875  , 0.296875  ,&
!        0.421875  , 0.921875  , 0.671875  , 0.171875  , 0.234375  ,&
!        0.734375  , 0.984375  , 0.484375  , 0.359375  , 0.859375  ,&
!        0.609375  , 0.109375  , 0.078125  , 0.578125  , 0.828125  ,&
!        0.328125  , 0.453125  , 0.953125  , 0.703125  , 0.203125  ,&
!        0.140625  , 0.640625  , 0.890625  , 0.390625  , 0.265625  ,&
!        0.765625  , 0.515625  , 0.015625  , 0.0234375 , 0.5234375 ,&
!        0.7734375 , 0.2734375 , 0.3984375 , 0.8984375 , 0.6484375 ,&
!        0.1484375 , 0.2109375 , 0.7109375 , 0.9609375 , 0.4609375 ,&
!        0.3359375 , 0.8359375 , 0.5859375 , 0.0859375 , 0.1171875 ,&
!        0.6171875 , 0.8671875 , 0.3671875 , 0.4921875 , 0.9921875 ,&
!        0.7421875 , 0.2421875 , 0.1796875 , 0.6796875 , 0.9296875 ,&
!        0.4296875 , 0.3046875 , 0.8046875 , 0.5546875 , 0.0546875 ,&
!        0.0390625 , 0.5390625 , 0.7890625 , 0.2890625 , 0.4140625 ,&
!        0.9140625 , 0.6640625 , 0.1640625 , 0.2265625 , 0.7265625 ,&
!        0.9765625 , 0.4765625 , 0.3515625 , 0.8515625 , 0.6015625 ,&
!        0.1015625 , 0.0703125 , 0.5703125 , 0.8203125 , 0.3203125 ,&
!        0.4453125 , 0.9453125 , 0.6953125 , 0.1953125 , 0.1328125 ,&
!        0.6328125 , 0.8828125 , 0.3828125 , 0.2578125 , 0.7578125 ,&
!        0.5078125 , 0.0078125 , 0.01171875, 0.51171875, 0.76171875,&
!        0.26171875, 0.38671875, 0.88671875, 0.63671875, 0.13671875,&
!        0.19921875, 0.69921875, 0.94921875, 0.44921875, 0.32421875,&
!        0.82421875, 0.57421875, 0.07421875, 0.10546875, 0.60546875,&
!        0.85546875, 0.35546875, 0.48046875, 0.98046875, 0.73046875,&
!        0.23046875, 0.16796875, 0.66796875, 0.91796875, 0.41796875,&
!        0.29296875, 0.79296875, 0.54296875, 0.04296875, 0.05859375,&
!        0.55859375, 0.80859375, 0.30859375, 0.43359375, 0.93359375,&
!        0.68359375, 0.18359375, 0.24609375, 0.74609375, 0.99609375,&
!        0.49609375, 0.37109375, 0.87109375, 0.62109375, 0.12109375,&
!        0.08984375, 0.58984375, 0.83984375, 0.33984375, 0.46484375,&
!        0.96484375, 0.71484375, 0.21484375, 0.15234375, 0.65234375,&
!        0.90234375, 0.40234375, 0.27734375, 0.77734375, 0.52734375,&
!        0.02734375, 0.01953125, 0.51953125, 0.76953125, 0.26953125,&
!        0.39453125, 0.89453125, 0.64453125, 0.14453125, 0.20703125,&
!        0.70703125, 0.95703125, 0.45703125, 0.33203125, 0.83203125,&
!        0.58203125, 0.08203125, 0.11328125, 0.61328125, 0.86328125,&
!        0.36328125, 0.48828125, 0.98828125, 0.73828125, 0.23828125,&
!        0.17578125, 0.67578125, 0.92578125, 0.42578125, 0.30078125,&
!        0.80078125, 0.55078125, 0.05078125, 0.03515625, 0.53515625,&
!        0.78515625, 0.28515625, 0.41015625, 0.91015625, 0.66015625,&
!        0.16015625, 0.22265625, 0.72265625, 0.97265625, 0.47265625,&
!        0.34765625, 0.84765625, 0.59765625, 0.09765625, 0.06640625,&
!        0.56640625, 0.81640625, 0.31640625, 0.44140625, 0.94140625,&
!        0.69140625, 0.19140625, 0.12890625, 0.62890625, 0.87890625,&
!        0.37890625, 0.25390625, 0.75390625, 0.50390625, 0.00390625,&
!        0.00585938, 0.50585938, 0.75585938, 0.25585938, 0.38085938,&
!        0.88085938, 0.63085938, 0.13085938, 0.19335938, 0.69335938,&
!        0.94335938, 0.44335938, 0.31835938, 0.81835938, 0.56835938,&
!        0.06835938, 0.09960938, 0.59960938, 0.84960938, 0.34960938,&
!        0.47460938, 0.97460938, 0.72460938, 0.22460938, 0.16210938,&
!        0.66210938, 0.91210938, 0.41210938, 0.28710938, 0.78710938,&
!        0.53710938, 0.03710938, 0.05273438, 0.55273438, 0.80273438,&
!        0.30273438, 0.42773438, 0.92773438, 0.67773438, 0.17773438,&
!        0.24023438, 0.74023438, 0.99023438, 0.49023438, 0.36523438,&
!        0.86523438, 0.61523438, 0.11523438, 0.08398438, 0.58398438,&
!        0.83398438, 0.33398438, 0.45898438, 0.95898438, 0.70898438,&
!        0.20898438, 0.14648438, 0.64648438, 0.89648438, 0.39648438,&
!        0.27148438, 0.77148438, 0.52148438, 0.02148438, 0.02929688,&
!        0.52929688, 0.77929688, 0.27929688, 0.40429688, 0.90429688,&
!        0.65429688, 0.15429688, 0.21679688, 0.71679688, 0.96679688,&
!        0.46679688, 0.34179688, 0.84179688, 0.59179688, 0.09179688,&
!        0.12304688, 0.62304688, 0.87304688, 0.37304688, 0.49804688,&
!        0.99804688, 0.74804688, 0.24804688, 0.18554688, 0.68554688,&
!        0.93554688, 0.43554688, 0.31054688, 0.81054688, 0.56054688,&
!        0.06054688, 0.04492188, 0.54492188, 0.79492188, 0.29492188,&
!        0.41992188, 0.91992188, 0.66992188, 0.16992188, 0.23242188,&
!        0.73242188, 0.98242188, 0.48242188, 0.35742188, 0.85742188,&
!        0.60742188, 0.10742188, 0.07617188, 0.57617188, 0.82617188,&
!        0.32617188, 0.45117188, 0.95117188, 0.70117188, 0.20117188,&
!        0.13867188, 0.63867188, 0.88867188, 0.38867188, 0.26367188,&
!        0.76367188, 0.51367188, 0.01367188, 0.00976562, 0.50976562,&
!        0.75976562, 0.25976562, 0.38476562, 0.88476562, 0.63476562,&
!        0.13476562, 0.19726562, 0.69726562, 0.94726562, 0.44726562,&
!        0.32226562, 0.82226562, 0.57226562, 0.07226562, 0.10351562,&
!        0.60351562, 0.85351562, 0.35351562, 0.47851562, 0.97851562,&
!        0.72851562, 0.22851562, 0.16601562, 0.66601562, 0.91601562,&
!        0.41601562, 0.29101562, 0.79101562, 0.54101562, 0.04101562,&
!        0.05664062, 0.55664062, 0.80664062, 0.30664062, 0.43164062,&
!        0.93164062, 0.68164062, 0.18164062, 0.24414062, 0.74414062,&
!        0.99414062, 0.49414062, 0.36914062, 0.86914062, 0.61914062,&
!        0.11914062, 0.08789062, 0.58789062, 0.83789062, 0.33789062,&
!        0.46289062, 0.96289062, 0.71289062, 0.21289062, 0.15039062,&
!        0.65039062, 0.90039062, 0.40039062, 0.27539062, 0.77539062,&
!        0.52539062, 0.02539062, 0.01757812, 0.51757812, 0.76757812,&
!        0.26757812, 0.39257812, 0.89257812, 0.64257812, 0.14257812,&
!        0.20507812, 0.70507812, 0.95507812, 0.45507812, 0.33007812,&
!        0.83007812, 0.58007812, 0.08007812, 0.11132812, 0.61132812,&
!        0.86132812, 0.36132812, 0.48632812, 0.98632812, 0.73632812,&
!        0.23632812, 0.17382812, 0.67382812, 0.92382812, 0.42382812,&
!        0.29882812, 0.79882812, 0.54882812, 0.04882812, 0.03320312,&
!        0.53320312, 0.78320312, 0.28320312, 0.40820312, 0.90820312,&
!        0.65820312, 0.15820312, 0.22070312, 0.72070312, 0.97070312,&
!        0.47070312, 0.34570312, 0.84570312, 0.59570312, 0.09570312,&
!        0.06445312, 0.56445312, 0.81445312, 0.31445312, 0.43945312,&
!        0.93945312, 0.68945312, 0.18945312, 0.12695312, 0.62695312,&
!        0.87695312, 0.37695312, 0.25195312, 0.75195312, 0.50195312,&
!        0.00195312, 0.00292969, 0.50292969, 0.75292969, 0.25292969,&
!        0.37792969, 0.87792969, 0.62792969, 0.12792969, 0.19042969,&
!        0.69042969, 0.94042969, 0.44042969, 0.31542969, 0.81542969,&
!        0.56542969, 0.06542969, 0.09667969, 0.59667969, 0.84667969,&
!        0.34667969, 0.47167969, 0.97167969, 0.72167969, 0.22167969,&
!        0.15917969, 0.65917969, 0.90917969, 0.40917969, 0.28417969,&
!        0.78417969, 0.53417969, 0.03417969, 0.04980469, 0.54980469,&
!        0.79980469, 0.29980469, 0.42480469, 0.92480469, 0.67480469,&
!        0.17480469, 0.23730469, 0.73730469, 0.98730469, 0.48730469,&
!        0.36230469, 0.86230469, 0.61230469, 0.11230469, 0.08105469,&
!        0.58105469, 0.83105469, 0.33105469, 0.45605469, 0.95605469,&
!        0.70605469, 0.20605469, 0.14355469, 0.64355469, 0.89355469,&
!        0.39355469, 0.26855469, 0.76855469, 0.51855469, 0.01855469,&
!        0.02636719, 0.52636719, 0.77636719, 0.27636719, 0.40136719,&
!        0.90136719, 0.65136719, 0.15136719, 0.21386719, 0.71386719,&
!        0.96386719, 0.46386719, 0.33886719, 0.83886719, 0.58886719,&
!        0.08886719, 0.12011719, 0.62011719, 0.87011719, 0.37011719,&
!        0.49511719, 0.99511719, 0.74511719, 0.24511719, 0.18261719,&
!        0.68261719, 0.93261719, 0.43261719, 0.30761719, 0.80761719,&
!        0.55761719, 0.05761719, 0.04199219, 0.54199219, 0.79199219,&
!        0.29199219, 0.41699219, 0.91699219, 0.66699219, 0.16699219,&
!        0.22949219, 0.72949219, 0.97949219, 0.47949219, 0.35449219,&
!        0.85449219, 0.60449219, 0.10449219, 0.07324219, 0.57324219,&
!        0.82324219, 0.32324219, 0.44824219, 0.94824219, 0.69824219,&
!        0.19824219, 0.13574219, 0.63574219, 0.88574219, 0.38574219,&
!        0.26074219, 0.76074219, 0.51074219, 0.01074219, 0.01464844,&
!        0.51464844, 0.76464844, 0.26464844, 0.38964844, 0.88964844,&
!        0.63964844, 0.13964844, 0.20214844, 0.70214844, 0.95214844,&
!        0.45214844, 0.32714844, 0.82714844, 0.57714844, 0.07714844,&
!        0.10839844, 0.60839844, 0.85839844, 0.35839844, 0.48339844,&
!        0.98339844, 0.73339844, 0.23339844, 0.17089844, 0.67089844,&
!        0.92089844, 0.42089844, 0.29589844, 0.79589844, 0.54589844,&
!        0.04589844, 0.06152344, 0.56152344, 0.81152344, 0.31152344,&
!        0.43652344, 0.93652344, 0.68652344, 0.18652344, 0.24902344,&
!        0.74902344, 0.99902344, 0.49902344, 0.37402344, 0.87402344,&
!        0.62402344, 0.12402344, 0.09277344, 0.59277344, 0.84277344,&
!        0.34277344, 0.46777344, 0.96777344, 0.71777344, 0.21777344,&
!        0.15527344, 0.65527344, 0.90527344, 0.40527344, 0.28027344,&
!        0.78027344, 0.53027344, 0.03027344, 0.02246094, 0.52246094,&
!        0.77246094, 0.27246094, 0.39746094, 0.89746094, 0.64746094,&
!        0.14746094, 0.20996094, 0.70996094, 0.95996094, 0.45996094,&
!        0.33496094, 0.83496094, 0.58496094, 0.08496094, 0.11621094,&
!        0.61621094, 0.86621094, 0.36621094, 0.49121094, 0.99121094,&
!        0.74121094, 0.24121094, 0.17871094, 0.67871094, 0.92871094,&
!        0.42871094, 0.30371094, 0.80371094, 0.55371094, 0.05371094,&
!        0.03808594, 0.53808594, 0.78808594, 0.28808594, 0.41308594,&
!        0.91308594, 0.66308594, 0.16308594, 0.22558594, 0.72558594,&
!        0.97558594, 0.47558594, 0.35058594, 0.85058594, 0.60058594,&
!        0.10058594, 0.06933594, 0.56933594, 0.81933594, 0.31933594,&
!        0.44433594, 0.94433594, 0.69433594, 0.19433594, 0.13183594,&
!        0.63183594, 0.88183594, 0.38183594, 0.25683594, 0.75683594,&
!        0.50683594, 0.00683594, 0.00488281, 0.50488281, 0.75488281,&
!        0.25488281, 0.37988281, 0.87988281, 0.62988281, 0.12988281,&
!        0.19238281, 0.69238281, 0.94238281, 0.44238281, 0.31738281,&
!        0.81738281, 0.56738281, 0.06738281, 0.09863281, 0.59863281,&
!        0.84863281, 0.34863281, 0.47363281, 0.97363281, 0.72363281,&
!        0.22363281, 0.16113281, 0.66113281, 0.91113281, 0.41113281,&
!        0.28613281, 0.78613281, 0.53613281, 0.03613281, 0.05175781,&
!        0.55175781, 0.80175781, 0.30175781, 0.42675781, 0.92675781,&
!        0.67675781, 0.17675781, 0.23925781, 0.73925781, 0.98925781,&
!        0.48925781, 0.36425781, 0.86425781, 0.61425781, 0.11425781,&
!        0.08300781, 0.58300781, 0.83300781, 0.33300781, 0.45800781,&
!        0.95800781, 0.70800781, 0.20800781, 0.14550781, 0.64550781,&
!        0.89550781, 0.39550781, 0.27050781, 0.77050781, 0.52050781,&
!        0.02050781, 0.02832031, 0.52832031, 0.77832031, 0.27832031,&
!        0.40332031, 0.90332031, 0.65332031, 0.15332031, 0.21582031,&
!        0.71582031, 0.96582031, 0.46582031, 0.34082031, 0.84082031,&
!        0.59082031, 0.09082031, 0.12207031, 0.62207031, 0.87207031,&
!        0.37207031, 0.49707031, 0.99707031, 0.74707031, 0.24707031,&
!        0.18457031, 0.68457031, 0.93457031, 0.43457031, 0.30957031,&
!        0.80957031, 0.55957031, 0.05957031, 0.04394531, 0.54394531,&
!        0.79394531, 0.29394531, 0.41894531, 0.91894531, 0.66894531,&
!        0.16894531, 0.23144531, 0.73144531, 0.98144531, 0.48144531,&
!        0.35644531, 0.85644531, 0.60644531, 0.10644531, 0.07519531,&
!        0.57519531, 0.82519531, 0.32519531, 0.45019531, 0.95019531,&
!        0.70019531, 0.20019531, 0.13769531, 0.63769531, 0.88769531,&
!        0.38769531, 0.26269531, 0.76269531, 0.51269531, 0.01269531,&
!        0.00878906, 0.50878906, 0.75878906, 0.25878906, 0.38378906,&
!        0.88378906, 0.63378906, 0.13378906, 0.19628906, 0.69628906,&
!        0.94628906, 0.44628906, 0.32128906, 0.82128906, 0.57128906,&
!        0.07128906, 0.10253906, 0.60253906, 0.85253906, 0.35253906,&
!        0.47753906, 0.97753906, 0.72753906, 0.22753906, 0.16503906,&
!        0.66503906, 0.91503906, 0.41503906, 0.29003906, 0.79003906,&
!        0.54003906, 0.04003906, 0.05566406, 0.55566406, 0.80566406,&
!        0.30566406, 0.43066406, 0.93066406, 0.68066406, 0.18066406,&
!        0.24316406, 0.74316406, 0.99316406, 0.49316406, 0.36816406,&
!        0.86816406, 0.61816406, 0.11816406, 0.08691406, 0.58691406,&
!        0.83691406, 0.33691406, 0.46191406, 0.96191406, 0.71191406,&
!        0.21191406, 0.14941406, 0.64941406, 0.89941406, 0.39941406,&
!        0.27441406, 0.77441406, 0.52441406, 0.02441406, 0.01660156,&
!        0.51660156, 0.76660156, 0.26660156, 0.39160156, 0.89160156,&
!        0.64160156, 0.14160156, 0.20410156, 0.70410156, 0.95410156,&
!        0.45410156, 0.32910156, 0.82910156, 0.57910156, 0.07910156,&
!        0.11035156, 0.61035156, 0.86035156, 0.36035156, 0.48535156,&
!        0.98535156, 0.73535156, 0.23535156, 0.17285156, 0.67285156,&
!        0.92285156, 0.42285156, 0.29785156, 0.79785156, 0.54785156,&
!        0.04785156, 0.03222656, 0.53222656, 0.78222656, 0.28222656,&
!        0.40722656, 0.90722656, 0.65722656, 0.15722656, 0.21972656 /)
!
!     	frac_pos(:,2) = (/ 5.00000000e-01, 2.50000000e-01, 7.50000000e-01, 3.75000000e-01,&
!        8.75000000e-01, 1.25000000e-01, 6.25000000e-01, 3.12500000e-01,&
!        8.12500000e-01, 6.25000000e-02, 5.62500000e-01, 1.87500000e-01,&
!        6.87500000e-01, 4.37500000e-01, 9.37500000e-01, 4.68750000e-01,&
!        9.68750000e-01, 2.18750000e-01, 7.18750000e-01, 9.37500000e-02,&
!        5.93750000e-01, 3.43750000e-01, 8.43750000e-01, 1.56250000e-01,&
!        6.56250000e-01, 4.06250000e-01, 9.06250000e-01, 2.81250000e-01,&
!        7.81250000e-01, 3.12500000e-02, 5.31250000e-01, 2.65625000e-01,&
!        7.65625000e-01, 1.56250000e-02, 5.15625000e-01, 1.40625000e-01,&
!        6.40625000e-01, 3.90625000e-01, 8.90625000e-01, 7.81250000e-02,&
!        5.78125000e-01, 3.28125000e-01, 8.28125000e-01, 4.53125000e-01,&
!        9.53125000e-01, 2.03125000e-01, 7.03125000e-01, 2.34375000e-01,&
!        7.34375000e-01, 4.84375000e-01, 9.84375000e-01, 3.59375000e-01,&
!        8.59375000e-01, 1.09375000e-01, 6.09375000e-01, 4.21875000e-01,&
!        9.21875000e-01, 1.71875000e-01, 6.71875000e-01, 4.68750000e-02,&
!        5.46875000e-01, 2.96875000e-01, 7.96875000e-01, 3.98437500e-01,&
!        8.98437500e-01, 1.48437500e-01, 6.48437500e-01, 2.34375000e-02,&
!        5.23437500e-01, 2.73437500e-01, 7.73437500e-01, 2.10937500e-01,&
!        7.10937500e-01, 4.60937500e-01, 9.60937500e-01, 3.35937500e-01,&
!        8.35937500e-01, 8.59375000e-02, 5.85937500e-01, 1.17187500e-01,&
!        6.17187500e-01, 3.67187500e-01, 8.67187500e-01, 4.92187500e-01,&
!        9.92187500e-01, 2.42187500e-01, 7.42187500e-01, 3.04687500e-01,&
!        8.04687500e-01, 5.46875000e-02, 5.54687500e-01, 1.79687500e-01,&
!        6.79687500e-01, 4.29687500e-01, 9.29687500e-01, 1.32812500e-01,&
!        6.32812500e-01, 3.82812500e-01, 8.82812500e-01, 2.57812500e-01,&
!        7.57812500e-01, 7.81250000e-03, 5.07812500e-01, 4.45312500e-01,&
!        9.45312500e-01, 1.95312500e-01, 6.95312500e-01, 7.03125000e-02,&
!        5.70312500e-01, 3.20312500e-01, 8.20312500e-01, 3.51562500e-01,&
!        8.51562500e-01, 1.01562500e-01, 6.01562500e-01, 2.26562500e-01,&
!        7.26562500e-01, 4.76562500e-01, 9.76562500e-01, 3.90625000e-02,&
!        5.39062500e-01, 2.89062500e-01, 7.89062500e-01, 4.14062500e-01,&
!        9.14062500e-01, 1.64062500e-01, 6.64062500e-01, 3.32031250e-01,&
!        8.32031250e-01, 8.20312500e-02, 5.82031250e-01, 2.07031250e-01,&
!        7.07031250e-01, 4.57031250e-01, 9.57031250e-01, 1.95312500e-02,&
!        5.19531250e-01, 2.69531250e-01, 7.69531250e-01, 3.94531250e-01,&
!        8.94531250e-01, 1.44531250e-01, 6.44531250e-01, 1.75781250e-01,&
!        6.75781250e-01, 4.25781250e-01, 9.25781250e-01, 3.00781250e-01,&
!        8.00781250e-01, 5.07812500e-02, 5.50781250e-01, 4.88281250e-01,&
!        9.88281250e-01, 2.38281250e-01, 7.38281250e-01, 1.13281250e-01,&
!        6.13281250e-01, 3.63281250e-01, 8.63281250e-01, 6.64062500e-02,&
!        5.66406250e-01, 3.16406250e-01, 8.16406250e-01, 4.41406250e-01,&
!        9.41406250e-01, 1.91406250e-01, 6.91406250e-01, 2.53906250e-01,&
!        7.53906250e-01, 3.90625000e-03, 5.03906250e-01, 1.28906250e-01,&
!        6.28906250e-01, 3.78906250e-01, 8.78906250e-01, 4.10156250e-01,&
!        9.10156250e-01, 1.60156250e-01, 6.60156250e-01, 3.51562500e-02,&
!        5.35156250e-01, 2.85156250e-01, 7.85156250e-01, 2.22656250e-01,&
!        7.22656250e-01, 4.72656250e-01, 9.72656250e-01, 3.47656250e-01,&
!        8.47656250e-01, 9.76562500e-02, 5.97656250e-01, 1.99218750e-01,&
!        6.99218750e-01, 4.49218750e-01, 9.49218750e-01, 3.24218750e-01,&
!        8.24218750e-01, 7.42187500e-02, 5.74218750e-01, 3.86718750e-01,&
!        8.86718750e-01, 1.36718750e-01, 6.36718750e-01, 1.17187500e-02,&
!        5.11718750e-01, 2.61718750e-01, 7.61718750e-01, 2.92968750e-01,&
!        7.92968750e-01, 4.29687500e-02, 5.42968750e-01, 1.67968750e-01,&
!        6.67968750e-01, 4.17968750e-01, 9.17968750e-01, 1.05468750e-01,&
!        6.05468750e-01, 3.55468750e-01, 8.55468750e-01, 4.80468750e-01,&
!        9.80468750e-01, 2.30468750e-01, 7.30468750e-01, 4.64843750e-01,&
!        9.64843750e-01, 2.14843750e-01, 7.14843750e-01, 8.98437500e-02,&
!        5.89843750e-01, 3.39843750e-01, 8.39843750e-01, 1.52343750e-01,&
!        6.52343750e-01, 4.02343750e-01, 9.02343750e-01, 2.77343750e-01,&
!        7.77343750e-01, 2.73437500e-02, 5.27343750e-01, 5.85937500e-02,&
!        5.58593750e-01, 3.08593750e-01, 8.08593750e-01, 4.33593750e-01,&
!        9.33593750e-01, 1.83593750e-01, 6.83593750e-01, 3.71093750e-01,&
!        8.71093750e-01, 1.21093750e-01, 6.21093750e-01, 2.46093750e-01,&
!        7.46093750e-01, 4.96093750e-01, 9.96093750e-01, 4.98046875e-01,&
!        9.98046875e-01, 2.48046875e-01, 7.48046875e-01, 1.23046875e-01,&
!        6.23046875e-01, 3.73046875e-01, 8.73046875e-01, 1.85546875e-01,&
!        6.85546875e-01, 4.35546875e-01, 9.35546875e-01, 3.10546875e-01,&
!        8.10546875e-01, 6.05468750e-02, 5.60546875e-01, 2.92968750e-02,&
!        5.29296875e-01, 2.79296875e-01, 7.79296875e-01, 4.04296875e-01,&
!        9.04296875e-01, 1.54296875e-01, 6.54296875e-01, 3.41796875e-01,&
!        8.41796875e-01, 9.17968750e-02, 5.91796875e-01, 2.16796875e-01,&
!        7.16796875e-01, 4.66796875e-01, 9.66796875e-01, 2.32421875e-01,&
!        7.32421875e-01, 4.82421875e-01, 9.82421875e-01, 3.57421875e-01,&
!        8.57421875e-01, 1.07421875e-01, 6.07421875e-01, 4.19921875e-01,&
!        9.19921875e-01, 1.69921875e-01, 6.69921875e-01, 4.49218750e-02,&
!        5.44921875e-01, 2.94921875e-01, 7.94921875e-01, 2.63671875e-01,&
!        7.63671875e-01, 1.36718750e-02, 5.13671875e-01, 1.38671875e-01,&
!        6.38671875e-01, 3.88671875e-01, 8.88671875e-01, 7.61718750e-02,&
!        5.76171875e-01, 3.26171875e-01, 8.26171875e-01, 4.51171875e-01,&
!        9.51171875e-01, 2.01171875e-01, 7.01171875e-01, 9.96093750e-02,&
!        5.99609375e-01, 3.49609375e-01, 8.49609375e-01, 4.74609375e-01,&
!        9.74609375e-01, 2.24609375e-01, 7.24609375e-01, 2.87109375e-01,&
!        7.87109375e-01, 3.71093750e-02, 5.37109375e-01, 1.62109375e-01,&
!        6.62109375e-01, 4.12109375e-01, 9.12109375e-01, 3.80859375e-01,&
!        8.80859375e-01, 1.30859375e-01, 6.30859375e-01, 5.85937500e-03,&
!        5.05859375e-01, 2.55859375e-01, 7.55859375e-01, 1.93359375e-01,&
!        6.93359375e-01, 4.43359375e-01, 9.43359375e-01, 3.18359375e-01,&
!        8.18359375e-01, 6.83593750e-02, 5.68359375e-01, 3.65234375e-01,&
!        8.65234375e-01, 1.15234375e-01, 6.15234375e-01, 2.40234375e-01,&
!        7.40234375e-01, 4.90234375e-01, 9.90234375e-01, 5.27343750e-02,&
!        5.52734375e-01, 3.02734375e-01, 8.02734375e-01, 4.27734375e-01,&
!        9.27734375e-01, 1.77734375e-01, 6.77734375e-01, 1.46484375e-01,&
!        6.46484375e-01, 3.96484375e-01, 8.96484375e-01, 2.71484375e-01,&
!        7.71484375e-01, 2.14843750e-02, 5.21484375e-01, 4.58984375e-01,&
!        9.58984375e-01, 2.08984375e-01, 7.08984375e-01, 8.39843750e-02,&
!        5.83984375e-01, 3.33984375e-01, 8.33984375e-01, 1.66015625e-01,&
!        6.66015625e-01, 4.16015625e-01, 9.16015625e-01, 2.91015625e-01,&
!        7.91015625e-01, 4.10156250e-02, 5.41015625e-01, 4.78515625e-01,&
!        9.78515625e-01, 2.28515625e-01, 7.28515625e-01, 1.03515625e-01,&
!        6.03515625e-01, 3.53515625e-01, 8.53515625e-01, 3.22265625e-01,&
!        8.22265625e-01, 7.22656250e-02, 5.72265625e-01, 1.97265625e-01,&
!        6.97265625e-01, 4.47265625e-01, 9.47265625e-01, 9.76562500e-03,&
!        5.09765625e-01, 2.59765625e-01, 7.59765625e-01, 3.84765625e-01,&
!        8.84765625e-01, 1.34765625e-01, 6.34765625e-01, 4.31640625e-01,&
!        9.31640625e-01, 1.81640625e-01, 6.81640625e-01, 5.66406250e-02,&
!        5.56640625e-01, 3.06640625e-01, 8.06640625e-01, 2.44140625e-01,&
!        7.44140625e-01, 4.94140625e-01, 9.94140625e-01, 3.69140625e-01,&
!        8.69140625e-01, 1.19140625e-01, 6.19140625e-01, 8.78906250e-02,&
!        5.87890625e-01, 3.37890625e-01, 8.37890625e-01, 4.62890625e-01,&
!        9.62890625e-01, 2.12890625e-01, 7.12890625e-01, 2.75390625e-01,&
!        7.75390625e-01, 2.53906250e-02, 5.25390625e-01, 1.50390625e-01,&
!        6.50390625e-01, 4.00390625e-01, 9.00390625e-01, 2.98828125e-01,&
!        7.98828125e-01, 4.88281250e-02, 5.48828125e-01, 1.73828125e-01,&
!        6.73828125e-01, 4.23828125e-01, 9.23828125e-01, 1.11328125e-01,&
!        6.11328125e-01, 3.61328125e-01, 8.61328125e-01, 4.86328125e-01,&
!        9.86328125e-01, 2.36328125e-01, 7.36328125e-01, 2.05078125e-01,&
!        7.05078125e-01, 4.55078125e-01, 9.55078125e-01, 3.30078125e-01,&
!        8.30078125e-01, 8.00781250e-02, 5.80078125e-01, 3.92578125e-01,&
!        8.92578125e-01, 1.42578125e-01, 6.42578125e-01, 1.75781250e-02,&
!        5.17578125e-01, 2.67578125e-01, 7.67578125e-01, 3.32031250e-02,&
!        5.33203125e-01, 2.83203125e-01, 7.83203125e-01, 4.08203125e-01,&
!        9.08203125e-01, 1.58203125e-01, 6.58203125e-01, 3.45703125e-01,&
!        8.45703125e-01, 9.57031250e-02, 5.95703125e-01, 2.20703125e-01,&
!        7.20703125e-01, 4.70703125e-01, 9.70703125e-01, 4.39453125e-01,&
!        9.39453125e-01, 1.89453125e-01, 6.89453125e-01, 6.44531250e-02,&
!        5.64453125e-01, 3.14453125e-01, 8.14453125e-01, 1.26953125e-01,&
!        6.26953125e-01, 3.76953125e-01, 8.76953125e-01, 2.51953125e-01,&
!        7.51953125e-01, 1.95312500e-03, 5.01953125e-01, 2.50976562e-01,&
!        7.50976562e-01, 9.76562500e-04, 5.00976562e-01, 1.25976562e-01,&
!        6.25976562e-01, 3.75976562e-01, 8.75976562e-01, 6.34765625e-02,&
!        5.63476562e-01, 3.13476562e-01, 8.13476562e-01, 4.38476562e-01,&
!        9.38476562e-01, 1.88476562e-01, 6.88476562e-01, 2.19726562e-01,&
!        7.19726562e-01, 4.69726562e-01, 9.69726562e-01, 3.44726562e-01,&
!        8.44726562e-01, 9.47265625e-02, 5.94726562e-01, 4.07226562e-01,&
!        9.07226562e-01, 1.57226562e-01, 6.57226562e-01, 3.22265625e-02,&
!        5.32226562e-01, 2.82226562e-01, 7.82226562e-01, 1.66015625e-02,&
!        5.16601562e-01, 2.66601562e-01, 7.66601562e-01, 3.91601562e-01,&
!        8.91601562e-01, 1.41601562e-01, 6.41601562e-01, 3.29101562e-01,&
!        8.29101562e-01, 7.91015625e-02, 5.79101562e-01, 2.04101562e-01,&
!        7.04101562e-01, 4.54101562e-01, 9.54101562e-01, 4.85351562e-01,&
!        9.85351562e-01, 2.35351562e-01, 7.35351562e-01, 1.10351562e-01,&
!        6.10351562e-01, 3.60351562e-01, 8.60351562e-01, 1.72851562e-01,&
!        6.72851562e-01, 4.22851562e-01, 9.22851562e-01, 2.97851562e-01,&
!        7.97851562e-01, 4.78515625e-02, 5.47851562e-01, 1.49414062e-01,&
!        6.49414062e-01, 3.99414062e-01, 8.99414062e-01, 2.74414062e-01,&
!        7.74414062e-01, 2.44140625e-02, 5.24414062e-01, 4.61914062e-01,&
!        9.61914062e-01, 2.11914062e-01, 7.11914062e-01, 8.69140625e-02,&
!        5.86914062e-01, 3.36914062e-01, 8.36914062e-01, 3.68164062e-01,&
!        8.68164062e-01, 1.18164062e-01, 6.18164062e-01, 2.43164062e-01,&
!        7.43164062e-01, 4.93164062e-01, 9.93164062e-01, 5.56640625e-02,&
!        5.55664062e-01, 3.05664062e-01, 8.05664062e-01, 4.30664062e-01,&
!        9.30664062e-01, 1.80664062e-01, 6.80664062e-01, 3.83789062e-01,&
!        8.83789062e-01, 1.33789062e-01, 6.33789062e-01, 8.78906250e-03,&
!        5.08789062e-01, 2.58789062e-01, 7.58789062e-01, 1.96289062e-01,&
!        6.96289062e-01, 4.46289062e-01, 9.46289062e-01, 3.21289062e-01,&
!        8.21289062e-01, 7.12890625e-02, 5.71289062e-01, 1.02539062e-01,&
!        6.02539062e-01, 3.52539062e-01, 8.52539062e-01, 4.77539062e-01,&
!        9.77539062e-01, 2.27539062e-01, 7.27539062e-01, 2.90039062e-01,&
!        7.90039062e-01, 4.00390625e-02, 5.40039062e-01, 1.65039062e-01,&
!        6.65039062e-01, 4.15039062e-01, 9.15039062e-01, 8.30078125e-02,&
!        5.83007812e-01, 3.33007812e-01, 8.33007812e-01, 4.58007812e-01,&
!        9.58007812e-01, 2.08007812e-01, 7.08007812e-01, 2.70507812e-01,&
!        7.70507812e-01, 2.05078125e-02, 5.20507812e-01, 1.45507812e-01,&
!        6.45507812e-01, 3.95507812e-01, 8.95507812e-01, 4.26757812e-01,&
!        9.26757812e-01, 1.76757812e-01, 6.76757812e-01, 5.17578125e-02,&
!        5.51757812e-01, 3.01757812e-01, 8.01757812e-01, 2.39257812e-01,&
!        7.39257812e-01, 4.89257812e-01, 9.89257812e-01, 3.64257812e-01,&
!        8.64257812e-01, 1.14257812e-01, 6.14257812e-01, 3.17382812e-01,&
!        8.17382812e-01, 6.73828125e-02, 5.67382812e-01, 1.92382812e-01,&
!        6.92382812e-01, 4.42382812e-01, 9.42382812e-01, 4.88281250e-03,&
!        5.04882812e-01, 2.54882812e-01, 7.54882812e-01, 3.79882812e-01,&
!        8.79882812e-01, 1.29882812e-01, 6.29882812e-01, 1.61132812e-01,&
!        6.61132812e-01, 4.11132812e-01, 9.11132812e-01, 2.86132812e-01,&
!        7.86132812e-01, 3.61328125e-02, 5.36132812e-01, 4.73632812e-01,&
!        9.73632812e-01, 2.23632812e-01, 7.23632812e-01, 9.86328125e-02,&
!        5.98632812e-01, 3.48632812e-01, 8.48632812e-01, 4.50195312e-01,&
!        9.50195312e-01, 2.00195312e-01, 7.00195312e-01, 7.51953125e-02,&
!        5.75195312e-01, 3.25195312e-01, 8.25195312e-01, 1.37695312e-01,&
!        6.37695312e-01, 3.87695312e-01, 8.87695312e-01, 2.62695312e-01,&
!        7.62695312e-01, 1.26953125e-02, 5.12695312e-01, 4.39453125e-02,&
!        5.43945312e-01, 2.93945312e-01, 7.93945312e-01, 4.18945312e-01,&
!        9.18945312e-01, 1.68945312e-01, 6.68945312e-01, 3.56445312e-01,&
!        8.56445312e-01, 1.06445312e-01, 6.06445312e-01, 2.31445312e-01,&
!        7.31445312e-01, 4.81445312e-01, 9.81445312e-01, 2.15820312e-01,&
!        7.15820312e-01, 4.65820312e-01, 9.65820312e-01, 3.40820312e-01,&
!        8.40820312e-01, 9.08203125e-02, 5.90820312e-01, 4.03320312e-01,&
!        9.03320312e-01, 1.53320312e-01, 6.53320312e-01, 2.83203125e-02,&
!        5.28320312e-01, 2.78320312e-01, 7.78320312e-01, 3.09570312e-01,&
!        8.09570312e-01, 5.95703125e-02, 5.59570312e-01, 1.84570312e-01,&
!        6.84570312e-01, 4.34570312e-01, 9.34570312e-01, 1.22070312e-01,&
!        6.22070312e-01, 3.72070312e-01, 8.72070312e-01, 4.97070312e-01,&
!        9.97070312e-01, 2.47070312e-01, 7.47070312e-01, 2.49023438e-01,&
!        7.49023438e-01, 4.99023438e-01, 9.99023438e-01, 3.74023438e-01,&
!        8.74023438e-01, 1.24023438e-01, 6.24023438e-01, 4.36523438e-01,&
!        9.36523438e-01, 1.86523438e-01, 6.86523438e-01, 6.15234375e-02,&
!        5.61523438e-01, 3.11523438e-01, 8.11523438e-01, 2.80273438e-01,&
!        7.80273438e-01, 3.02734375e-02, 5.30273438e-01, 1.55273438e-01,&
!        6.55273438e-01, 4.05273438e-01, 9.05273438e-01, 9.27734375e-02,&
!        5.92773438e-01, 3.42773438e-01, 8.42773438e-01, 4.67773438e-01,&
!        9.67773438e-01, 2.17773438e-01, 7.17773438e-01, 4.83398438e-01,&
!        9.83398438e-01, 2.33398438e-01, 7.33398438e-01, 1.08398438e-01,&
!        6.08398438e-01, 3.58398438e-01, 8.58398438e-01, 1.70898438e-01,&
!        6.70898438e-01, 4.20898438e-01, 9.20898438e-01, 2.95898438e-01,&
!        7.95898438e-01, 4.58984375e-02, 5.45898438e-01, 1.46484375e-02,&
!        5.14648438e-01, 2.64648438e-01, 7.64648438e-01, 3.89648438e-01,&
!        8.89648438e-01, 1.39648438e-01, 6.39648438e-01, 3.27148438e-01,&
!        8.27148438e-01, 7.71484375e-02, 5.77148438e-01, 2.02148438e-01,&
!        7.02148438e-01, 4.52148438e-01, 9.52148438e-01, 3.50585938e-01,&
!        8.50585938e-01, 1.00585938e-01, 6.00585938e-01, 2.25585938e-01,&
!        7.25585938e-01, 4.75585938e-01, 9.75585938e-01, 3.80859375e-02,&
!        5.38085938e-01, 2.88085938e-01, 7.88085938e-01, 4.13085938e-01,&
!        9.13085938e-01, 1.63085938e-01, 6.63085938e-01, 1.31835938e-01,&
!        6.31835938e-01, 3.81835938e-01, 8.81835938e-01, 2.56835938e-01,&
!        7.56835938e-01, 6.83593750e-03, 5.06835938e-01, 4.44335938e-01,&
!        9.44335938e-01, 1.94335938e-01, 6.94335938e-01, 6.93359375e-02,&
!        5.69335938e-01, 3.19335938e-01, 8.19335938e-01, 1.16210938e-01,&
!        6.16210938e-01, 3.66210938e-01, 8.66210938e-01, 4.91210938e-01,&
!        9.91210938e-01, 2.41210938e-01, 7.41210938e-01, 3.03710938e-01,&
!        8.03710938e-01, 5.37109375e-02, 5.53710938e-01, 1.78710938e-01,&
!        6.78710938e-01, 4.28710938e-01, 9.28710938e-01, 3.97460938e-01,&
!        8.97460938e-01, 1.47460938e-01, 6.47460938e-01, 2.24609375e-02,&
!        5.22460938e-01, 2.72460938e-01, 7.72460938e-01, 2.09960938e-01,&
!        7.09960938e-01, 4.59960938e-01, 9.59960938e-01, 3.34960938e-01,&
!        8.34960938e-01, 8.49609375e-02, 5.84960938e-01, 4.16992188e-01,&
!        9.16992188e-01, 1.66992188e-01, 6.66992188e-01, 4.19921875e-02,&
!        5.41992188e-01, 2.91992188e-01, 7.91992188e-01, 2.29492188e-01,&
!        7.29492188e-01, 4.79492188e-01, 9.79492188e-01, 3.54492188e-01,&
!        8.54492188e-01, 1.04492188e-01, 6.04492188e-01, 7.32421875e-02,&
!        5.73242188e-01, 3.23242188e-01, 8.23242188e-01, 4.48242188e-01,&
!        9.48242188e-01, 1.98242188e-01, 6.98242188e-01, 2.60742188e-01,&
!        7.60742188e-01, 1.07421875e-02, 5.10742188e-01, 1.35742188e-01,&
!        6.35742188e-01, 3.85742188e-01, 8.85742188e-01, 1.82617188e-01,&
!        6.82617188e-01, 4.32617188e-01, 9.32617188e-01, 3.07617188e-01,&
!        8.07617188e-01, 5.76171875e-02, 5.57617188e-01, 4.95117188e-01,&
!        9.95117188e-01, 2.45117188e-01, 7.45117188e-01, 1.20117188e-01,&
!        6.20117188e-01, 3.70117188e-01, 8.70117188e-01, 3.38867188e-01,&
!        8.38867188e-01, 8.88671875e-02, 5.88867188e-01, 2.13867188e-01,&
!        7.13867188e-01, 4.63867188e-01, 9.63867188e-01, 2.63671875e-02,&
!        5.26367188e-01, 2.76367188e-01, 7.76367188e-01, 4.01367188e-01,&
!        9.01367188e-01, 1.51367188e-01, 6.51367188e-01, 4.98046875e-02,&
!        5.49804688e-01, 2.99804688e-01, 7.99804688e-01, 4.24804688e-01,&
!        9.24804688e-01, 1.74804688e-01, 6.74804688e-01, 3.62304688e-01,&
!        8.62304688e-01, 1.12304688e-01, 6.12304688e-01, 2.37304688e-01,&
!        7.37304688e-01, 4.87304688e-01, 9.87304688e-01, 4.56054688e-01,&
!        9.56054688e-01, 2.06054688e-01, 7.06054688e-01, 8.10546875e-02,&
!        5.81054688e-01, 3.31054688e-01, 8.31054688e-01, 1.43554688e-01,&
!        6.43554688e-01, 3.93554688e-01, 8.93554688e-01, 2.68554688e-01,&
!        7.68554688e-01, 1.85546875e-02, 5.18554688e-01, 2.84179688e-01,&
!        7.84179688e-01, 3.41796875e-02, 5.34179688e-01, 1.59179688e-01,&
!        6.59179688e-01, 4.09179688e-01, 9.09179688e-01, 9.66796875e-02 /)
!
!     	frac_pos(:,3) = (/ 5.00000000e-01, 7.50000000e-01, 2.50000000e-01, 6.25000000e-01,&
!        1.25000000e-01, 3.75000000e-01, 8.75000000e-01, 3.12500000e-01,&
!        8.12500000e-01, 5.62500000e-01, 6.25000000e-02, 9.37500000e-01,&
!        4.37500000e-01, 1.87500000e-01, 6.87500000e-01, 8.43750000e-01,&
!        3.43750000e-01, 9.37500000e-02, 5.93750000e-01, 4.68750000e-01,&
!        9.68750000e-01, 7.18750000e-01, 2.18750000e-01, 5.31250000e-01,&
!        3.12500000e-02, 2.81250000e-01, 7.81250000e-01, 1.56250000e-01,&
!        6.56250000e-01, 9.06250000e-01, 4.06250000e-01, 6.09375000e-01,&
!        1.09375000e-01, 3.59375000e-01, 8.59375000e-01, 2.34375000e-01,&
!        7.34375000e-01, 9.84375000e-01, 4.84375000e-01, 7.96875000e-01,&
!        2.96875000e-01, 4.68750000e-02, 5.46875000e-01, 4.21875000e-01,&
!        9.21875000e-01, 6.71875000e-01, 1.71875000e-01, 2.65625000e-01,&
!        7.65625000e-01, 5.15625000e-01, 1.56250000e-02, 8.90625000e-01,&
!        3.90625000e-01, 1.40625000e-01, 6.40625000e-01, 7.81250000e-02,&
!        5.78125000e-01, 8.28125000e-01, 3.28125000e-01, 7.03125000e-01,&
!        2.03125000e-01, 4.53125000e-01, 9.53125000e-01, 4.45312500e-01,&
!        9.45312500e-01, 6.95312500e-01, 1.95312500e-01, 8.20312500e-01,&
!        3.20312500e-01, 7.03125000e-02, 5.70312500e-01, 1.32812500e-01,&
!        6.32812500e-01, 8.82812500e-01, 3.82812500e-01, 5.07812500e-01,&
!        7.81250000e-03, 2.57812500e-01, 7.57812500e-01, 6.64062500e-01,&
!        1.64062500e-01, 4.14062500e-01, 9.14062500e-01, 3.90625000e-02,&
!        5.39062500e-01, 7.89062500e-01, 2.89062500e-01, 9.76562500e-01,&
!        4.76562500e-01, 2.26562500e-01, 7.26562500e-01, 3.51562500e-01,&
!        8.51562500e-01, 6.01562500e-01, 1.01562500e-01, 9.29687500e-01,&
!        4.29687500e-01, 1.79687500e-01, 6.79687500e-01, 3.04687500e-01,&
!        8.04687500e-01, 5.54687500e-01, 5.46875000e-02, 7.42187500e-01,&
!        2.42187500e-01, 4.92187500e-01, 9.92187500e-01, 1.17187500e-01,&
!        6.17187500e-01, 8.67187500e-01, 3.67187500e-01, 2.10937500e-01,&
!        7.10937500e-01, 9.60937500e-01, 4.60937500e-01, 5.85937500e-01,&
!        8.59375000e-02, 3.35937500e-01, 8.35937500e-01, 3.98437500e-01,&
!        8.98437500e-01, 6.48437500e-01, 1.48437500e-01, 7.73437500e-01,&
!        2.73437500e-01, 2.34375000e-02, 5.23437500e-01, 7.85156250e-01,&
!        2.85156250e-01, 3.51562500e-02, 5.35156250e-01, 4.10156250e-01,&
!        9.10156250e-01, 6.60156250e-01, 1.60156250e-01, 5.97656250e-01,&
!        9.76562500e-02, 3.47656250e-01, 8.47656250e-01, 2.22656250e-01,&
!        7.22656250e-01, 9.72656250e-01, 4.72656250e-01, 6.64062500e-02,&
!        5.66406250e-01, 8.16406250e-01, 3.16406250e-01, 6.91406250e-01,&
!        1.91406250e-01, 4.41406250e-01, 9.41406250e-01, 2.53906250e-01,&
!        7.53906250e-01, 5.03906250e-01, 3.90625000e-03, 8.78906250e-01,&
!        3.78906250e-01, 1.28906250e-01, 6.28906250e-01, 3.32031250e-01,&
!        8.32031250e-01, 5.82031250e-01, 8.20312500e-02, 9.57031250e-01,&
!        4.57031250e-01, 2.07031250e-01, 7.07031250e-01, 1.95312500e-02,&
!        5.19531250e-01, 7.69531250e-01, 2.69531250e-01, 6.44531250e-01,&
!        1.44531250e-01, 3.94531250e-01, 8.94531250e-01, 5.50781250e-01,&
!        5.07812500e-02, 3.00781250e-01, 8.00781250e-01, 1.75781250e-01,&
!        6.75781250e-01, 9.25781250e-01, 4.25781250e-01, 8.63281250e-01,&
!        3.63281250e-01, 1.13281250e-01, 6.13281250e-01, 4.88281250e-01,&
!        9.88281250e-01, 7.38281250e-01, 2.38281250e-01, 7.30468750e-01,&
!        2.30468750e-01, 4.80468750e-01, 9.80468750e-01, 1.05468750e-01,&
!        6.05468750e-01, 8.55468750e-01, 3.55468750e-01, 9.17968750e-01,&
!        4.17968750e-01, 1.67968750e-01, 6.67968750e-01, 2.92968750e-01,&
!        7.92968750e-01, 5.42968750e-01, 4.29687500e-02, 3.86718750e-01,&
!        8.86718750e-01, 6.36718750e-01, 1.36718750e-01, 7.61718750e-01,&
!        2.61718750e-01, 1.17187500e-02, 5.11718750e-01, 1.99218750e-01,&
!        6.99218750e-01, 9.49218750e-01, 4.49218750e-01, 5.74218750e-01,&
!        7.42187500e-02, 3.24218750e-01, 8.24218750e-01, 1.52343750e-01,&
!        6.52343750e-01, 9.02343750e-01, 4.02343750e-01, 5.27343750e-01,&
!        2.73437500e-02, 2.77343750e-01, 7.77343750e-01, 4.64843750e-01,&
!        9.64843750e-01, 7.14843750e-01, 2.14843750e-01, 8.39843750e-01,&
!        3.39843750e-01, 8.98437500e-02, 5.89843750e-01, 9.96093750e-01,&
!        4.96093750e-01, 2.46093750e-01, 7.46093750e-01, 3.71093750e-01,&
!        8.71093750e-01, 6.21093750e-01, 1.21093750e-01, 6.83593750e-01,&
!        1.83593750e-01, 4.33593750e-01, 9.33593750e-01, 5.85937500e-02,&
!        5.58593750e-01, 8.08593750e-01, 3.08593750e-01, 6.54296875e-01,&
!        1.54296875e-01, 4.04296875e-01, 9.04296875e-01, 2.92968750e-02,&
!        5.29296875e-01, 7.79296875e-01, 2.79296875e-01, 9.66796875e-01,&
!        4.66796875e-01, 2.16796875e-01, 7.16796875e-01, 3.41796875e-01,&
!        8.41796875e-01, 5.91796875e-01, 9.17968750e-02, 4.98046875e-01,&
!        9.98046875e-01, 7.48046875e-01, 2.48046875e-01, 8.73046875e-01,&
!        3.73046875e-01, 1.23046875e-01, 6.23046875e-01, 1.85546875e-01,&
!        6.85546875e-01, 9.35546875e-01, 4.35546875e-01, 5.60546875e-01,&
!        6.05468750e-02, 3.10546875e-01, 8.10546875e-01, 2.32421875e-01,&
!        7.32421875e-01, 9.82421875e-01, 4.82421875e-01, 6.07421875e-01,&
!        1.07421875e-01, 3.57421875e-01, 8.57421875e-01, 4.19921875e-01,&
!        9.19921875e-01, 6.69921875e-01, 1.69921875e-01, 7.94921875e-01,&
!        2.94921875e-01, 4.49218750e-02, 5.44921875e-01, 8.88671875e-01,&
!        3.88671875e-01, 1.38671875e-01, 6.38671875e-01, 2.63671875e-01,&
!        7.63671875e-01, 5.13671875e-01, 1.36718750e-02, 7.01171875e-01,&
!        2.01171875e-01, 4.51171875e-01, 9.51171875e-01, 7.61718750e-02,&
!        5.76171875e-01, 8.26171875e-01, 3.26171875e-01, 8.33984375e-01,&
!        3.33984375e-01, 8.39843750e-02, 5.83984375e-01, 4.58984375e-01,&
!        9.58984375e-01, 7.08984375e-01, 2.08984375e-01, 5.21484375e-01,&
!        2.14843750e-02, 2.71484375e-01, 7.71484375e-01, 1.46484375e-01,&
!        6.46484375e-01, 8.96484375e-01, 3.96484375e-01, 5.27343750e-02,&
!        5.52734375e-01, 8.02734375e-01, 3.02734375e-01, 6.77734375e-01,&
!        1.77734375e-01, 4.27734375e-01, 9.27734375e-01, 3.65234375e-01,&
!        8.65234375e-01, 6.15234375e-01, 1.15234375e-01, 9.90234375e-01,&
!        4.90234375e-01, 2.40234375e-01, 7.40234375e-01, 2.87109375e-01,&
!        7.87109375e-01, 5.37109375e-01, 3.71093750e-02, 9.12109375e-01,&
!        4.12109375e-01, 1.62109375e-01, 6.62109375e-01, 9.96093750e-02,&
!        5.99609375e-01, 8.49609375e-01, 3.49609375e-01, 7.24609375e-01,&
!        2.24609375e-01, 4.74609375e-01, 9.74609375e-01, 5.68359375e-01,&
!        6.83593750e-02, 3.18359375e-01, 8.18359375e-01, 1.93359375e-01,&
!        6.93359375e-01, 9.43359375e-01, 4.43359375e-01, 7.55859375e-01,&
!        2.55859375e-01, 5.85937500e-03, 5.05859375e-01, 3.80859375e-01,&
!        8.80859375e-01, 6.30859375e-01, 1.30859375e-01, 4.31640625e-01,&
!        9.31640625e-01, 6.81640625e-01, 1.81640625e-01, 8.06640625e-01,&
!        3.06640625e-01, 5.66406250e-02, 5.56640625e-01, 2.44140625e-01,&
!        7.44140625e-01, 9.94140625e-01, 4.94140625e-01, 6.19140625e-01,&
!        1.19140625e-01, 3.69140625e-01, 8.69140625e-01, 7.12890625e-01,&
!        2.12890625e-01, 4.62890625e-01, 9.62890625e-01, 8.78906250e-02,&
!        5.87890625e-01, 8.37890625e-01, 3.37890625e-01, 9.00390625e-01,&
!        4.00390625e-01, 1.50390625e-01, 6.50390625e-01, 2.75390625e-01,&
!        7.75390625e-01, 5.25390625e-01, 2.53906250e-02, 9.47265625e-01,&
!        4.47265625e-01, 1.97265625e-01, 6.97265625e-01, 3.22265625e-01,&
!        8.22265625e-01, 5.72265625e-01, 7.22656250e-02, 6.34765625e-01,&
!        1.34765625e-01, 3.84765625e-01, 8.84765625e-01, 9.76562500e-03,&
!        5.09765625e-01, 7.59765625e-01, 2.59765625e-01, 1.66015625e-01,&
!        6.66015625e-01, 9.16015625e-01, 4.16015625e-01, 5.41015625e-01,&
!        4.10156250e-02, 2.91015625e-01, 7.91015625e-01, 4.78515625e-01,&
!        9.78515625e-01, 7.28515625e-01, 2.28515625e-01, 8.53515625e-01,&
!        3.53515625e-01, 1.03515625e-01, 6.03515625e-01, 1.11328125e-01,&
!        6.11328125e-01, 8.61328125e-01, 3.61328125e-01, 7.36328125e-01,&
!        2.36328125e-01, 4.86328125e-01, 9.86328125e-01, 2.98828125e-01,&
!        7.98828125e-01, 5.48828125e-01, 4.88281250e-02, 9.23828125e-01,&
!        4.23828125e-01, 1.73828125e-01, 6.73828125e-01, 7.67578125e-01,&
!        2.67578125e-01, 1.75781250e-02, 5.17578125e-01, 3.92578125e-01,&
!        8.92578125e-01, 6.42578125e-01, 1.42578125e-01, 5.80078125e-01,&
!        8.00781250e-02, 3.30078125e-01, 8.30078125e-01, 2.05078125e-01,&
!        7.05078125e-01, 9.55078125e-01, 4.55078125e-01, 5.01953125e-01,&
!        1.95312500e-03, 2.51953125e-01, 7.51953125e-01, 1.26953125e-01,&
!        6.26953125e-01, 8.76953125e-01, 3.76953125e-01, 8.14453125e-01,&
!        3.14453125e-01, 6.44531250e-02, 5.64453125e-01, 4.39453125e-01,&
!        9.39453125e-01, 6.89453125e-01, 1.89453125e-01, 3.45703125e-01,&
!        8.45703125e-01, 5.95703125e-01, 9.57031250e-02, 9.70703125e-01,&
!        4.70703125e-01, 2.20703125e-01, 7.20703125e-01, 3.32031250e-02,&
!        5.33203125e-01, 7.83203125e-01, 2.83203125e-01, 6.58203125e-01,&
!        1.58203125e-01, 4.08203125e-01, 9.08203125e-01, 3.62304688e-01,&
!        8.62304688e-01, 6.12304688e-01, 1.12304688e-01, 9.87304688e-01,&
!        4.87304688e-01, 2.37304688e-01, 7.37304688e-01, 4.98046875e-02,&
!        5.49804688e-01, 7.99804688e-01, 2.99804688e-01, 6.74804688e-01,&
!        1.74804688e-01, 4.24804688e-01, 9.24804688e-01, 5.18554688e-01,&
!        1.85546875e-02, 2.68554688e-01, 7.68554688e-01, 1.43554688e-01,&
!        6.43554688e-01, 8.93554688e-01, 3.93554688e-01, 8.31054688e-01,&
!        3.31054688e-01, 8.10546875e-02, 5.81054688e-01, 4.56054688e-01,&
!        9.56054688e-01, 7.06054688e-01, 2.06054688e-01, 7.52929688e-01,&
!        2.52929688e-01, 2.92968750e-03, 5.02929688e-01, 3.77929688e-01,&
!        8.77929688e-01, 6.27929688e-01, 1.27929688e-01, 5.65429688e-01,&
!        6.54296875e-02, 3.15429688e-01, 8.15429688e-01, 1.90429688e-01,&
!        6.90429688e-01, 9.40429688e-01, 4.40429688e-01, 9.66796875e-02,&
!        5.96679688e-01, 8.46679688e-01, 3.46679688e-01, 7.21679688e-01,&
!        2.21679688e-01, 4.71679688e-01, 9.71679688e-01, 2.84179688e-01,&
!        7.84179688e-01, 5.34179688e-01, 3.41796875e-02, 9.09179688e-01,&
!        4.09179688e-01, 1.59179688e-01, 6.59179688e-01, 1.82617188e-01,&
!        6.82617188e-01, 9.32617188e-01, 4.32617188e-01, 5.57617188e-01,&
!        5.76171875e-02, 3.07617188e-01, 8.07617188e-01, 4.95117188e-01,&
!        9.95117188e-01, 7.45117188e-01, 2.45117188e-01, 8.70117188e-01,&
!        3.70117188e-01, 1.20117188e-01, 6.20117188e-01, 9.63867188e-01,&
!        4.63867188e-01, 2.13867188e-01, 7.13867188e-01, 3.38867188e-01,&
!        8.38867188e-01, 5.88867188e-01, 8.88671875e-02, 6.51367188e-01,&
!        1.51367188e-01, 4.01367188e-01, 9.01367188e-01, 2.63671875e-02,&
!        5.26367188e-01, 7.76367188e-01, 2.76367188e-01, 6.98242188e-01,&
!        1.98242188e-01, 4.48242188e-01, 9.48242188e-01, 7.32421875e-02,&
!        5.73242188e-01, 8.23242188e-01, 3.23242188e-01, 8.85742188e-01,&
!        3.85742188e-01, 1.35742188e-01, 6.35742188e-01, 2.60742188e-01,&
!        7.60742188e-01, 5.10742188e-01, 1.07421875e-02, 4.16992188e-01,&
!        9.16992188e-01, 6.66992188e-01, 1.66992188e-01, 7.91992188e-01,&
!        2.91992188e-01, 4.19921875e-02, 5.41992188e-01, 2.29492188e-01,&
!        7.29492188e-01, 9.79492188e-01, 4.79492188e-01, 6.04492188e-01,&
!        1.04492188e-01, 3.54492188e-01, 8.54492188e-01, 5.84960938e-01,&
!        8.49609375e-02, 3.34960938e-01, 8.34960938e-01, 2.09960938e-01,&
!        7.09960938e-01, 9.59960938e-01, 4.59960938e-01, 7.72460938e-01,&
!        2.72460938e-01, 2.24609375e-02, 5.22460938e-01, 3.97460938e-01,&
!        8.97460938e-01, 6.47460938e-01, 1.47460938e-01, 3.03710938e-01,&
!        8.03710938e-01, 5.53710938e-01, 5.37109375e-02, 9.28710938e-01,&
!        4.28710938e-01, 1.78710938e-01, 6.78710938e-01, 1.16210938e-01,&
!        6.16210938e-01, 8.66210938e-01, 3.66210938e-01, 7.41210938e-01,&
!        2.41210938e-01, 4.91210938e-01, 9.91210938e-01, 3.80859375e-02,&
!        5.38085938e-01, 7.88085938e-01, 2.88085938e-01, 6.63085938e-01,&
!        1.63085938e-01, 4.13085938e-01, 9.13085938e-01, 3.50585938e-01,&
!        8.50585938e-01, 6.00585938e-01, 1.00585938e-01, 9.75585938e-01,&
!        4.75585938e-01, 2.25585938e-01, 7.25585938e-01, 8.19335938e-01,&
!        3.19335938e-01, 6.93359375e-02, 5.69335938e-01, 4.44335938e-01,&
!        9.44335938e-01, 6.94335938e-01, 1.94335938e-01, 5.06835938e-01,&
!        6.83593750e-03, 2.56835938e-01, 7.56835938e-01, 1.31835938e-01,&
!        6.31835938e-01, 8.81835938e-01, 3.81835938e-01, 9.05273438e-01,&
!        4.05273438e-01, 1.55273438e-01, 6.55273438e-01, 2.80273438e-01,&
!        7.80273438e-01, 5.30273438e-01, 3.02734375e-02, 7.17773438e-01,&
!        2.17773438e-01, 4.67773438e-01, 9.67773438e-01, 9.27734375e-02,&
!        5.92773438e-01, 8.42773438e-01, 3.42773438e-01, 2.49023438e-01,&
!        7.49023438e-01, 9.99023438e-01, 4.99023438e-01, 6.24023438e-01,&
!        1.24023438e-01, 3.74023438e-01, 8.74023438e-01, 4.36523438e-01,&
!        9.36523438e-01, 6.86523438e-01, 1.86523438e-01, 8.11523438e-01,&
!        3.11523438e-01, 6.15234375e-02, 5.61523438e-01, 4.83398438e-01,&
!        9.83398438e-01, 7.33398438e-01, 2.33398438e-01, 8.58398438e-01,&
!        3.58398438e-01, 1.08398438e-01, 6.08398438e-01, 1.70898438e-01,&
!        6.70898438e-01, 9.20898438e-01, 4.20898438e-01, 5.45898438e-01,&
!        4.58984375e-02, 2.95898438e-01, 7.95898438e-01, 6.39648438e-01,&
!        1.39648438e-01, 3.89648438e-01, 8.89648438e-01, 1.46484375e-02,&
!        5.14648438e-01, 7.64648438e-01, 2.64648438e-01, 9.52148438e-01,&
!        4.52148438e-01, 2.02148438e-01, 7.02148438e-01, 3.27148438e-01,&
!        8.27148438e-01, 5.77148438e-01, 7.71484375e-02, 9.81445312e-01,&
!        4.81445312e-01, 2.31445312e-01, 7.31445312e-01, 3.56445312e-01,&
!        8.56445312e-01, 6.06445312e-01, 1.06445312e-01, 6.68945312e-01,&
!        1.68945312e-01, 4.18945312e-01, 9.18945312e-01, 4.39453125e-02,&
!        5.43945312e-01, 7.93945312e-01, 2.93945312e-01, 1.37695312e-01,&
!        6.37695312e-01, 8.87695312e-01, 3.87695312e-01, 5.12695312e-01,&
!        1.26953125e-02, 2.62695312e-01, 7.62695312e-01, 4.50195312e-01,&
!        9.50195312e-01, 7.00195312e-01, 2.00195312e-01, 8.25195312e-01,&
!        3.25195312e-01, 7.51953125e-02, 5.75195312e-01, 4.03320312e-01,&
!        9.03320312e-01, 6.53320312e-01, 1.53320312e-01, 7.78320312e-01,&
!        2.78320312e-01, 2.83203125e-02, 5.28320312e-01, 2.15820312e-01,&
!        7.15820312e-01, 9.65820312e-01, 4.65820312e-01, 5.90820312e-01,&
!        9.08203125e-02, 3.40820312e-01, 8.40820312e-01, 7.47070312e-01,&
!        2.47070312e-01, 4.97070312e-01, 9.97070312e-01, 1.22070312e-01,&
!        6.22070312e-01, 8.72070312e-01, 3.72070312e-01, 9.34570312e-01,&
!        4.34570312e-01, 1.84570312e-01, 6.84570312e-01, 3.09570312e-01,&
!        8.09570312e-01, 5.59570312e-01, 5.95703125e-02, 5.36132812e-01,&
!        3.61328125e-02, 2.86132812e-01, 7.86132812e-01, 1.61132812e-01,&
!        6.61132812e-01, 9.11132812e-01, 4.11132812e-01, 8.48632812e-01,&
!        3.48632812e-01, 9.86328125e-02, 5.98632812e-01, 4.73632812e-01,&
!        9.73632812e-01, 7.23632812e-01, 2.23632812e-01, 3.17382812e-01,&
!        8.17382812e-01, 5.67382812e-01, 6.73828125e-02, 9.42382812e-01,&
!        4.42382812e-01, 1.92382812e-01, 6.92382812e-01, 4.88281250e-03,&
!        5.04882812e-01, 7.54882812e-01, 2.54882812e-01, 6.29882812e-01,&
!        1.29882812e-01, 3.79882812e-01, 8.79882812e-01, 8.30078125e-02,&
!        5.83007812e-01, 8.33007812e-01, 3.33007812e-01, 7.08007812e-01,&
!        2.08007812e-01, 4.58007812e-01, 9.58007812e-01, 2.70507812e-01,&
!        7.70507812e-01, 5.20507812e-01, 2.05078125e-02, 8.95507812e-01,&
!        3.95507812e-01, 1.45507812e-01, 6.45507812e-01, 8.01757812e-01,&
!        3.01757812e-01, 5.17578125e-02, 5.51757812e-01, 4.26757812e-01,&
!        9.26757812e-01, 6.76757812e-01, 1.76757812e-01, 6.14257812e-01,&
!        1.14257812e-01, 3.64257812e-01, 8.64257812e-01, 2.39257812e-01,&
!        7.39257812e-01, 9.89257812e-01, 4.89257812e-01, 1.96289062e-01,&
!        6.96289062e-01, 9.46289062e-01, 4.46289062e-01, 5.71289062e-01,&
!        7.12890625e-02, 3.21289062e-01, 8.21289062e-01, 3.83789062e-01,&
!        8.83789062e-01, 6.33789062e-01, 1.33789062e-01, 7.58789062e-01,&
!        2.58789062e-01, 8.78906250e-03, 5.08789062e-01, 9.15039062e-01,&
!        4.15039062e-01, 1.65039062e-01, 6.65039062e-01, 2.90039062e-01,&
!        7.90039062e-01, 5.40039062e-01, 4.00390625e-02, 7.27539062e-01,&
!        2.27539062e-01, 4.77539062e-01, 9.77539062e-01, 1.02539062e-01,&
!        6.02539062e-01, 8.52539062e-01, 3.52539062e-01, 6.80664062e-01,&
!        1.80664062e-01, 4.30664062e-01, 9.30664062e-01, 5.56640625e-02,&
!        5.55664062e-01, 8.05664062e-01, 3.05664062e-01, 9.93164062e-01,&
!        4.93164062e-01, 2.43164062e-01, 7.43164062e-01, 3.68164062e-01,&
!        8.68164062e-01, 6.18164062e-01, 1.18164062e-01, 4.61914062e-01,&
!        9.61914062e-01, 7.11914062e-01, 2.11914062e-01, 8.36914062e-01,&
!        3.36914062e-01, 8.69140625e-02, 5.86914062e-01, 1.49414062e-01,&
!        6.49414062e-01, 8.99414062e-01, 3.99414062e-01, 5.24414062e-01,&
!        2.44140625e-02, 2.74414062e-01, 7.74414062e-01, 2.50976562e-01,&
!        7.50976562e-01, 5.00976562e-01, 9.76562500e-04, 8.75976562e-01,&
!        3.75976562e-01, 1.25976562e-01, 6.25976562e-01, 6.34765625e-02,&
!        5.63476562e-01, 8.13476562e-01, 3.13476562e-01, 6.88476562e-01,&
!        1.88476562e-01, 4.38476562e-01, 9.38476562e-01, 5.94726562e-01,&
!        9.47265625e-02, 3.44726562e-01, 8.44726562e-01, 2.19726562e-01,&
!        7.19726562e-01, 9.69726562e-01, 4.69726562e-01, 7.82226562e-01,&
!        2.82226562e-01, 3.22265625e-02, 5.32226562e-01, 4.07226562e-01,&
!        9.07226562e-01, 6.57226562e-01, 1.57226562e-01, 8.60351562e-01,&
!        3.60351562e-01, 1.10351562e-01, 6.10351562e-01, 4.85351562e-01,&
!        9.85351562e-01, 7.35351562e-01, 2.35351562e-01, 5.47851562e-01 /)
!     else if (icentres == 0) then
!     	Ncentre = 0
!     else
!     	call warning(" wrong value of icentres, setting to 0")
!     	Ncentre = 0
!     endif
!
!   return
!   end subroutine compute_anglequad_centres

!   Initialized only once at the begening of the main iteration loop !
!   type GridType
!    Nspace is the number of cells, n_cells meaning that all quantities are computed
!    for each cell starting from 1 to n_cells
!    integer :: Nspace, Npf, Nactiveatoms, Npassiveatoms, Natom, Nrays = 1
!    real(kind=dp) :: metallicity, totalAbund, avgWeight, wght_per_H
!
!    ! will be deprecated as I do not need optical_length_tot for stellar map. Only for checking
!    real(kind=dp) :: tau !a variable used to sum up contribution of opacities along a ray
!    !
!    real(kind=dp), allocatable, dimension(:) :: vR, v_z, vphi, BR, Bz, Bphi, vtheta, Btheta
!    real(kind=dp), allocatable, dimension(:,:) :: Vxyz, Bxyz !futur deprecation
!    type (Element), dimension(:), allocatable :: Elements
!    type (elemPointerArray), dimension(:), allocatable :: Elements
!    !type (AtomType), pointer, dimension(:) :: Atoms, ActiveAtoms, PassiveAtoms
!    type (AtomType), dimension(:), allocatable :: Atoms, ActiveAtoms, PassiveAtoms
!    type (atomPointerArray), dimension(:), allocatable :: Atoms, ActiveAtoms, PassiveAtoms
!    type (AtomType), pointer :: Hydrogen => NULL(), Helium => NULL()
!    real(kind=dp), dimension(:), allocatable :: nHtot, ne, Tpf, T, vturb
!    real(kind=dp), dimension(:), allocatable :: nHmin !Hminus populations
!    real(kind=dp) :: B_char = 0d0, v_char=0d0
!    logical :: include_xcoupling = .false., electron_scattering =.false.
!            B_char in Tesla and v_char in m/s, default 0T and 1km/s
!    logical :: Magnetized = .false., XRD=.false., calc_ne
!    dark zone are in lcompute_atomRT->icompute_atomRT == -1
!    integer, allocatable, dimension(:) :: icompute_atomRT!, ldark_zone!where line RT is taken into account on the grid
!    logical, allocatable, dimension(:) :: lcompute_atomRT!, ldark_zone!where line RT is taken into account on the grid
!   end type GridType


!   type (GridType), target :: atmos
